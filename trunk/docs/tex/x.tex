%%%% ZAWARTO¦Æ OBLIGATORYJNA - NALE¯Y DOSTOSOWAÆ %%%%%%%%%%%%%%%%%%%%%%%%

%% Tytu³ opracowania
%\title{Filtr protoko³u SMTP\\
%% Tu nale¿y podaæ nazwê przedmiotu, którego tyczy sprawozdanie.
%\begin{small}
%Praca in¿ynierska
%\end{small}}

%% Autorzy opracowania, po dwie linie z nazwiskiem i adresem e-mail na
%% osobê. Ka¿dy opis oddzielony separatorem 'and'.
%% \author{Tomasz Jordan Kruk\\ T.Kruk@ia.pw.edu.pl \and Jan Nieznany\\ jn@n.pl}
%%\author{Zbigniew Artemiuk\\ Z.Artemiuk@stud.elka.pw.edu.pl}

% To stworzy w³a¶ciwy format tytu³u oraz spis tre¶ci.
%%\maketitle

%%%%%%%%%%%%%%%%%%%% G£ÓWNA STRONA %%%%%%%%%%%%%%%%%%%%%%%%%% 

\thispagestyle{empty}
\noindent
\textbf{Politechnika Warszawska}\newline
\textbf{Wydzia³ Elektroniki i Technik Informacyjnych}\newline
\textbf{Instytut Informatyki}\newline
\newline
\hspace*{10cm} Rok akademicki 2007/2008\newline

\vspace{3cm}

% srodek tytula pracy i autor
\begin{center}
\begin{LARGE}\textbf{PRACA DYPLOMOWA - IN¯YNIERSKA}
\end{LARGE}
\vspace{2cm}
\begin{LARGE}
\textbf{Zbigniew Artemiuk}
\end{LARGE}

\vspace{2.5cm}
\begin{LARGE}
\textbf{Filtr protoko³u SMTP}
\end{LARGE}

\end{center}

\vspace{2.5cm}

% opiekun
\begin{large}
\hspace*{9.7cm}\textbf{Opiekun pracy:}\newline
\hspace*{9cm}\textbf{dr in¿. Grzegorz Blinowski}\newline
\end{large}

\vspace{2cm}

\noindent
\begin{small}
Ocena\hspace*{0.2cm}\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\newline
\hspace*{1.3cm}\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\newline
\hspace*{1.3cm}\textit{Podpis Przewodnicz±cego}\newline
\hspace*{1.3cm}\textit{Komisji Egzaminu Dyplomowego}
\end{small}

%%%%%%%%%%%%%%%%%%%%%%% ¯YCIORYS %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newpage

\begin{floatingtable}[l]{}
\includegraphics[scale=0.4]{ryj.png}
\end{floatingtable}

\begin{large}
\noindent
\hspace*{3cm} \newline
\hspace*{3cm}
\textbf{Specjalno¶æ: In¿ynieria Systemów Informatycznych}
\newline
\hspace*{3cm}
\textbf{Data urodzenia: 02.03.1984}
\newline
\hspace*{3cm}
\textbf{Data rozpoczêcia studiów: luty 2004}
\newline
\end{large}

\vspace{2.5cm}

\begin{center}
\begin{LARGE}¯yciorys
\end{LARGE}
\end{center}

Urodzi³em siê 2 marca 1984 roku w Przasnyszu. Edukacjê rozpocz±³em w 1991 roku
w Szkole Podstawowej w Krasnosielcu. W latach 1999-2003 uczêszcza³em do Liceum
Ogólnokszta³c±cego im. KEN w Przasnyszu do klasy o profilu
matematyczno-fizycznym. Po zdaniu matury i egzaminów wstêpnych rozpocz±³em
studia na wydziale Elektroniki i Technik Informacyjnych Politechniki
Warszawskiej. W roku 2006 wybra³em specjalno¶æ In¿ynieria Systemów
Informatycznych.

\vspace{6cm}

% podpis
\hspace*{11cm}Podpis\newline
\hspace*{10.5cm}\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\newline

\vspace{2cm}

\noindent
\textbf{EGZAMIN DYPLOMOWY}\newline
Z³o¿y³ egzamin dyplomowy w dniu
\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\newline
z wynikiem
\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots
\ldots\ldots\ldots\ldots\ldots\ldots\ldots\newline
Ogólny wynik studiów
\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots
\ldots\ldots\ldots .
\newline
Dodatkowe uwagi i wnioski Komisji 
\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots .
.\newline
\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots \ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots
\ldots .
\newline

%%%%%%%%%%%%%%%%%%%%%%  STRESZCZENIE %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage

\noindent
\begin{LARGE}\textbf{Streszczenie}
\end{LARGE}
\newline
\newline
W pracy przedstawiono szczegó³owy opis protoko³u SMTP (Simple Mail Transfer
Protocol) oraz opisano wspó³czesne narzêdzia do filtracji wiadomo¶ci
przesy³anych za jego pomoc±. Dok³adnie zanalizowane zosta³o nastêpuj±ce
oprogramowanie:

\begin{itemize}
  \item MIME Sweeper for SMTP firmy Clearswift
  \item eSafe Mail firmy Aladdin
  \item E-mail Filter firmy Surfcontrol 
\end{itemize}

Przedstawione zosta³y tak¿e modu³y do filtracji w protokole SMTP znajduj±ce siê
w oprogramowaniu antywirusowym firm Trend Micro (InterScan VirusWall i Inter
Scan Messaging Security Suite) oraz F-Secure (F-Secure Email Scanning).

Omówiona zosta³a koncepcja stworzenia autorskiego oprogramowania filtruj±cego z
podzia³em na modu³y: odbieraj±cy (serwer SMTP), kolejkuj±cy wiadomo¶ci,
parsuj±cy i analizuj±cy oraz wysy³aj±cy (klient SMTP). Po jego stworzeniu
zosta³y przeprowadzone testy wydajno¶ciowe, których wyniki zosta³y opracowane i
podsumowane.

%%%%%%%%%%%%%%%%%%%%%%  ABSTRACT %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\vspace{1cm}


\pagestyle{fancy}
\fancyhead[LE,RO]{}
\fancyhead[RE,LO]{\leftmark}
\noindent
\begin{LARGE}\textbf{Abstract}
\end{LARGE}
\newline
\begin{center}
\begin{LARGE}\textbf{SMTP protocol filter}
\end{LARGE}
\end{center}
This thesis describes in details the SMTP protocol (Simple Mail Transfer
Protocol) and available tools for filtering contents of messages sending
using it. Filtering software listed below was carefully analyzed:
\begin{itemize}
  \item MIME Sweeper for SMTP of company Clearswift
  \item eSafe Mail of company Aladdin
  \item E-mail Filter of company Surfcontrol
\end{itemize} 

Some modules for SMTP filtering included in antivirus software of companies
TrendMicro (InterScan VirusWall i Inter Scan Messaging Security Suite) and
F-Secure (F-Secure Email Scanning) was also mentioned.

After this, the creation of author's filtering software with modules:
receiving (SMTP server), queueing messages, parsing and analysing, and sending
(SMTP client) was discussed. Later, when software was implemented, some
performance tests were made and the collected data was elaborated and summed up.

%%%%%%%%%%%%%%%%%%%%%%% TRE¦Æ PRACY %%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage

\tableofcontents

%%%% PONI¯EJ ZAWARTO¦Æ DOWOLNA %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Dokument podzielony powinien byæ na elementy: section, subsection,
% ewentualnie subsubsection.

\newpage

\section{Wstêp}

\subsection{Systemy przetwarzania poczty elektronicznej}

Obecnie w Internecie istnieje szereg form komunikacji pomiêdzy u¿ytkownikami.
Dostêpna jest chocia¿by tekstowa komunikacja czasu rzeczywistego (czyli IM -
instant messaging i popularne chaty) oraz technologie umo¿liwiaj±ce przesy³anie
g³osu i wideo np. Skype. Mimo rozwoju coraz bardziej zaawansowanych narzêdzi i
protoko³ów przesy³anie wiadomo¶ci tekstowych ca³y czas znajduje
zastosowanie. U¿ywamy ich najcze¶ciej do kontaktów biznesowych, rodzinnych,
prywatnych, g³ównie w celach informacyjnych (czyli sam tekst), jak równie¿
do przekazywania niewielkich plików. Chyba ka¿dy internauta legitymuje siê
przynajmniej jedn± skrzynk± mailow±. Ka¿dy spotka³ siê tak¿e z niechcian±
poczt±, nazywan± bardzo ogólnym okre¶leniem Spam i stara³ siê ju¿ z nim walczyæ
przy pomocy ró¿nych narzêdzi. Umo¿liwiaj± one odseparowanie niechcianej poczty,
od tej która niesie interesuj±c± nas zawarto¶æ merytoryczn±. Separacja ta to
tzw. \textit{filtrowanie} ze wzglêdu na obiekt filtracji zwane filtracj± poczty.
Dokonanie filtracji wymaga jednak poznania dok³adnie w jaki sposób
transportowane s± nasze maile, a to wszystko zawarte jest w protokole Simple
Mail Transfer Protocol (w skrócie SMTP). 

SMTP jest prostym protoko³em tekstowym, dlatego te¿ jego implementacja nie
stanowi problemu. Jest to jedna z g³ównych cech, która przyczyni³a siê do jego
rozpowszechnienia. Wkrótce okaza³o siê, ¿e prostota protoko³u wprowadza jednak
pewne ograniczenia - warto tutaj wspomnieæ o braku autoryzacji czy szyfrowania.
Szybko jednak podjêto próbê ich usuniêcia na tyle udan±, ¿e mimo
ci±g³ych licznych niedoskona³o¶ci protokó³ SMTP jest ca³y czas szeroko u¿ywany.

%%\newpage

\subsection{Cel i zakres pracy}

Celem mojej pracy jest zaprojektowanie oprogramowania, które umo¿liwia³oby
filtracjê wiadomo¶ci w ramach protoko³u SMTP. Stworzony filtr by³by
konfigurowalny poprzez plik tekstowy, który zawiera³by regu³y wiadomo¶ci. Ka¿da
regu³a pozwala³aby na filtracjê wiadomo¶ci, które:

\begin{itemize}
  \item posiadaj± b±d¼ nie posiadaj± okre¶lonego nag³ówka (nag³ówków)
  \item posiadaj± b±d¼ nie posiadaj± okre¶lonej frazy w nag³ówku (nag³ówkach)
  \item posiadaj± b±d¼ nie posiadaj± okre¶lonej frazy w nag³ówkach za³±czników
  \item posiadaj± okre¶lony content-type
  \item posiadaj± za³±czniki o okre¶lonej wielko¶ci (je¿eli wiadomo¶æ nie
  zawiera za³±czników regu³a dotyczy wielko¶ci ca³ej wiadomo¶ci)
\end{itemize}
 
Filtr umo¿liwia³by okre¶lenie reakcji oprogramowania w przypadku wykrycia
wiadomo¶ci spe³niaj±cej kryteria danej regu³y. Mo¿liwe by³yby nastêpuj±ce akcje:

\begin{itemize}
  \item odrzucenie wiadomo¶ci
  \item przepuszczenie i zmodyfikowanie wiadomo¶ci o dodatkowy nag³ówek   
  \item przepuszczenie wiadomo¶ci bez jakichkolwiek zmian
\end{itemize}

\newpage

\section{Protokó³ SMTP}

\subsection{Historia powstania}

\subsubsection{ARPANET czyli pocz±tki Internetu}

Historia powstania protoko³u SMTP jest ¶ci¶le zwi±zana z pocz±tkami Internetu.
Internet za¶ i jego kreowanie zwi±zane jest bezpo¶rednio ze swoim przodkiem
czyli ARPANETEm.

ARPANET (Advanced Research Projects Agency Network) \cite{arpanet} zosta³
stworzony przez jedn± z agencji United States Department of Defense (departament
bezpieczeñstwa Stanów Zdjednoczonych) o nazwie ARPA (Advanced Research
Projects Agency). Nazwa agencji zosta³a pó¼niej przekszta³cona na DARPA
(Defence Advanced Research Projects Agency). Agencja ta mia³a zaj±c siê
rozwojem nowych technologii na potrzebê amerykañskiego wojska.

W miarê coraz wiêkszego wykorzystywania komputerów w ramach agencji
powsta³a idea stworzenia sieci pomiêdzy nimi, która to umo¿liwi³aby
komunikacje pomiêdzy ich u¿ytkownikami. Idea ta zosta³a po raz pierwszy
zaproponowana przez Josepha Carla Robnetta Licklidera \cite{jcr-licklider} z
firmy Bolt, Beranek \cite{leo-beranek} and Newman (obecnie BBN Technologies) w
sierpniu 1962 w serii notatek na temat koncepcji ''Miêdzygalaktycznej Sieci Komputerowej''. Zawiera³a ona prawie
wszystko czego mo¿emy do¶wiadczyæ w dzisiejszym Internecie.

W pa¼dzierniku 1963 roku Joseph Carl Robnett Licklider zosta³ mianowany szefem
programu Behavioral Sciences and Command and Control w ARPA. Przekona³ wtedy Ivana Sutherlanda i
Boba Taylora, ¿e jego wizja jest czym¶ naprawdê istotnym. Sam Licklider nie
doczeka³ jednak ¿adnych konkretnych prac w kierunku jej urzeczywistnienia, gdy¿
opu¶ci³ ARPA.

ARPA i Taylor ca³y czas byli zainteresowanie stworzeniem sieci komputerowej,
a¿eby zapewniæ naukowcom pracuj±cym w ramach ARPA w ró¿nych lokalizacjach,
dostêp do innych komputerów, które firma oferowa³a. Istotne by³o tak¿e, aby
nowe oprogramowanie i rezultaty badañ by³y jak najszybciej widoczne dla ka¿dego
u¿ytkownika sieci. Sam Taylor posiada³ 3 ró¿ne terminale, które dawa³y mu
pod³±czenie do 3 ró¿nych komputerów - jeden do SDC Q-32 w Santa Monica, drugi w
ramach projektu Project Genie do komputera na Uniwersytecie w Kalifornii
(Berkley) i ostatni do komputera z Multicsem w MIT (The Massachusetts Institute of Technology).

Taylor w taki sposób opowiada³ od pod³±czeniu do tych komputerów:
'' Dla ka¿dego z tych terminali mia³em inny zestaw poleceñ. Dlatego te¿ kiedy
rozmawia³em z kim¶ z Santa Monica, a po¼niej chcia³em ten sam temat
skonsultowaæ z kim¶ z Berkley albo MIT, musia³em przesi±¶æ siê do innego
terminala. Oczywistym wtedy wyda³o mi siê, ¿e musi byæ 1 terminal, który
obs³u¿y te 3 po³±czenia. Idea ta to w³a¶nie ARPANET''

Do po³owy 1968 roku kompletny plan sieci zosta³ stworzony i po zatwierdzeniu
przez ARPA, zapytanie ofertowe RFQ (Request For Quotation) zosta³o pos³ane do
140 potencjalnych wykonawców. Wiêkszo¶æ potraktowa³a propozycjê jako dziwaczn±.
Tylko 12 firm z³o¿y³o oferty z czego 4 zosta³y uznane za najwa¿niejsze. Do
koñca roku wy³oniono 2 firmy, z których ostatecznie 7 kwietnia 1969 roku
zosta³a wybrana firma BBN.

Propozycja BBN by³a najbli¿sza planom ARPA. Pomys³em ich by³o stworzenie sieci
z ma³y komputerów zwanych Interface Message Processors (bardziej znanych jako
IMPs), które to obecnie nazywamy routerami. IMPsy z ka¿dej strony zapewnia³y
funkcje przechowywania i przekazywania pakietów, a po³±czone by³y miêdzy sob±
przy u¿yciu modemów podpiêtych do ³±czy dzier¿awionych (o przepustowo¶ci 50
kbit/sekundê). Komputery pod³±czone by³y do IMP-ów poprzez specjalny bitowy
interfejs. W ten sposób stawa³y siê one czê¶ci± sieci ARPANET.

Do zbudowania pierwszej generacji IMP-ów BBN wykorzysta³a komputer Honeywell
DDP-516. Zosta³ on wyposa¿ony w 24kB pamiêci rdzeniowej (z mo¿liwo¶ci±
rozszerzenia) oraz 16 kana³ów Direct Multiplex Control (DMC) do bezpo¶redniogo
dostêpu do tej pamiêci. Poprzez DMC pod³±czane by³y komputery u¿ytkowników
(hosty) i modemy. Dodatkowo 516 otrzyma³ zestaw 24 lamp, które pokazywa³y
status kana³ów komunikacyjnych IMPa. Do ka¿dego IMPa mo¿na by³o pod³±czyæ do
czterech hostów i móg³ siê on komunikowaæ z 6 zdalnymi IMPami poprzez
wspó³dzielone ³±cza.

Zespó³ z BBN (pocz±tkowo 7 osób) szybko stworzy³ pierwsze dzia³aj±ce jednostki
(IMPy). Ca³y system, który zawiera³ zarówno sprzêt jak i pierwsze
oprogramowania zarz±dzaj±ce pakietami, zosta³ zaprojektowany i zainstalowany w
ci±gu 9 miesiêcy.

Pocz±tkowo ARPANET sk³ada³ siê z 4 IMPów. Zosta³y one zainstalowane w:

\begin{itemize}
  \item UCLA (University of California, Los Angeles), gdzie Leonard Kleinrock
  za³o¿y³ centrum pomiaru sieci (Network Measurment Center)
  \item The Stanford Research Institute's Augmentation Research Center, gdzie
  Douglas Engelbert stworzy³ system NLS, który miêdzy innymi wprowadzi³ pojêcie
  hypertextu
  \item UC Santa Barbara
  \item The University of Utah's Graphics Department, gdzie przebywa³ ówcze¶nie
  Ivan Sutherland
\end{itemize}

\subsubsection{Piersze wiadomo¶ci w ARPANETcie}

Pierwsza komunikacja host-host w sieci ARPANET wykorzystywa³a protokó³ 1822,
który definiowa³ sposób w jakis host przesy³a³ wiadomo¶æ do IMPa. Format
wiadomo¶ci by³ tak zaprojektowany, ¿eby bez problemu móg³ pracowaæ z szerokim
zakresem architektur. Zasadniczo wiadomo¶æ sk³ada³a siê z:

\begin{itemize}
  \item typu wiadomo¶ci
  \item adresu hosta
  \item pola z danymi
\end{itemize}

W celu wys³ania wiadomo¶ci do innego hosta, host wysy³aj±cy powinien sformatowaæ
wiadomo¶æ tak, aby ta zawiera³a adres hosta docelowego oraz dane, a nastêpnie
dokonaæ transmisji wiadomo¶ci przez interfejs sprzêtowy 1822. IMP dostrze¿e
dostarczenie wiadomo¶ci albo poprzez dostarczenie jej bezpo¶rednio do hosta
docelowego albo poprzez przekazanie jej do kolejnego IMPa. Kiedy wiadomo¶æ
zosta³a odebrana przez docelowego hosta, IMP do którego host by³ pod³±czony
wysy³a potwierdzenie odbioru (zwane Ready for Next Message or RFNM) do hosta
wysy³aj±cego.

W przeciwieñstwie do obecnych protoko³ów datagramowych w Interecie (takich jak
no IP), ARPANETowy porotokó³ 1822 zapewnia³ niezawodno¶æ w taki sposób, ¿e
informowa³ o niedostarczonej wiadomo¶ci. Niemniej protokó³ 1822 nie by³
odpowiedni do ¿onglowania wieloma po³±czeniami w ró¿nych aplikacjach
uruchomionych na pojedynczym ho¶cie. Problem ten zosta³ rozwi±zany dziêki
wprowadzeniu na hostach Network Control Program (NCP) \cite{ncp}, dziêki któremu
mo¿liwe by³o niezawodne, z kontro³± przep³ywu, dwukierunkowe po³±czenia pomiêdzy
ró¿nymi procesami na ró¿nych hostach. NCP implementowa³ kolejn± warstwê
znajduj±c± siê na górze stosu protoko³ów. Dziêki niemu aplikacje, które mia³y
mieæ ju¿ jak±¶ konkretn± funkcjonalno¶æ, mog³y wykorzystywaæ spójny interfejs i
korzystaæ swobodnie z dobrodziejstw ARPANETu czyli wykonywaæ po³±czenia do
innych aplikacji przez sieæ. 

\subsubsection{SNDMSG i READMAIL}

Na pocz±tku roku 1970, powsta³ program (a w zasadzie 2
oddzielne) do wysy³ania i odbierania wiadomo¶ci. Zaimplementowa³ go Ray
Tomlinson. Programy te to SNDMSG i READMAIL. Pierwsza wersja tych
programów, by³a kolejn± implementacj±, która umo¿liwia³a wymiane
informacji miêdzy u¿ytkownikami jednej maszyny (jednego hosta), a konkretnie
komponowanie, adresowanie i wysy³anie wiadomo¶ci do skrzynek u¿ytkowników. Ju¿
jednak w 1971 Tomlinson stworzy³ pierwsz± aplikacjê ARPANETow± (w ramach prac
nad systemem TENEX), która umo¿liwia³a wysy³anie wiadomo¶ci do dowolnych
hostów. Tomlinson dokona³ usprawnieñ w programie SNDMSG przy okazji pracy nad
projektem CPYNET, którego celem by³o stworzenie protoko³u do wymiany plików
miêdzy komputerami w sieci.

Skrzynkê emailow± by³ wówczas by³ zwyk³y plik o okre¶lonej nazwie. Specjaln±
w³a¶ciwo¶ci± jego by³o to, ¿e mia³ ochronê tak±, ¿e umo¿liwia³ innym
u¿ytkownikom dopisywanie do pliku. Mogli oni wiêc pozostawiaæ kolejne
wiadomo¶ci ale nie mogli ich czytaæ ani nadpisywaæ wcze¶niejszych (jedynie
w³a¶ciciel móg³ to robiæ). Tomilson zauwa¿y³, ¿e CPYNET mo¿e dopisywaæ zawarto¶æ
do pliku skrzynki mailowej, na takiej zasadzie jak SNDMSG (SNDMSG umia³
zapisywaæ wtedy tylko na lokalnej maszynie). Dlatego te¿ SNDMSG móg³ po prostu
skorzystaæ z kodu CPYNET i bezpo¶rednio dostarczaæ wiadomo¶ci poprzez
po³±czenie sieciowe do zdalnych skrzynek poprzez dopisywanie kolejnych
informacji do plików na innych hostach.

Brakuj±c± funkcjonalno¶ci± oprogramowania by³a mo¿liwo¶æ dopisywania do plików
przy pomocy CPYNET. Dotychczas móg³ on tylko wysy³aæ i odbieraæ pliki. Dodanie tej funkcjonalno¶ci
nie by³o czym¶ wielkim dla twórców protoko³u i funkcjonalno¶æ ta wkrótce
zainstnia³a.

Nastêpnie Tomilson w³±czy³ kod CPYNET do SNDMSG. Pozosta³o jedynie rozró¿nienie
maili lokalnych od maili zdalnych. Dlatego te¿ Tomilson zdecydowa³ siê, ¿e
maile zdalne bêd± rozpoznawane po tym, ¿e po loginie (czyli wyznaczniku
u¿ytkownika do którego wiadomo¶æ jest s³ana) nast±pi specjalny znaczek @ (ang.
at, a polska znana wszystkim ma³pa) , a tu¿ po nim nazwa hosta czyli zdalnego
komputera, na którym skrzynkê ma dany loginem u¿ytkownik. Tomilson tak
powiedzia³ o wyborze ma³py jako znaczka rozdzielaj±cego login od hosta: ''I am
frequently asked why I chose the at sign, but  the at sign just makes sense''
(w wolnym t³umaczeniu: Jestem czêsto pytany czemu wybra³em znaczek ma³py, ale
on po prostu mia³ sens).

Pierwsza wiadomo¶æ zosta³a przes³ana pomiêdzy maszynami, które fizycznie
znajdowa³y siê w jednym pomieszczeniu. Jedyne po³±czenie jakie by³o miêdzy
maszynami (oprócz pod³ogi) by³o za po¶rednictwem sieci ARPANET. Tomilson
przes³a³ wiele wiadomo¶ci do samego siebie z jednej maszyny na drug±. Pierwsze
tre¶ci wiadomo¶ci od razu zosta³y zapomniane. Najprawdopodobniejsza ich tre¶æ
mia³a postaæ np. QWERTYUIOP. Kiedy Tomilson by³ zadowolony z programu wys³a³ do
swoich kolegów z zespo³u wiadomo¶æ z instrukcj± jak s³aæ wiadomo¶ci przez sieæ.
W ten sposób pierwsza wys³ana wiadomo¶æ og³osi³a swoje istnienie.

Te pierwsze wiadomo¶ci zosta³y wys³ane pod koniec 1971 roku. Nastêpne wydanie
TENEXa, które ukaza³o siê w 1972 roku, zawiera³o SNDMSG, z mo¿liwo¶ci±
wysy³ania maili przy u¿yciu sieci ARPANET. Protokó³ CPYNET wkrótce zosta³
zast±piony prawdziwym protoko³em do transferu plików i posiada³ specyficzne
dodatki do obs³ugi maila. 

\subsubsection{MAIL i MLFL w protokole FTP}
Protoko³em, o którym wcze¶niej by³a mowa by³ protokó³ FTP, którego specyfikacja
wstêpna zosta³a zawarta w RFC (Request For Comment) 114. Kolejne ulepszenia
protoko³u zosta³y dokonana w roku 1972 i wtedy te¿ wesz³y do niego nowe polecenia pozwalaj±ce
korzystaæ ze skrzynek emailowych. Poleceniami tymi by³y:

\begin{itemize}
  \item MAIL - polecenie to pozwala³o u¿ytkownikowi przy pomocy telnetu wys³aæ
  maila. Pomocne to by³o gdy u¿ytkownik ten nie korzysta³ ze swojego hosta i
  logowa³ sie do niego poprzez protokól telnet
  \item MLFL - polecenie to pozwala³o na normalne skonstruowanie maila i
  przes³anie odpowiednio wskazanego pliku jako jego tre¶ci
\end{itemize}

Protokó³ ten sta³ siê a¿ do roku 1980 standardem przesy³ania emaili w
ARPANETcie. Wtedy to zosta³ wypart przez protokó³ SMTP, który z pewnymi
usprawnieniami funkcjonuje a¿ do dzi¶.

\subsubsection{Rozwój innych programów do obs³ugi poczty}

Zanim jednak powsta³ protokó³ SMTP ca³y czas pracowano nad rozwojem ówczesnych
programów chocia¿by do odbioru maili. W ten sposób na pro¶be Steve'a Lukasika
Lawrence Roberts, ówczesny dyrektor IPTO, stworzy³ program RD, który sk³ada³
siê z makr w edytorze TECO (Text Editor and COrrector).

Program RD umo¿liwia³:

\begin{itemize}
  \item sortowanie emaili po temacie i dacie
  \item czytanie, zapisywanie i czytanie wiadomo¶ci w dowolnym porz±dku
\end{itemize}

RD nie powsta³ wiêc jako wynik badañ, ale z czysto praktycznej potrzeby
swobodnego zarz±dzania emailami.

Wkrótce powsta³y te¿ kolejne ulepszenia programu RD oraz SENDMSG, takie jak NRD
czy WRD, które to wprowadza³y kolejne ulepszenia istniej±cych ju¿
implementacji. 

Warte wspomnienia jest tak¿e powstanie programu MSG, który umo¿liwia³ miêdzy
innymi przekazywanie maili (ang. forwarding), konfigurowalny interfejs, czy te¿
polecenie Odpowiedz (ang. Answer), które automatycznie uzupe³nia³o adres
odbiorcy. MSG mo¿na by³o nazwaæ pierwszym nowoczesnym programem pocztowym. 

W 1977 roku ró¿ne formaty wiadomo¶ci zosta³y zebrane w jedn± spójn±
specyfikacjê co doprowadzi³o do stworzenia RFC 733.  Specyfikacja ta po³±czy³a
wcze¶niej istniej±ce dokumentacjê z odrobion± innowacji i by³a jednocze¶nie
pierwszym RFC, które deklarowa³o standard Internetowy (ówcze¶nie ARPANETowy).

\subsection{Szczegó³y protoko³u}

W 1982 roku powsta³o g³ówne RFC opisuj±ce protokó³ SMTP - RFC 821
\cite{rfc-821}. W 2001 roku zosta³o ono rozbudowane i powsta³ dokument, który jest obowi±zuj±c± obecnie
specyfikacj± protoko³u. Informacje te zawarte zosta³y w RFC o numerze 2821.

\subsubsection{Model protoko³u, podstawy}

\begin{center}
\includegraphics[scale=0.4]{klient_serwer_smtp.png}
\begin{small}
\newline
\textit{Schemat komunikacji w protokole SMTP}
\end{small}
\end{center}

Komunikacja w protokole SMTP oparta jest na nastêpuj±cym modelu: kiedy klient
SMTP posiada wiadomo¶æ, któr± chce przetransmitowaæ, ustanawia dwukierunkowy
kana³ transmisyjny z serwerem SMTP. Nastêpnie stara siê on przekazaæ wiadomo¶æ
do serwera. W przypadku niepowodzenia operacji zg³asza b³±d.

Adres serwera SMTP klient determinuje poprzez zamianê domeny podanej w
adresie na po¶redni host (Mail eXchanger) lub ostateczny host docelowy.

Serwer SMTP mo¿e byæ ostatecznym celem albo te¿ po¶rednim ''przeka¼nikiem''
(po odebraniu wiadomo¶ci to on mo¿e przej±æ rolê klienta SMTP) albo ''bram±''
(mo¿e transportowaæ wiadomo¶æ dalej u¿ywaj±c innego protoko³u ni¿ SMTP).
Polecenia protoko³u SMTP generowane s± przez klienta i przesy³ane do serwera.
Odpowiedzi wysy³ane s± jak reakcja na ¿±dania klienta.

Innymi s³owy transmisja wiadomo¶ci mo¿e sk³adaæ siê z pojedynczego
po³±czenia pomiêdzy pierwotnym adresatem, a ostatecznym klientem albo mo¿e
byæ dokonana za pomoc± kilku po¶rednich po³±czeñ. W obu przypadkach zachowana
jest odpowiedzialno¶æ za wiadomo¶æ - protokó³ wymaga od serwera wziêcia
odpowiedzialno¶ci za dostarczenie wiadomo¶ci albo w przypadku nieprawid³owo¶ci
za zg³oszenie b³êdu.

Kiedy kana³ transmisyjny zostanie zestawiony klient SMTP inicjuje transakcjê
maila. Sk³ada siê ona z serii poleceñ, które maj± na celu wyspecyfikowanie
nadaj±cego i celu wiadomo¶ci, a nastêpnie przes³ania jej zawarto¶ci (oczywi¶cie
z nag³ówkami, które wchodz± w jej sk³ad). Kiedy ta sama wiadomo¶æ jest
adresowana do wielu odbiorców, protokó³ przesy³a jedn± kopiê wiadomo¶æ dla
wszystkich odbiorców w obrêbie jednego hosta.

Serwer reagujê na ka¿d± komendê odpowiedziami. Wskazuj± one akceptacjê komendy
(tej przes³anej od klienta) i oczekiwanie na kolejne, b±d¼ te¿ wyst±pienie
tymczasowych albo sta³ych b³êdów.

Kiedy mail zostanie przetransmitowany, klient mo¿e zamkn±æ po³±czenie albo te¿
zainicjowaæ kolejn± transakcjê innego maila. Dodatkowo klienty SMTP mog± u¿ywaæ
po³±czenia z serwerem w celach np. weryfikacji adresu email b±d¼ te¿ uzyskanie
adresów subskrybentów listy dyskusyjnej.

Jak zosta³o wcze¶niej zasugerowane transmisja w protokole mo¿e odbywaæ siê
bezpo¶rednio pomiêdzy hostem wysy³aj±cyn wiadomo¶æ, a hostem docelowym, kiedy s±
one po³±czone tym samym serwisem transportowym. Kiedy tak nie jest, transmisja
odbywa siê poprzez hosty po¶rednie. Hosty te wybierane s± poprzez
mechanizm serwera domen (DNS) zwany Mail eXchanger.

\subsubsection{Model rozszerzeñ}

W wyniku prac, które rozpoczê³y siê oko³o dekadê po wydaniu pierwszego RFC
dotycz±cego protoko³u SMTP (czyli RFC 822), protokó³ zosta³ rozszerzony i
pojawi³y siê w nim nowe funckjonalno¶ci. Standardowy model zosta³ wiêc
zmodyfikowany o dodatkowe serwisy. Pozwalaj± one na ustalenie pomiêdzy klientem,
a serwerem us³ug dodatkowych jakie s± oni w stanie obs³u¿yæ (poza podstawowymi
wymaganiami SMTP). Mechanizm rozszerzeñ SMTP okre¶la ¶rodki, za pomoc± których
klient i serwer mog± dokonaæ wzajemnego ropoznania, a serwer mo¿e tak¿e
poinformowaæ klienta o rozszerzeniach, które on wspiera.

Wspó³czesna implementacja serwera SMTP musi obs³ugiwaæ podstawowe mechanizmy
rozszerzeñ. Przyk³adowo serwer musi zawieraæ obs³ugê komendy EHLO, je¶li nawet
nie implementuje ¿adnych rozszerzeñ protoko³u, które definiuje siê w ramach
odpowiedzi na to polecenie. Klient natomiast powinien sk³aniaæ siê ku u¿ywaniu
nowej komendy powitalnej EHLO zamiast wychodz±cej z u¿ycia HELO.

SMTP jest szeroko u¿ywany i pojawi³o siê wiele bardzo dobrych implementacji
protoko³u wyposa¿onych w liczne rozszerzenia. Spo³eczno¶æ w Internecie jednak
uwa¿a, ¿e niektóre z serwisów s± bardzo wa¿ne, mimo tego, ¿e nie powsta³y gdy
protokó³ by³ po raz pierwszy projektowany. Je¶li serwisy te maj± zostaæ dodane
to w zachowaniem zgodno¶ci wstecz. 

Obecnie szkielet rozszerzeñ sk³ada siê z:

\begin{itemize}
  \item Polecenia EHLO, które powinno byæ u¿ywane zamiast wcze¶niejszego HELO
  \item Rejestru rozszerzeñ SMTP jak np. autoryzacji czy szyfrowania
  \item Dodatkowych parametrów do poleceñ SMTP MAIL i RCPT
\end{itemize}

Si³± SMTP jest jego prostota. Do¶wiadczenia z protoko³ami pokazuj±, ¿e te z
kilkoma mo¿liwo¶ciami staj± siê powszechnie u¿ywanymi, podczas gdy te z
wieloma mo¿liwo¶ciami przestaj± byæ czytelne. 

\subsubsection{Sesja protoko³u}

Sesja jest inicjowana kiedy klient otwiera po³±czenie do serwera i serwer
odpowie wiadomo¶ci± zapraszaj±c±.

SMTP serwer po pod³±czeniu siê klienta mo¿e po kodzie powitalnym 220
poinformowaæ klienta o swoim oprogramowaniu i jego wersji.
\combox{220 mail.foo.com SuperSMTP v 6.1.2 Service ready}
Protokó³ SMTP pozwala serwerowi na odmówienie transakcji podczas gdy formalnie
umo¿liwia na pod³±czenie siê do serwera SMTP. Wtedy zamiast kodu 220 serwer
odpowiada kodem 554.
\combox{554 Transaction failed (Or, in the case of a
connection-opening response, ''No SMTP service here'')}
Serwer w tym przypadku musi czekaæ zanim zakoñczeny po³±czenie na
komende QUIT ze strony klienta. W trakcie tego oczekiwania wszystkie inne
komendy zostan± potraktowane odpowiedzi± 503.
\combox{503 Bad sequence of commands}
Kiedy serwer przywita siê z klientem i klient otrzyma wiadomo¶æ powitaln±,
standardowo wysy³a on polecenie EHLO do serwera i w wiadomo¶ci tej przedstawia
siê.
\combox{EHLO bar.com}
U¿ycie komendy EHLO wskazuje, ¿e klient jest w stanie obs³u¿yæ
rozszerzenia protoko³u i prosi serwer o ich listê. Starsze systemy SMTP, które
nie obs³uguj± rozszerzeñ protoko³u czy te¿ starsze klienty SMTP, które nie
wymagaj± tych¿e rozszerzeñ, mog± u¿ywaæ komendy HELO.
\combox{HELO bar.com}
Serwer w odpowiedzi na HELO nie powinien zwróciæ listy rozszerzeñ. Je¿eli
serwer zwróci na EHLO 
\combox{500 Command not recognized}
, wtedy klient powinien byæ w stanie przes³aæ komende HELO.

Nastêpnie dochodzi do transakcji maila. Rozpoczyna siê ona poleceniem MAIL,
która identyfikuje nadawcê. Po niej nastêpuje seria poleceñ RCPT, które
przekazuj± informacjê o odbiorcy, a na sam koniec DATA czyli cia³o maila, które
koñczone jest wyznacznikiem koæa maila. Znacznik ten potwierdza transakcjê. 

Pierwszym krokiem w procedurze transakcji jest komenda MAIL. Ogólna jej
sk³adnia wygl±da nastêpuj±co:
\combox{MAIL FROM:<reverse-path> [SP <mail-parameters> ] <CRLF>}
przyk³adowo
\combox{MAIL FROM:<bob@example.org>}
Poleceni to mówi odbiorcy SMTP (serwerowi), ¿e rozpoczynana jest nowa
transakcja. Dlatego powinien on zresetowaæ (chyba na danym po³±czeniu?)
wszystkie poprzednie stany tabel i buforów, w³±czaj±c w to odbiorców i dane
maila. Argument <reverse-path> zawiera adres ¼ród³owej skrzynki mailowej, która
mo¿e pos³u¿yæ w celu informacji o ewentualnych b³êdach (bêdzie dalej opisane
[4.2]). Je¶li polecenie zostanie zaakcpetowane serwer odpowiada poleceniem 250
OK. 
\combox{250 OK}
Je¶li przes³any adres nie zosta³ zaakceptowany serwer musi odpowiedzieæ czy
b³±d jest sta³y (zawsze bêdzie siê pojawia³ przy tym adresie) czy tymczasowy
(klient bêdzie móg³ wykonaæ ponown± próbê, która mo¿e zakoñczyæ siê sukcesem).
Czasami jednak serwer mo¿e dokonaæ akceptacji adresu przekazanego w poleceniu
MAIL i dopiero po analizie adresów przes³anych w poleceniu RCPT, mo¿e zg³osiæ
b³±d. Normalnie jednak gdy b³±d jest sta³y odpowied¼ serwera to
\combox{550 mailbox not found}
albo tymczasowy
\combox{503 temporary error}
Historycznie <reverse-path> mo¿e nie tylko zawieraæ adres skrzynki, jednak¿e
obecne oprogramowanie nie powinno u¿ywaæ routingu ¼ród³a.

Parametry opcjonalne w poleceniu MAIL <mail-parameters> s³u¿± do negocjacji
rozszerzeñ protoko³u.

Nastêpnym krokiem w transakcji jest polecenie RCPT. Jego sk³adnia to
\combox{RCPT TO:<forward-path> [ SP <rcpt-parameters> ] <CRLF>}
Argumentem tego polecenia jest adres (z regu³y adres skrzynki oraz domena)
identyfikuj±cy odbiorcê. Je¶li zostanie on zaakceptowany przez serwer odpowiada
on komunikatem 250 OK i zapisuje sobie argument forward-path. Je¿eli adres nie
jest prawid³owy serwer odpowiada kodem 550. Z regu³y odpowied¼ ma nastêpuj±c±
postaæ
\combox{550 No such user}
Procedura ta mo¿e byæ powtórzona parokrotnie przyk³adowo
\combox{C: MAIL FROM:<bob@example.org>\newline 
S: 250 OK\newline 
C: RCPT TO:<alice@example.com>\newline 
S: 250 OK
}
W tym przypadku kopia maila trafi do 2 u¿ytkowników korzystaj±cych z tego
samego serwera pocztowego (tej samej domeny). Jak ju¿ wcze¶niej by³o wspomniane
dzieje siê to przy nawi±zaniu 1 po³±czenia.

Argument <forward-path> mo¿e zawieraæ wiêcej ni¿ jeden adres skrzynki
odbiorczej. Ze wzglêdów historycznych mog± siê tutaj pojawiæ równie¿ lista
hostów ¼ród³owych i skrzynka odbiorcza, jednak klienty SMTP (jak ju¿ wcze¶niej
by³o wspomniane) nie powinny korzystaæ z tej mo¿liwo¶ci. Serwer jednak musi byæ
przygotowany na tak± ewentualno¶æ, ale powinien zignorowaæ t± listê.

Dodatkowe parametry (<rcpt-parameters>) bêd± omówione pó¼niej.

Trzecim krokiem w trakcie transakcji jest polecenie DATA. Sk³adnia jego jest
prosta po prostu
\combox{DATA <CRLF>}
Je¿eli polecenie zosta³o zaakceptowane serwer SMTP zwraca status 354 i prosi
klienta aby odpowiedzia³ jak najszybciej tre¶ci± maila, koñcz±c transmisjê
znacznikiem koñca maila. Przyk³adowo 
\combox{354 End data with <CR><LF>.<CR><LF>}
Serwer po otrzymaniu znaku koñca wiadomo¶ci i zapisaniu maila odpowiada
standardowo klientowi 250 OK. Koniec wiadomo¶ci klient zaznacza poprzez
przes³anie linii zawieraj±cej jeden znak ''.'' (kropkê). Wystêpuj± dodatkowo
odpowiednia procedura zabezpieczaj±ca przed nieporozumieniem zwi±zanym z
ewentualnym przes³aniem lini zawieraj±cej pojedyncz± kropkê z tre¶ci wiadomo¶ci,
która nie oznacza koñca maila.

Polecenie DATA mo¿e nie udaæ siê tylko w 2 przypadkach:

\begin{itemize}
  \item Je¿eli nie by³o polecenia MAIL albo RCPT albo oba zosta³y odrzucone
  wtedy serwer na DATA mo¿ê odpowiedzieæ
  \comboxinitemize{503 Command out of sequence} 
  albo te¿ 
  \comboxinitemize{554 No valid recipients} 
  Je¿eli która¶ z tych odpowiedzi (albo inna z serii 5yz czyli mówi±cych
  o b³êdzie) zostanie odebrana przez klienta, nie powinien on przesy³aæ tre¶ci
  wiadomo¶ci. Powinien on robiæ to tylko w przypadku odpowiedzi 354.
  \item Je¿eli polecenie DATA zosta³o zaakceptowane odpowiedzi± 354, mo¿e doj¶æ
  do nieudanego przes³ania maila tylko gdy transakcja jest niekompletna (brak
  zdefiniowancyh odbiorców), albo niespodziewanie odbiorca przestanie byæ
  dostêpny lub te¿ serwer z innych powodów (np. polityka ochrony) serwer
  postanowi odrzuciæ wiadomo¶æ.
\end{itemize}

W praktyce nieliczne serwery dokonuj± weryfikacji odbiorcy przed
otrzymaniem ca³ej wiadomo¶ci. Nie jest to dobre zachowanie, gdy¿ je¿eli po
zaakceptowaniu adresów odbiorców nagle po poleceniu DATA serwer odpowie ''550
mailbox not found'' to klient nie jest w stanie okre¶liæ, który adresat jest
nieprawid³owy.

Serwer nie powinien na tym etapie odrzucaæ wiadomo¶ci na podstawie nag³ówków
przekazanych w tre¶ci wiadomo¶ci (po poleceniu DATA).

Oto ca³a przyk³adowa, prawid³owa sesja protoko³u SMTP:
\comboxnonl{Klient otwiera po³±czenie do serwera.\newline
S: 220 smtp.example.com ESMTP Postfix\newline
C: HELO relay.example.org\newline
S: 250 Hello relay.example.org, I am glad to meet you\newline
C: MAIL FROM:<bob@example.org>\newline
S: 250 Ok\newline
C: RCPT TO:<alice@example.com>\newline
S: 250 Ok\newline
C: RCPT TO:<theboss@example.com>\newline
S: 250 Ok\newline
C: DATA\newline
S: 354 End data with <CR><LF>.<CR><LF>\newline
C: From: "Bob Example" <bob@example.org>\newline
C: To: Alice Example <alice@example.com>\newline
C: Cc: theboss@example.com\newline
C: Date: Tue, 15 Jan 2008 16:02:43 -0500\newline
C: Subject: Test message\newline
C:\newline
C: Hello Alice.\newline
C: This is a test message with 5 headers and 4 lines in the body.\newline
C: Your friend,\newline
C: Bob\newline
C: .\newline
S: 250 Ok: queued as 12345\newline
C: QUIT\newline
S: 221 Bye\newline
Serwer zamyka po³±czenie.
}

\subsubsection{Polecenia do debugowania adresów}

SMTP dostarcza poleceñ za pomoc± których mo¿na dokonaæ weryfikacji nazwy
u¿ytkownika albo uzyskaæ zawarto¶æ listy mailingowej. Dokonuje siê tego przy
pomocy poleceñ VRFY i EXPN, których wspacie powinno byæ zaimplementowane w
serwerze SMTP. Warto nadmieniæ, ¿e dostêp do tych poleceñ jest na
serwerach publicznych \textbf{wy³±czony}, ze wzglêdu na ochronê prywatno¶ci
danych. Dane mog³yby byæ wykorzystane chocia¿by przez spamerów w celach
ustalenia potencjalnych ofiar.

Argumentem polecenia VRFY jest po prostu napisa, który sk³ada siê z nazwy
u¿ytkownika lub te¿ dodatkowo domeny. Je¿eli w wyniku polecenia serwer zwróci
odpowied¼ 250, mo¿e zawrzeæ w nim pe³n± nazwê u¿ytkownika i musi zawrzeæ
skrzynkê u¿ytkownika. Musi wiêc byæ to jedno z poni¿szych:

\begin{itemize}
  \item User Name <local-part@domain>
  \item local-part@domain 
\end{itemize}

Kiedy argument podany w komendzie VRFY sk³ada siê z kilku adresów, serwer mo¿e
zg³osiæ niejasno¶æ w adresie jakos ca³o¶ci albo wskazaæ na jeden z podanych w
argumencie adresów. Dla przyk³adu odpowiedzi serwera na komendê VRFY mog±
przyj±æ postaæ:

\begin{itemize}
  \item \comboxinitemizenonl{530 User ambiguous}
  \item \comboxinitemizenonl{553- Ambiguous;\newline 
  	Possibilities are\newline
  	553-Joe Smith <jsmith@foo.com>\newline
  	553-Harry Smith <hsmith@foo.com>\newline
  	553 Melvin Smith <dweep@foo.com>
  	}
  \item \comboxinitemizenonl{553-Ambiguous;\newline
  	Possibilities\newline
  	553-<jsmith@foo.com>\newline
  	553- <hsmith@foo.com>\newline
  	553 <dweep@foo.com>}
\end{itemize}

W normalnych okoliczno¶ciach klient, który otrzyma odpowied¼ 553 oczekuje, ¿e
zwrócone wyniki bêdzie móg³ zaprezentowaæ u¿ytkownikowi czyli bêd± one dla
niego zrozumia³e. W powy¿szym przyk³adzie mo¿liwe jest to tylko w przypadku 2
i 3 (pierwszy nic konkretnego poza informacj± o b³êdzie nie mówi).

Drugie polecenie EXPN przyjmuje jako argument napis (string), który
identyfikuje listê maili, a odpowied¼ poprawna serwera mo¿e zawieraæ pe³ne
nazwy u¿ytkowników i musi podawaæ ich skrzynki mailowe.

Na niektórych hostach wystêpuje problem z rozró¿nieniem pomiêdzy list± mailow±,
a aliasem do pojedynczej skrzynki mailowej, poniewa¿ struktura danych
przechowuj±ca informacje na ten temat mo¿e przyjmowaæ oba typy wpisów i jest na
przyk³ad mo¿liwe, ¿e lista mailowa zawiera tylko jeden adres skrzynki. Próba
weryfikacji takiego adresu poprzez VRFY, mo¿e udaæ siê jedynie gdy serwer SMTP
umie obs³u¿yæ wiadomo¶æ wys³an± na ten adres poprzez dostarczenie jej do ka¿dej
skrzynki z listy. Je¿eli nie jest on w stanie tego zrobiæ zwróci jeden z
nastêpuj±cych b³êdów
\combox{550 That is a mailing list, not a user}
lub te¿ 
\combox{252 Unable to verify members of mailing list}
W przypadku wielolinijkowej odpowiedzi serwera na polecenie EXPN dok³adnie
jedna skrzynka mailowa powinna znale¼æ siê w lini. 

Przyk³adowe polecenie EXPN i odpowiedzi na nie:
\combox{C: EXPN Example-People\newline
S: 250-Jon Postel <Postel@isi.edu>\newline
S: 250-Fred Fonebone <Fonebone@physics.foo-u.edu>\newline
S: 250 Sam Q. Smith <SQSmith@specific.generic.com>} 
\combox{C: EXPN Executive-Washroom-List\newline
S: 550 Access Denied to You.}

Serwerowi nie wolno w odpowiedzi na VRFY lub EXPN zwracaæ odpowiedzi 250 dopóki
nie dokona faktycznej weryfikacji adresu. S± jednak przypadki, w których adres
wydaje siê byæ prawid³owy, ale w czasie rzeczywistym nie mo¿e on zostaæ
zweryfikowany. Jest tak na przyk³ad gdy serwer s³u¿y jako po¶redni dla innego
serwera albo domeny. W takim przypadku serwer dokonuje jakby ''pozornej weryfikacji''.
Sprawdza on poprawno¶æ sk³adniow± adresu, jak równie¿ mo¿e dokonaæ sprawdzenia
domeny czy jest ona w zakresie domen do których maile mo¿e przekazywaæ.
Odpowied¼ serwera powinna wiêc uwzglêdniæ, ¿e jest to tylko czê¶ciowa
weryfikacja adresu i zamiast statusu 250 powinien pojawiæ siê status 252. 

Implementacje serwera SMTP powinny zawieraæ przedstawione powy¿ej komendy. W
celach bezpieczeñstwa implementacje mog± dostarczaæ narzêdzi (np. poprzez plik
konfiguracyjny) do wy³±czenia tych poleceñ. Polecenia te by³y opcjonalne w RFC
821, ale obecnie powinny byæ wylistowane jako dodatkowe serwisy w odpowiedzi na
EHLO.

\subsubsection{Koniec sesji i po³±czenia}

Jak ju¿ wcze¶niej zosta³o wspomniane sesja w protokole SMTP koñczy siê wraz z
przes³aniem przez klienta polecenia QUIT. Serwer odpowiada pozytywnym kodem, po
którym zamyka po³±czenie.

Serwerowi nie wolno zamkn±æ po³±czenia intuicyjnie poza 2 przypadkami:

\begin{itemize}
  \item otrzyma polecenie QUIT i odpowie kodem 221
  \item po wykryciu potrzeby zamkniêcia serwisu SMTP i przes³aniu kodu 421.
  Odpowied¼ ta mo¿ê byæ umieszczona po ka¿dej komendzie lub asynchronicznie
  (przy za³o¿eniu, ¿e klient odbierze j± zanim kolejne polecenie zostanie
  przes³ane)
\end{itemize}

Klient SMTP, który spotka siê z zamkniêciem po³±czenia w wyniku okoliczno¶ci,
których nie mo¿e obs³u¿yæ, powinien traktowaæ przeprowadzan± transakcjê jak
gdyby otrzyma³ od serwera odpowied¼ 451 ''Requested action aborted: error in
processing''.

\subsubsection{Listy mailowe (mailingowe) i aliasy}

Serwer SMTP powinien wspieraæ zarówno aliasy, jak i listy mailowe, które
s³u¿± w celach dostarczenia wiadomo¶ci do wiêkszej ilo¶ci adresów. 

Alias to inaczej pseudo-skrzynka, której nazwa przy odbieraniu maila t³umaczona
jest na rzeczywisty adres (b±d¼ adresy). Serwer SMTP obs³uguj±cy aliasy po
odebraniu maila przesy³a go w formie niezmienionej na docelowy adres (lub
adresy).

Lista mailowa s³u¿y dostarczeniu albo przekazaniu maila do wszystkich adresów
znajduj±cych siê na li¶cie. Program zajmuj±cy siê obs³ug± listy po odebraniu
maila rozsy³a wiadomo¶æ o niezmienionej tre¶ci do wszystkich adresów na niej
zapisanych. Modyfikacji w trakcie rozsy³ania ulega ''koperta'', a dok³adnie
argument polecenia MAIL FROM, na podstawie, którego odbiorca determinuje
ewentualny adres zwrotny. Adres ten powinien wskazywaæ na skrzynkê osoby
odpowiedzialnej za administracjê list±.

\subsubsection{Informace o trasie}

Kiedy serwer SMTP otrzyma wiadomo¶æ do dostarczenia albo dalszego procesowania
pozostawia w niej swój ¶lad. ¦lad ten umieszczany jest na pocz±tku cia³a
wiadomo¶ci (nag³ówki ''time stamp'' albo ''Received'').

Linia ta powinna siê sk³adaæ z nastêpuj±cych informacji:

\begin{itemize}
  \item pola FROM, które powinno zawieraæ zarówno nazwe hosta ¼ród³owego (tak
  ja w zaprezentowanym w ramach odpowiedzi na komende EHLO) i adres IP ¼ród³a,
  zdeterminowane z po³±czenia TCP
  \item pola ID, które mo¿e zawieraæ zgodnie z sugestiami w RFC 822 znaczke
  ''@'', ale nie jest to wymagane
  \item pola FOR, które mo¿e zawieraæ listê wpisów <path> kiedy w poleceniu
  RCPT zosta³o podanych ich kilka
\end{itemize}

Wcze¶niej dodane linijka Received nie powinna byæ zmieniana. Serwery SMTP
powinny mieæ przygotowan± linie Received do ''wstrzykniêcia'' do wiadomo¶ci.
Nie wolno im zmieniaæ obecnych lini ani te¿ wpisywaæ swojej lini w innym ni¿
przeznaczone miejscu.

Przyk³adowa linia ma nastêpuj±c± postaæ:
\combox{Received: from mizar.astronet.pl ([127.0.0.1])\newline
\hspace*{0.3cm}by localhost (mizar [127.0.0.1]) (amavisd-new, port 10024) with
ESMTP\newline
\hspace*{0.3cm}id 18935-01 for <zbychu@astronet.pl>; Fri, 29 Feb 2008 14:44:55
+0100 (CET)}
W miarê rozwoju Internetu linie Received s± bardzo istotne w celach wykrywania
wyst±pienia jakichkolwiek problemów.

Kiedy wiadomo¶æ jest ostatecznie dostarczana, serwer SMTP wstawia nag³ówek
''Return-path'' na pocz±tku maila. Zachowanie to jest wymagane. Systemy mailowe
SMTP musz± to implementowaæ. ''Return-path'' to zachowane informacje z
argumentu <reverse-path> z polecenia MAIL. Po tym oznaczeniu uznawane jest, ¿e
wiadomo¶æ opu¶ci³a ¶rodowisko SMTP, jednak¿e nie oznacza to obecnie, ¿e zosta³a
ona ostatecznie dostarczona. Mo¿e byæ transmitowana przez inny system mailowy.

\subsubsection{Rozmiary i opó¼nienia}

W protokole SMTP wystêpuj± obiekty, które maj± wymagane minimalne b±d¼ te¿
maksymalne rozmiary. Ka¿da implementacja musi byæ w stanie odbieraæ obiekty
takich wielko¶ciach. Obiekty wiêksze powinny byæ unikane. Klient mo¿e liczyæ
siê z tym, ¿e przy próbie transmisji zbyt du¿ych obiektów, mo¿e spotkaæ siê z
odmow± ze strony serwera.

Obiekty o których mowa to:

\begin{itemize}
  \item local-part - maksymalna d³ugo¶æ nazwy u¿ytkownika. Wynosie ona 64 znaki
  \item domain - maksymalna d³ugo¶æ domeny. Wynosi to 255 znaków
  \item path - maksymalna d³ugo¶æ argumentu reverse-path albo forward-path.
  Wynosi ona 256 znaków (wliczaj±c w to interpunkcje i separatory elementów)
  \item command line - maksymalna d³ugo¶æ polecenia wraz z jego nazw± i znakiem
  <CRLF>. Wynosi ona 512 znaków. Rozszerzenia SMTP mog± pos³u¿yæ w celach
  zwiêkszenia tego limitu
  \item reply line - maksymalna d³ugo¶æ lini odpowiedzi. Wynosia oan 512 znaków
  wliczaj±c w to kod odpowiedzi oraz znak <CRLF>
  \item text line - maksymalna d³ugo¶æ lini tekstu wliczaj±c w to znak <CRLF>.
  Wynosi ona 1000 znaków. Mo¿e byæ ona rozszerzona przez dodatkowe serwisy
  SMTP.
  \item message content - d³ugo¶æ zawarto¶ci wiadomo¶ci (wliczaj±c
  w to nag³ówki wiadomo¶ci jak i jego cia³o). Musi mieæ ona co najmniej 64K
  bajtów. Odk±d wprowadzono standard Multipurpose Internet Mail
  Extensions (MIME) wielko¶æ wiadomo¶ci wzros³a diametralnie, dlatego te¿
  zaleca siê obecnie aby serwery SMTP nie nak³ady ¿adnych ograniczeñ na wielko¶æ
  wiadomo¶ci
  \item recipients buffer - rozmiar buffora adresowego. Minimalna ca³kowita
  liczba odbiorców, która musi byæ zbuforowana to 100. Klient, który chce
  dostarczyæ wiadomo¶æ do wiêcej ni¿ 100 odbiorców powinien byæ przygotowany na
  transmisjê maila w czê¶ciach po 100 odbiorców.
\end{itemize}

B³êdy zwi±zane z powy¿szymi ograniczeniami mog± byæ zg³oszone poprzez
standardowe kody b³êdów. Przyk³ady takich b³êdów:

\begin{itemize}
  \item \comboxinitemizenonl{500 Line too long}
  \item \comboxinitemizenonl{501 Path too long}
  \item \comboxinitemizenonl{452 Too many recipients}
  \item \comboxinitemizenonl{552 Too much mail data}
\end{itemize}

W ramach protoko³u SMTP nie mo¿emy tak¿e zapomnieæ o opó¼nieniach, które nale¿y
wzi±æ pod uwagê przy implementacji klienta. Klient musi repektowaæ opó¼nienia
zwi±zane z poleceniami. Powinny one byæ w prosty sposób w kliencie
konfigurowalne (w celach ewentualnych zmian i próby dostosowanie opó¼nieñ do
warunków panuj±cych w sieci). Proponowane opó¼nienia dla klienta zawarte
w RFC przedstawiaj± siê nastêpuj±co:

\begin{itemize}
  \item Pocz±tkowa wiadomo¶æ 220 od serwera: 5 minut
  \newline
  Klient SMTP powinien mieæ mo¿liwo¶æ rozró¿nienia pomiêdzy problemami
  zwi±zanymi z TCP (zerwane po³±czenie) a opó¼nieniami w otrzymaniu powitalnego
  220. Wiele serwerów SMTP akceptuje po³±czenia, ale opo¼nia ich obs³ugê dopóki
  load na maszynie nie spadnie do odpowiedniego poziomu
  \item Polecenie MAIL: 5 minut
  \item Polecenie RCPT: 5 minut
  \newline
  Wiêksze opó¼nienie jest wymagane w przypadkach, gdy procesowanie obs³ugi
  listy mailowej czy aliasu nie nastêpuje po akceptacji maila
  \item Inicjalizacja polecenie DATA: 2 minuty
  \newline
  Potrzeba na czekanie na odpowied¼ serwera ''354 Start Input''
  \item Blok danych: 3 minuty
  \newline
  Ewentualna potrzeba na oczekiwanie na zakoñczenie wywo³anai TCP SEND do
  transmisji kolejnych porcji danych
  \item Zakoñczenie polecenia DATA: 10 minut
  \newline
  Potrzebne w celach oczekiwania na odpowied¼ 250 OK. Kiedy odbiorca otrzyma
  ostatni znak oznaczaj±cy koniec wiadomo¶ci, przewa¿nie zaczyna siê proces
  przetwarzania w celu jej dostarczenia do konkretnej skrzynki u¿ytkownika.
  Nieodpowiednie opó¼nienie tutaj mo¿e skutkowaæ dostarczeniem paru kopii tego
  samego maila, poniewa¿ klient za³o¿y, ¿e transakcja siê nie uda³a (minie
  odpowiedni czas) i j± ponowi, a tak naprawde odbiorca zaakceptuje wiadomo¶æ,
  ale nie zd±¿y jeszcze powiadomiæ o tym klienta.
\end{itemize}

W przypadku opo¼nieñ serwera mo¿emy mówiæ o sta³ym opó¼nieniu 5 minut w
oczekiwaniu na komendy od klienta.

\subsubsection{Strategie wysy³ania i odbierania}

Przewa¿nie struktura implementacji hosta SMTP zawiera skrzynki u¿ytkowników,
jedn± lub wiêcej kolejek wiadomo¶ci oraz jednego lub wiêcej demonów do
odbierania i wysy³ania maili. Dok³adna struktura ró¿ni siê w zale¿no¶ci od
potrzeby u¿ytkowników oraz liczby i wielko¶ci list mailowych obs³ugiwanych
przez host. Poni¿ej strategie, które okaza³y siê bardzo pomocne w przypadku
obs³ugi du¿ego ruchu mailowego:

\begin{itemize}
  \item Wysy³anie:
  \newline
  G³ównym modelem dla klienta SMTP jest jeden lub kilka procesów, które
  cyklicznie próbuj± transmitowaæ maile wychodz±ce. Typowy program kliencki,
  który komponuje wiadomo¶æ, ma wbudowane odpowiednie mechanizmy, za pomoc±
  których natychmiastowo informuje procesy wysy³aj±ce o pojawieniu siê nowego
  elementu w wiadomo¶ciach do wys³ania. Maile, które nie s± transmitowane od
  razu s± kolejkowane i cyklicznie wysy³ane. Kolejka mailowa zawiera oprócz
  samej wiadomo¶ci ''kopertê'' czyli dodatkowe informacje s³u¿±ce do wysy³ania.
  \newline
  Nadawca po nieudanym wys³aniu powinien odczekaæ pewien kwant czasu
  zanim ponowi próbê transmisji maila. Standardy RFC zalecaj± okres oko³o
  30 minut.
  \newline
  Ponawianie wys³ania nastêpuje dopóki zakoñczy siê ono sukcesem b±d¼ te¿
  klient siê stwierdzi po okre¶lonej ilo¶ci prób, ¿e wiadomo¶ci nie da siê
  dostarczyæ. Przyjmuje siê, ¿e po 4-5 dniach nieudanych próbach, wiadomo¶æ
  zostaje uznana za niedorêczon±.
  \newline
  Klient powinien przechowywaæ listê hostów do których nie mo¿e dotrzeæ i
  zapamiêtywaæ opó¼nienia do nich, zamiast nieustannie kolejkowaæ maile
  przeznaczone do tych hostów. W ten sposób szybciej odrzuci maile, które nie
  maj± szansy osi±gn±æ celu.
  \newline
  Klient SMTP mo¿e zmniejszyæ oczekiwanie w kolejce we wspó³pracy z serwerem
  SMTP. Dla przyk³adu, je¿eli mail z danego adresu (domeny), zosta³ odebrany
  prawdopodobne jest, ¿e maile kolejkowane dla tego adresu (domeny), mog±
  zostaæ wys³ane.
  \newline
  Klient SMTP mo¿e posiadaæ kolejkê niedostarczonych wiadomo¶ci dla ka¿dego
  hosta, do którego nie uda³o siê po³±czyæ. Ponawianie wysy³ania takich
  wiadomo¶ci mo¿e byæ niebezpiecznie, szczególnie w przypadku ich du¿ej ilo¶ci.
  Niebezpieczeñstwo wi±¿ê siê z tym, ¿e klient, aby stwierdziæ, ¿e host jest
  rzeczywi¶cie nieosi±galny potrzebuje odpowiedniego czasu. Wiele oczekuj±cych
  tak procesów (lub w±tków) klienckich mo¿e spowodowaæ zamro¿enie na jaki¶ czas
  ca³ego systemu.
  \newline   
  W przypadku wysy³ania wiadomo¶ci do wielu odbiorców z tego samego hosta klient
  powinien stosowaæ taktykê MAIL, RCPT, RCPT, \ldots RCPT, DATA zamiast MAIL,
  RCPT, DATA, \ldots, MAIL, RCPT, DATA. 
  
  \item Strategie odbioru
  \newline
  SMTP server powinien oczekiwaæ nieustannie nadchodz±cych po³±czeñ. Wymaga to
  oczywi¶cie od implementacji obs³ugi wielu po³±czeñ jednocze¶nie. Jak ju¿
  wspomniano wcze¶niej obs³uga procesu dostarczenia maila do konkretnej
  skrzynki mo¿e odbywaæ siê nie tu¿ po obs³udze polecenia DATA, ale w odzielnym
  procesie. Zmniejszony jest wtedy czas oczekiwania klienta na ostateczne
  potwierdzenie zakoñczenia transakcji maila.
\end{itemize}

\subsubsection{Rozwi±zywanie adresu i przekazywanie maila}

Zanim klient SMTP zidentyfikuje dok±d ma byæ pos³any mail, musi nast±piæ
odpytanie serwera DNS o adres domeny. Oczekuje siê, ¿e podane w adresie nazwy
domen s± w pe³ni akceptowanymi nazwami domen (fully qualified domain name,
FQDN). Pierwsze odpytanie serwera to zapytanie o rekordy MX zwi±zane z nazw±.

Rekord MX (Mail eXchanger) to jeden z typów rekordów w serwerze domen DNS,
który specyfikuje w jakis sposób maile powinny byæ routowane (przekazywane w
sieci) przy u¿yciu protokolu SMTP. Ka¿dy rekord MX ma nastêpuj±c± postaæ:
[name] [ttl] IN MX [preference] [host]
gdzie: 

\begin{itemize}
  \item name - nazwa komputera lub domeny - nale¿y my¶leæ tu o tym co
  nastêpuje po znaku ''@'' w adresie. Poczta wysy³ana na wskazany adres bêdzie
  kierowana na adres wskazany w polu host.
  \item ttl - czas ¿ycia rekordu
  \item preference - komputer lub domena mo¿e mieæ wiêcej ni¿ jeden komputer
  wskazany jako odbiorca poczty, wpisana w tym polu liczba okre¶la preferencjê
  - im mniejsza jej warto¶æ tym priorytet wy¿szy
  \item host - nazwa serwera pocztowego
\end{itemize}

Je¿eli przed rekordem MX zostanie znaleziony rekord CNAME, host który znajduje
siê pod tym rekordem jest nastêpnie traktowany jak host, który by³ pierwotnie
podany do poszukiwañ w DNS-ie. Rekord CNAME to swego rodzaju alias w DNS-ie. 

Je¿eli ¿aden rekord MX nie zostanie odnaleziony, ale za to odnaleziony zostanie
rekord A, jest on traktowany jakby by³ rekordem MX z preferencj± 0 (czyli
najwy¿szym priorytetem). 

Je¿eli uda siê znale¼æ jeden lub wiêcej rekordów MX dla danej nazwy,
implementacjom systemów SMTP nie wolno u¿ywaæ ¿adnych rekordów A zwi±zanych z
nazw±.

Kiedy odpytanie DNS-ów zostanie zakoñczone sukcesem, mo¿emy w wyniku mapowania
otrzymaæ kilka adresów, ze wzglêdu na mo¿liwo¶æ kilku rekordów MX czy te¿
multihoming (albo to i to). A¿eby zapewniæ niezawodn± transmisjê maila, klient
SMTP musi próbowaæ (i ew. ponawiaæ próby) dla ka¿dego z adresów wg porz±dku,
a¿ uda siê dostarczyæ wiadomo¶æ. Klient mo¿e posiadaæ konfigurowaln± liczbê
maksymalnych alternatywnych adresów. Liczba ta powinna wynosiæ przynajmniej 2
adresy.

Jak wy¿ej wspomniano klient posy³a maile do kilku adresów na podstawie
uporz±dkowanej listy, która to zale¿na jest od priorytetów w rekordach MX oraz
od hostów z wieloma adresami. Im ni¿szy priorytet tym serwer jest bardziej
preferowany, za¶ przy tych samych priorytetach dokonywany jest wybór losowy. 

Adres hosta docelowego mo¿e okazaæ siê nie pojedynczym adresem, ale list±
adresów (multihomed host). Zadaniem serwera DNS jest zwrócenie ju¿
uporz±dkowanej listy adresów IP, a klient po kolei próbuje wys³aæ pod nie maile.

Obs³uga alternatywnych adresów zwi±zanych z multihomingiem mo¿e zostaæ w
kliencie ograniczona do okre¶lonej liczby albo w ogóle wy³±czona.

\subsection{Konstrukcja wiadomo¶ci}

G³ówne informacje na temat postaci wiadomo¶ci s± obecnie zebrane w kilku
dokumentach. Jednym z g³ównych opisuj±ych wygl±d wiadomo¶ci bez rozszerzeñ jest
obecnie RFC 2822 (nastêpca przedawnionego RFC 822). Rozszerzenia
wiadomo¶ci, które bêd± opisane pó¼niej, zdefiniowane s± w kolejnych dokumentach
(seria dokumentów o MIME RFC2045 \cite{rfc-2045}, RFC2046 \cite{rfc-2046},
RFC2047 \cite{rfc-2047}, RFC2048 \cite{rfc-2048}, RFC2049 \cite{rfc-2049}).

Sama wiadomo¶æ to po prostu sekwencja znaków. Wiadomo¶æ zgodna ze standardem
sk³ada siê ze znaków od 1 do 127 interpretowanych jako znaki kodowania US-ASCII.
Wynika to oczywi¶cie ze wzglêdów historycznych, gdy¿, jak to juz by³o
wspomniane, to w Stanach zosta³y pos³ane pierwsze wiadomo¶ci i to na tamte
potrzeby stworzono pierwsze standardy.

Wiadomo¶ci s± podzielone na linie. Linia to seria znaków, która jest
ograniczona przez 2 znaki powrót karetki (CR - carriege return - w ASCII znak
numer 13) i znak nowej linii (LF - line-feed - w ASCII znak numer 10). Znaki te
z regu³y wystêpuj± razem w ramach wiadomo¶ci i oznaczane s± jako CRLF.

Ogólnie wiadomo¶æ mo¿na podzieliæ na 2 czê¶ci - pola z nag³ówkami wiadomo¶ci
(nazywane po prostu nag³ówkiem wiadomo¶ci) oraz cia³a wiadomo¶ci, które jest
opcjonalne. 

\subsubsection{Ograniczenia w d³ugo¶ci linii}

Ilo¶æ znaków w linii jest ograniczona dwoma limitami. Maksymalna ilo¶æ znaków w
linii (z pominiêciem CRLF), musi byæ mniejsza ni¿ 998 znaków, i nie powinna byæ
wiêksza ni¿ 78 znaków.

Limit 998 znaków wynika z ograniczeñ wielu obecnych implementacji, które
zajmuj± siê odbiorem, wysy³k± oraz przechowywaniem wiadomo¶ci. Nie obs³uguj±
one po prostu d³u¿szych linii. 

Bardziej konserwatywne ograniczenie zwi±zane z liczb± 78 znaków wynika z próby
dostosowania wiadomo¶ci do wielu implementacji interfejsu u¿ytkownika, które
wy¶wietlaj± te wiadomo¶ci. Implementacje te mog± uci±æ linie zawieraj±ce wiêcej
ni¿ 78 znaków.

\subsubsection{Nag³ówki wiadomo¶ci}

Pole nag³ówka sk³ada siê z:

\begin{itemize}
  \item nazwy nag³ówka po której nastêpuje dwukropek '':''
  \item cia³a nag³ówka po które nastêpuje znak CRLF
\end{itemize}

Nazwa nag³ówka musi sk³adaæ siê z drukowalnych znaków US-ASCII (czyli tych,
których kody s± pomiêdzy 33, a 126 w³±cznie) bez przecinka '',''. Cia³o
nag³ówka mo¿e zawieraæ wszystkie znaki oprócz CR i LF, chyba, ¿e przy
konstrukcji nag³ówka u¿yto sk³adania (ang. folding) opisanego ni¿ej.

Same nag³ówki mo¿na podzieliæ na posiadaj±ce (structured) lub nie posiadaj±ce
dodatkowej struktury (unstructured).

Te drugie (unstructered) oprócz wcze¶niej na³o¿onych restrykcji co do
wystêpowania okre¶lonych znaków, nie maj± dodatkowych obostrzeñ. Semantycznie
nie poddaje siê ich dodatkowemu procesowaniu (chyba, ¿e nag³ówek nale¿y
posk³adaæ [ang. unfold])

Niektóre nag³ówki wymagaj± w ramach swojego cia³a dodatkowej semantyki
(struktury). Je¿eli dane cia³o nag³ówka nie jest zgodne z t± semantyk± to taki
nag³ówek, a przez to tak¿e wiadomo¶æ, nie jest zgodna ze specyfikacj± opisywan±
w RFC 2822. 

Jak ju¿ by³o wcze¶niej zaznaczone pojedynczy nag³ówek to pojedyncza linia
sk³adaj±ca siê z nazwy, dwukropka i cia³a nag³ówka. Dla wygody, a tak¿e aby
poradziæ sobie z ograniczeniem na maksymalna d³ugo¶æ linii, pojedynczy nag³ówek
mo¿e byæ roz³o¿ony na kilka linii. Dzielenie to okre¶lamy angielskim s³owem
''folding''. 
Dzielenie to polega na tym, ¿e cia³o nag³ówka mo¿e zostaæ, w przypadku d³ugiej
lini, przeniesione do nastêpnej. Linia koñczona jest normalnym znakiem CRLF,
ale nowa linia musi byæ rozpoczêta znakiem WSP (white space czyli spacj± space
[SP] - kod 32 lub tabulatorem horizontal-tab [HTAB] - kod 11). Przyk³adowo
nag³ówek:
\combox{Subject: This is a test}
mo¿e byæ reprezentowany jako
\combox{Subject: This\newline
\hspace*{5mm} is a test}
 
Dzielenie nag³ówka na wiele lini mo¿e nast±piæ w wielu miejscach jednak zaleca
siê wstawianie znaku CRLF pomiêdzy tokenami, które znajduj± siê na najwy¿szym
stopniu w semantyce nag³ówka. Dla przyk³adu gdy cia³o nag³ówka sk³ada siê z
podzielonych przecinkami warto¶ci, zaleca siê ³amanie lini po przecinku
rozdzielaj±cym struktury.

Jak ju¿ wcze¶niej by³o zaznaczone sk³adanie nag³ówka z wielu lini okre¶lane
jest angieslkim s³owem ''unfolding''.

\subsubsection{Opis wybranych nag³ówków}

Niektóre z nag³ówków wiadomo¶ci (jak to ju¿ wcze¶niej wspomniano) posiadaj±
pewn± dodatkow± strukturê i s± przeznaczone do okre¶lonych celi. Dok³adny opis
semantyki cia³a ''zaawansowanych'' nag³ówków umieszczony jest w RFC 2822 i nie
bêdzie tutaj poruszany, jednak warto wspomnieæ jakie informacje nios± te
nag³ówki.

\begin{description}
  \item[Date] - nag³ówek ten specyfikuje datê i czas, któr± to twórca
  wiadomo¶ci wskazuje, ¿e jest ona skoñczona i gotowa do wej¶cia w system
  dostarczania poczty (czyli gotowa do wys³ania). Przyk³adowo mo¿e byæ to czas
  zarejestrowany w momencie klikania przez u¿ytkownika przycisku ''Wy¶lij''
  \item[From, Sender, Reply-to] - nag³ówki okre¶lane s± nag³ówkami autora
  wiadomo¶ci. Pola te wskazuj± na skrzynkê (skrzynki) ¼ród³a wiadomo¶ci. W
  szczególno¶ci pole From okre¶la autora (b±d¼ autorów) wiadomo¶ci czyli
  skrzynkê (b±d¼ skrzynki) osoby (lub osób) odpowiedzialnych za stworzenie
  maila. Nag³ówek Sender okre¶la skrzynkê odpowiedzialn± za aktualn± transmisjê
  maila. Je¿eli twórc± wiadomo¶ci jest pojedyncza skrzynka oraz pole autora i
  transmituj±cego maila s± identyczne nag³ówek Sender nie powinien wyst±piæ.
  Inaczej oba (From i Sender) powinny siê pojawiæ. 
  \newline
  Reply-to (je¶li jest obecne) wskazuje skrzynkê (skrzynki), do których autor
  chcia³by, aby s³ane by³y odpowiedzi. Je¿eli brakuje nag³ówka Reply-to wtedy
  odpowiedzi powinny byæ s³ane na adres spod nag³ówka From. Nag³ówek From nie
  powinien zawieraæ ¿adnych adresów skrzynek nie nale¿±cych do autora
  wiadomo¶ci.
  \item[To, Cc, Bcc] - zwane s± polami docelowymi. Okre¶laj± one odbiorców
  wiadomo¶ci. Pole To okre¶la adres g³ównego odbiorcy (b±d¼ adresy g³ównych
  odbiorców). Pole Cc (nazwa pochodzi od Carbon Copy w rozumieniu tworzenia
  kopii przez pisarza przy u¿yciu kalki) zawiera inne adresy osób, które
  powinny otrzymaæ maila, chocia¿ to nie oni s± g³ównymi adresatami. Bcc (Blind
  Carbon Copy) zawiera adresy odbiorców, które nie maj± byæ pokazane innym
  odbiorcom. S± trzy sposoby u¿ycia Bcc: 
  \begin{itemize}
    \item Pierwszy z nich polega na usuniêciu z wiadomo¶ci linijki Bcc (tu¿
    przed wys³aniem wiadomo¶ci) i przes³anie jej kopii tak¿e do tych adresów z
    Bcc. 
    \item Drugi sposób polega na pos³aniu do adresatów z To i Cc wiadomo¶ci z
    usuniêt± linijk± Bcc, za¶ adresy spod lini Bcc dostaj± maila w ca³o¶ci
    czyli z linijk± Bcc. Tutaj pojawiaj± siê ró¿ne zachowania, je¿eli w polu
    Bcc mamy kilka adresów. Niektóre implementacje modyfikuj± tak Bcc, ¿e
    zawiera on za ka¿dym razem tylko tego odbiorce do którego trafia mail.
    \item Ostatni sposób podobny jest do pierwszego tylko zamiast usuwania
    lini Bcc wiadomo¶æ jest wys³ana bez ¿adnego adresu 
  \end{itemize}
  Sposób u¿ycia Bcc zale¿y od implementacji klienta.
  \item[Message-ID, In-Reply-To, References] - chocia¿ opcjonalne pola te
  powinny byæ (i z regu³y s±) obecne w wiadomo¶ci. Message-ID zapewnia
  wiadomo¶ci unikalny identyfikator, który odnosi siê do danej wersji danej
  wiadomo¶ci. Unikalno¶æ gwarantowana jest przez host, który generuje to id.
  Pola In-Reply-To i References s± wykorzystywane przy tworzeniu odpowiedzi na
  wiadomo¶æ. Zawieraj± one identyfikator wiadomo¶ci oryginalnej (In-Reply-To)
  oraz identyfikatory innych wiadomo¶ci (References), gdy na przyk³ad wiadomo¶æ
  jest odpowiedzi± na odpowied¼. Tak wiêc In-Reply-To (je¶li istnieje) wskazuje
  nam na jak± wiadomo¶æ jest odpowiedzi± ta wiadomo¶æ, za¶ References zawiera
  wskazanie na ''w±tek'' w którym jest wiadomo¶æ. W trakcie konstrukcji
  wiadomo¶ci nag³ówki In-Reply-To i References tworzone s± w nastêpuj±cy sposób:
  \newline
  In-Reply-To przepisuje zawarto¶æ z Message-ID. Je¶li istnieje kilka
  wiadomo¶ci nadrzêdnych (parent message) wtedy In-Reply-To bêdzie zawiera³o
  wszystkie pola Message-ID poprzedników. Je¶li pole Message-ID nie istnieje
  In-Reply-To oczywi¶cie nie jest tworzone.
  \newline
  References przejmuje warto¶æ z wszystkich References (je¶li jakie¶ istniej±)
  po których przepisywane s± warto¶ci z Message-ID wszystkich wiadomo¶ci
  nadrzêdnych. Je¶li wiadomo¶ci nadrzêdne nie posiadaj± pola References, a
  posiadaj± pole In-Reply-To to miejsce References nadrzêdnych wiadomo¶ci
  przejmuje In-Reply-To. Je¶li nadrzêdne wiadomo¶ci nie maj± ¿adnego z trzech
  pól o których tutaj mowa, nowa wiadomo¶æ odpowied¼ nie bêdzie mia³a pola
  References.
  \newline 
  Czê¶æ implementacji parsuje pole References, aby odtworzyæ przebieg dyskusji
  i utworzyæ w±tek z uporz±dkowanymi wiadomo¶ciami. Tak robi na przyk³ad bardzo
  ostatnimi czasy popularny webowy klient poczty Gmail. Czytanie tak u³o¿onych
  wiadomo¶ci jest niesamowicie wygodne.
  \item[Subject, Comments, Keywords] - pola te przeznaczone do celów
  informacyjnych powinny mieæ formê czyteln± dla ludzi. Subject to tytu³
  wiadomo¶ci. Comments zawiera bardziej szczegó³owy opis wiadomo¶ci, za¶
  Keywords to porozdzielane przecinkami najwa¿niejsze wyrazy opisuj±ce
  wiadomo¶æ.
  \item[Return-Path, Received] - pola te zawieraj± informacje na temat drogi
  wiadomo¶ci w systemie (tworzenie ich by³o opisane wcze¶niej)
\end{description}

Dodatkowo u¿ytkownik mo¿e sobie sam zdefiniowaæ i u¿ywaæ dodatkowych nag³ówków.
Oczywi¶cie nazwy tych nag³ówków nie mog± siê pokrywaæ z nazwami ju¿ u¿ywanymi.
Dlatego przyjmuje siê, ¿e nag³ówki dodatkowo definiowane (nie objête
specyfikacjami RFC 822 oraz RFC 2822) powinny byæ poprzedzane wyra¿eniem ''X-''
jak na przyk³ad:
\comboxnonl{X-Mailer: Microsoft Windows Mail 6.0.6001.18000}

\subsubsection{Cia³o wiadomo¶ci}

Cia³o wiadomo¶ci to po prostu linie z³o¿one ze znaków US-ASCII. S± tylko dwa
wymogi co do znaków w ciele wiadomo¶ci:

\begin{itemize}
  \item znaki CR i LF musz± wystêpowaæ razem w postaci CRLF
  \item d³ugo¶æ lini musi byæ nie wiêksza ni¿ 998 znaków i powinna byæ nie
  wiêksza ni¿ 78 znaków (wy³±czaj±c CRLF)
\end{itemize}

\subsubsection{Rozszerzenie wiadomo¶ci, MIME}

Jak zosta³o wspomniane wy¿ej RFC 822 oraz RFC 2822 definiuj± w jaki sposób ma
wygl±daæ cia³o wiadomo¶ci w bardzo zawê¿ony sposób. Nie uwzglêdniaj± one
problemu zwi±zanego z obs³ug± wielu jêzyków (tylko znaki US-ASCII s± mo¿liwe w
ramach cia³a wiadomo¶ci), nie wspominaj±c ju¿ o mo¿liwo¶ci przesy³ania plików
audio, wideo czy zdjêæ. Dlatego te¿ w 1996 powsta³o pierwsze RFC (2045) wychodz±ce na przeciw tym wszystkim problemom. Specyfikacja
tych rozszerzeñ znalaz³a siê w a¿ 4 RFC (2045-2048), które to zosta³y nazwane Multipurpose
Internet Mail Extensions w skrócie MIME. 

MIME definiuje kilka dodatkowych nag³ówków, które s³u¿± do opisu cia³a
wiadomo¶ci. Nag³ówki te pojawiaj± siê w 2 miejscach:

\begin{itemize}
  \item jako normalne nag³ówki na pocz±tku wiadomo¶ci
  \item jako nag³ówki w ramach czê¶ci wiadomo¶ci, o których mowa bêdzie pó¼niej 
\end{itemize}

Pierwszy z dodatkowych nag³ówków to nag³ówek MIME-VERSION, który obowi±zkowo
musi byæ zawarty w wiadomo¶ci (je¶li ma ona byæ zgodne ze standardem MIME) jako
g³ówny nag³ówek, za¶ nie jest konieczny w przypadku nag³ówków w czê¶ci
wiadomo¶ci. Przyk³adowo nag³ówek ten mo¿e wygl±daæ tak:
\combox{MIME-Version: 1.0}
Kolejnym nag³ówkiem w ramach wiadomo¶ci typu MIME jest nag³ówek Content-Type,
który definiuje w sposób zapisania danych w wiadomo¶ci. Argument wystêpuj±cy w
nag³ówku Content-Type jest nazywany ''media type'' (w wolnym t³umaczeniu
rodzaj/typ danych). Przyk³adowo typ ''image/xyz'' mówi nam, ¿e mamy do
czynienia z danymi, które przedstawiaj± zdjêcie, nawet je¶li klient pocztowy
nie jest w stanie rozpoznaæ typu ''xyz''. 
Opcjonalne parametry przy typie danych nie maj± wp³ywu na ich naturê, a jedynie
dodatkowo okre¶laj± te dane. Niektóre implementacje mog± nie rozpoznawaæ
pewnych argumentów MIME i gdy taka sytuacja ma miejsce, argumenty
te powinny byæ pomijane. Przyk³adowym dodatkowym parametrem dla typu ''text'',
mo¿e byæ ''charset'' okre¶laj±cy kodowanie tekstu w wiadomo¶ci.

G³ównymi typy MIME (zdefiniowanymi w RFC 2046) to:
\begin{itemize}
  \item text - wiadomo¶æ tekstowa. Podtyp ''plain'' okre¶la wiadomo¶æ bez
  dodatkowego formatowania. Nie wymaga ona ¿adnego dodatkowego oprogramowania
  poza ewentualnie obs³ug± odpowiedniego kodowania. Mo¿liwe oczywi¶cie s± inne
  podtypy chocia¿by html, który wskazuje, ¿e dana wiadomo¶æ mo¿e byæ parsowana
  jakby by³a stron± html
  \item image - dane ze zdjêciem. Wymagaj± one dodatkowego oprogramowania w
  celu wy¶wietlenia zdjêcia. Podtypami s± tutaj ró¿ne formaty zdjêæ jak np.
  jpeg, gif czy png
  \item audio - dane d¼wiêkowe. Potrzebne jest dodatkowe oprogramowanie w celu
  ods³uchania d¼wiêku. Pocz±tkowyn podtypem jest ''basic''
  \item video - dane video. Potrzebne jest dodatkowoe oprogramowanie w celu
  otwarcia pliku. Pocz±tkowym podtypem jest mpeg.
  \item application - dane binarne bli¿ej nie sprecyzowane, które mog± byæ
  poprawnie zinterpretowane przez dodatkowe oprogramowanie. Podtyp
  ''octet-stream'' powinien byæ u¿ywany je¿eli chcemy aby najprostsz± akcj±,
  która zostanie nam zaoferowana przez klienta pocztowego to zapis pliku na
  dysk. ''Application'' powinno byæ tak¿e u¿ywane np. w przypadku arkuszy
  kalkulacyjnych, materia³ów PostScript czy innych formatów, które w prosty
  sposób nie s± czytelne.
  \item multipart - typ ten definiuje, ¿e wiadomo¶æ bêdzie z³o¿ona z kilku
  czê¶ci. Typ ten posiada 4 podtypy:
  \begin{itemize}
    \item mixed - obecnie bardzo czêsto wykorzystywany w przypadku kiedy
    wiadomo¶æ sk³ada siê z kilku elementów ró¿nych od siebie np. tekstu oraz
    zdjêcia. 
    \item alternative - s³u¿y do zdefiniowania tej samej tre¶ci w ró¿nym
    formatowaniu np. tekst w postaci plain oraz html.
    \item parallel - s³u¿y do wiadomo¶ci, której czê¶ci maj± byæ zaprezentowane
    jednocze¶nie
    \item digest - wykorzystywany przy wiadomo¶ciach z³o¿onych z czê¶ci, z
    których ka¿da ma inny typ
  \end{itemize}
   
  \item message - enkapsulacja wiadomo¶ci. Zawarto¶æ takiej wiadomo¶ci jest sama
  w sobie wiadomo¶ci±. Przyk³adowy podtyp ''rfc822'' definiuje wiadomo¶æ zgodn±
  z RFC 822 \cite{rfc-822}, za¶ ''partial'' s³u¿y do zdefiniowania czê¶ci
  wiadomo¶ci zgodnej z RFC 822 w celach transmisji jej fragmentów ze wzglêdu na jej du¿± wielko¶ci
  uniemo¿liwiaj±c± przekazanie w jednym kawa³ku.
\end{itemize}

Wiadomo¶ci MIME, które nie posiadaj± nag³ówka Content-type traktowane s± jako
wiadomo¶ci z nag³ówkiem ''Content-type: text/plain; charset=us-ascii''.

Bardzo istotnym nag³ówkiem jest nag³ówek Content-Transfer-Encoding, który
definiuje algorytm wg którego zakodowana zosta³a wiadomo¶æ (lub jej czê¶æ).
Transformacje zapisane w ramach nag³ówka to znane algorytmy kodowania i nie
zale¿± nigdy one od zewnêtrznych informacji (spoza wiadomo¶ci). Jedn±
z wa¿niejszych funkcji kodowania wiadomo¶ci jest mo¿liwo¶æ przes³ania
oryginalnie 8-bitowych danych za pomoc± 7-bitowych znaków US-ASCII.

Dostêpne formy kodowania wiadomo¶ci to:
\begin{itemize}
  \item 7bit - dane reprezentowane w postaci krótkich lini ze znakami US-ASCII
  \item 8bit - dane reprezentowane w postaci krótkich linni ale mog± wystêpowaæ
  znaki spoza US-ASCII
  \item binary - oprócz mo¿liwo¶ci wystêpowania znaków spoza US-ASCII mo¿e
  brakowaæ podzia³u na krótkie linie
  \item quoted-printable - szczegó³owy opis podany pó¼niej
  \item base64 - szczegó³owy opis podany pó¼niej
  \item ietf-token - forma kodowania wyspecyfikowana w okre¶lonym RFC i
  zarejestrowna w IANA (Internet Assigned Numbers Authority) (wcze¶niej IETF -
  Internet Engineering Task Force)
  \item x-token - programi¶ci mog± u¿yæ w³asnego kodowania w nag³ówku
  Content-Transfer-Encoding np. Content-Transfer-Encoding: x-my-new-encoding.
  Dodatkowe formy kodowania mog± byæ wyspecyfikowana w RFC. Wymogi takiej
  specyfikacji znajduj± siê w RFC 2048
\end{itemize}

Prawid³owy nag³ówek Content-Transfer-Encoding musi zostaæ u¿yty. Nadanie
wiadomo¶ci z 8-bitowymi danymi jako 7bit jest niedozwolone, za¶ niekodowane dane
musz± byæ ''oflagowane'' jako binary. Transfer niekodowanych danych
protoko³em SMTP jest obecnie uwa¿any jako niezgodny ze specyfikacj±.

W odró¿nieniu od typów i podtypów MIME tworzenie w³asnych nazw kodowañ dla
nag³ówka Content-Transfer-Encoding jest mocno odradzane.

Nag³ówek Content-Transfer-Encoding tyczy siê ca³ego cia³a wiadomo¶ci. Je¿eli
za¶ znajdzie siê w czê¶ci wiadomo¶ci to dotyczy tylko jej. Je¿eli wiadomo¶æ lub
jej czê¶æ jest typu multipart, wtedy Content-Transfer-Encoding mo¿e przyjmowaæ
tylko 7bit, 8bit lub binary.

Content-Transfer Encoding jest bezpo¶rednio powi±zany z drugim nag³ówkiem jakim
jest Content-Type, chocia¿ wydawa³oby siê, ¿e s± to ca³kowicie niezale¿ne
nag³ówki. Po pierwsze niektóre kodowania mog± byæ stosowne w przypadku
niektórych rodzajów typów MIME, jak choæby w przypadku 8bit-owego transportu
(je¿eli serwer SMTP udostêpnia tak± mo¿liwo¶æ) nie wymagany jest jakiekolwiek
kodowanie dla tekstu o okre¶lonym kodowaniu znaków, podczas gdy dla 7bit-owego
transportu tekstu takie kodowanie jest ju¿ niezbêdne, gdy¿ mog± wyst±piæ w nim
znaki spoza US-ASCII. Po drugie niektóre typy MIME wymagaj± ró¿nych typów
kodowania w zale¿no¶ci od warunków. Przyk³adowo wiele dokumentów PostScript
posiada krótkie linie z 7bit-owymi danymi i dlatego te¿ nie wymagaj± one
dodatkowego kodowania. Inne dokumenty PostScriptowe (szczególnie te u¿ywaj±ce
mechanizmu kodowania binarnego 2 poziomu) mog± byæ przekazane tylko przy pomocy
kodowania binary. I wreszcie po trzecie, ¶cis³a specyfikacja pomiêdzy typami
MIME, a kodowaniem skutecznie ³±czy specyfikacjê protoko³u aplikacji ze
specyfikacj± niskopoziomowego transportu.

Je¿eli jaka¶ wiadomo¶æ lub jej czê¶æ posiada nierozpoznawalny
Content-Transfer-Encoding musi byæ traktowana jakby warto¶æ nag³ówka
Content-Type wynosi³a\newline''application/octet-stream'' niezale¿nie od tego
jak± warto¶æ rzeczywi¶cie posiada ten nag³ówek.

Kodowanie Quoted-Printable pozostawia wszystkie bajty o warto¶ci mniejszej od
128, które nie s± znakami steruj±cymi ASCII (z wyj±tkiem znaku równo¶ci =) bez
zmian, a pozosta³e (z wyj±tkiem znaku tabulacji poziomej - HT, kod 9) zamienia
na napis zakodowany w ASCII reprezentuj±cy kod szesnastkowy danego bajtu
poprzedzony znakiem równo¶ci =. Sam znak równo¶ci w celu unikniêcia
wieloznaczno¶ci jest zastêpowany ci±giem =3D. Dodatkowe regu³y rz±dz±
kodowaniem koñców linii, m.in. ''miêkkim'' ³amaniem linii, oraz reprezentacj±
linii koñcz±cych siê bia³ymi znakami.

Base64 s³u¿y do kodowania ci±gu bajtów przy pomocy ci±gu znaków. Kodowanie to
przypisuje 64 wybranym znakom (patrz tabelka ni¿ej) warto¶ci od 0 do 63. Ci±g
bajtów poddawany kodowaniu dzielony jest na grupy po 3 bajty. Poniewa¿ bajt ma
8 bitów, grupa 3 bajtów sk³ada siê z 24 bitów. Ka¿d± tak± grupê dzieli siê
nastêpnie na 4 jednostki 6-bitowe. Istniej± wiêc dok³adnie 64 mo¿liw warto¶ci
ka¿dej takiej jednostki. Wszystkim tym jednostkom s± przypisywane znaki na
podstawie podanego ni¿ej arbitralnie ustalonego przypisania.
\newlines{
\begin{center}
\begin{tabular}{ | c | c | c | c | c | c | }
\hline
Warto¶æ & Znak & Warto¶æ & Znak & Warto¶æ & Znak \\ \hline
\hline
0 &	A & 22 & W & 44 & s  \\
1 &	B & 23 & X & 45 & t  \\
2 &	C & 24 & Y & 46 & u  \\
3 &	D & 25 & Z & 47 & v  \\
4 &	E &	26 & a & 48 & w  \\
5 &	F &	27 & b & 49 & x  \\
6 &	G &	28 & c & 50 & y  \\
7 &	H &	29 & d & 51 & z  \\
8 &	I & 30 & e & 52 & 0  \\
9 &	J & 31 & f & 53 & 1  \\
10 & K & 32 & g & 54 & 2 \\
11 & L & 33 & h & 55 & 3 \\
12 & M & 34 & i & 55 & 3 \\
13 & N & 35 & j & 56 & 4 \\
14 & O & 36 & k & 57 & 5 \\
15 & P & 37 & l & 58 & 6 \\
16 & Q & 38 & m	& 59 & 7 \\
17 & R & 39 & n & 60 & 8 \\
18 & S & 40 & o & 61 & 9 \\
19 & T & 41 & p & 62 & + \\
20 & U & 42 & q & 63 & / \\
21 & V & 43 & r & pad & = \\
\hline
\end{tabular}
\end{center}
}
Je¶li rozmiar wej¶ciowego ci±gu bajtów nie jest wielokrotno¶ci± liczby 3, to
stosowane jest dope³nianie (na koñcu wynikowego ci±gu dodawana jest taka ilo¶æ
symboli dope³nienia (pad), aby ten mia³ d³ugo¶æ podzieln± przez 4).

Widaæ, ¿e dane zakodowane przy pomocy base64 na maszynie, która u¿ywa
8-bitowego s³owa do reprezentacji znaków powiêkszaj± swój rozmiar o 33%.

Je¶li rozmiar wej¶ciowego ci±gu bajtów nie jest wielokrotno¶ci± liczby 3, to
stosowane jest dope³nianie (na koñcu wynikowego ci±gu dodawana jest taka ilo¶æ
symboli dope³nienia (pad), aby ten mia³ d³ugo¶æ podzieln± przez 4).

Widaæ, ¿e dane zakodowane przy pomocy base64 na maszynie, która u¿ywa
8-bitowego s³owa do reprezentacji znaków powiêkszaj± swój rozmiar o 33%.

Wspomnieæ te¿ nale¿y o nag³ówku Content-ID, który jest w zastosowaniu podobny
do Message-ID i pozwala na referencjê pomiêdzy ró¿nymi wiadomo¶ciami. Tak samo
jak Message-ID warto¶æ zawarta w Content-ID musi pozostaæ unikalna. 

Ostatnim dodatkowym nag³ówkiem jaki zawarty jest w standardzie MIME to
nag³ówek Content-Description. Warto¶æ tego nag³ówka to tekst US-ASCII. Opisuje
on po prostu cia³o danego za³±cznika np. ''rysunek Galaktyki Andromedy''.

Dodatkowe nag³ówki opisuj±ce za³±czniki mog± zostaæ w przysz³o¶ci zdefiniowane.
Nazwa ka¿dego nowego nag³ówka powinna rozpoczynaæ siê od ''Content-'' np.
''Content-Newone''. 

Jak by³o wcze¶niej wspomniane typ MIME multipart s³u¿y do tworzenia wiadomo¶ci
sk³adaj±cych siê z za³±czników ró¿nego rodzaju. Minimalnie mo¿e ona zawieraæ
jeden za³±cznik. Ka¿dy z nich poprzedzony jest lini± podzia³u (boundary line),
za¶ po ostatnim z za³±czników wystêpuje linia koñcz±ca. Po ka¿dej lini
rozpoczynaj±cej za³±cznik znajduj± siê nag³ówki okre¶laj±ce go (opisane
wcze¶niej), nastêpnie wystêpuje pusta linia, a za ni± znajduje siê cia³o.
Ze wzglêdu na posiadanie nag³ówków i cia³a za³±cznik podobny jest do wiadomo¶ci
zgodnej z RFC 822, jednak mo¿e on na przyk³ad nie zawieraæ nag³ówków. Taki
za³±cznik traktowany jest (podobnie jak wiadomo¶æ MIME bez nag³ówka
Content-Type) jako posiadaj±cy nag³ówek Content-Type typu text/plain;
charset=US-ASCII. Linia dziel±ca za³±czniki wiadomo¶ci nie mo¿e pojawiæ siê w
tek¶cie cia³a za³±cznika. Dlatego te¿ jest niezwykle istotne, aby
oprogramowanie klienckie tworzy³o wiadomo¶ci zawieraj±ce bardzo unikalne linie
podzia³u. Przyk³adowa linia podzia³u mo¿e wygl±daæ nastêpuj±co:
\combox{- - - -=\_NextPart\_001\_0064\_01C82582.9D9EB7E0}
Poni¿ej przyk³adowa wiadomo¶æ (ze wzglêdu na czytelno¶æ wiadomo¶ci niektóre
nag³ówki zosta³y usuniête, a za³±czniki zosta³y zmniejszone). Sk³ada siê ona z 2
za³±czników:

\begin{itemize}
  \item multipart/mixed z boundary \newline 
  - - - -=\_NextPart\_000\_0063\_01C82582.9D9C6DF0, który sam w sobie
  jest typu multipart/alternative (text/plain i text/html) z boundary \newline 
  - - - -=\_NextPart\_001\_0064\_01C82582.9D9EB7E0
  \item image/jpeg - zdjêcie w formacie jpeg
\end{itemize}

Tre¶æ wiadomo¶ci:
\comboxnonl{Date: Mon, 12 Nov 2007 23:20:30 +0100\newline
From: "jerzy\_bielecki" <jbielecki@klc.vectranet.pl>\newline
To: <redakcja@astronet.pl>\newline
MIME-Version: 1.0\newline
Message-ID: <006701c8257a$3d2100b0$45e7584e@compurbae2b8cf>\newline
Subject: Luna\newline
Content-Type: multipart/mixed;\newline
\hspace*{1cm}boundary="- - -
-=\_NextPart\_000\_0063\_01C82582.9D9C6DF0"\newline
\newline
This message is in MIME format. Since your mail reader does not
understand\newline
this format, some or all of this message may not be legible.\newline
\newline
- - - - - -=\_NextPart\_000\_0063\_01C82582.9D9C6DF0\newline
\newline
Content-Type: multipart/alternative;\newline
\hspace*{1cm} boundary="- - -
-=\_NextPart\_001\_0064\_01C82582.9D9EB7E0"\newline
\newline
This message is in MIME format. Since your mail reader does not understand\newline
this format, some or all of this message may not be legible.\newline
\newline
- - - - - -=\_NextPart\_001\_0064\_01C82582.9D9EB7E0\newline
\newline
Content-Type: text/plain;
\newline
\hspace*{1cm}charset="iso-8859-2"\newline
Content-Transfer-Encoding: quoted-printable\newline
\newline
Witam!\newline
\newline
Powi=EAkszy=B3em dodatkowo jasn=B1 "plamk=EA" i uczytelni=B3em filtrem grafi=\newline
cznym - interesuj=B1cy efekt ...\newline
Pomo=BFecie ?\newline
\newline
Pozdrawiam - Jerzy W. Bielecki\newline
\_\_\_\_\_\_\_\_\_\_\_\_}
\comboxnonl{Poczta sprawdzona przez G DATA AntiVirus\newline
Wersja: AVK 18.584 z 12.11.2007\newline
Informacje: www.gdata.pl\newline
\newline
- - - - - -=\_NextPart\_001\_0064\_01C82582.9D9EB7E0\newline
Content-Type: text/html;\newline
\hspace*{1cm}charset=''iso-8859-2''\newline
Content-Transfer-Encoding: quoted-printable\newline
\newline
<!DOCTYPE HTML PUBLIC ''-//W3C//DTD HTML 4.0 Transitional//EN''>\newline
<HTML><HEAD>\newline
<META http-equiv=Content-Type content=text/html;>\newline
<META content=''MSHTML 6.00.6000.16544'' name=GENERATOR>\newline
<STYLE></STYLE>\newline </HEAD>\newline
<BODY bgColor=\#ffffff>\newline
Witam!<BR>\newline
Powi=EAkszy=B3em dodatkowo jasn=B1 "plamk=EA" i uczytelni=B3em filtrem
grafi=<BR>\newline
cznym - interesuj=B1cy efekt ...<BR>\newline
Pomo=BFecie ?<BR>\newline
\newline
Pozdrawiam - Jerzy W. Bielecki<BR>\newline
\_\_\_\_\_\_\_\_\_\_\_\_<BR>\newline
Poczta sprawdzona przez G DATA AntiVirus<BR>\newline
Wersja: AVK 18.584 z 12.11.2007<BR>\newline
Informacje: www.gdata.pl<BR>\newline
\newline
\newline
</BODY></HTML>\newline
\newline
- - - - - -=\_NextPart\_001\_0064\_01C82582.9D9EB7E0- -\newline
}
\comboxnonl{
\newline
- - - - - -=\_NextPart\_000\_0063\_01C82582.9D9C6DF0
\newline
Content-Type: image/jpeg;\newline
\hspace*{1cm}name="IMG\_7661xLunaPlus.jpg"\newline
Content-Transfer-Encoding: base64\newline
Content-Disposition: attachment;\newline
\hspace*{1cm}filename="IMG\_7661xLunaPlus.jpg"\newline
\newline
/9j/4AAQSkZJRgABAQEASABIAAD/4RAXRXSSTaS\newline
hpZgAASUkqAAgAAAAJAA8BAgAGAAAAegAASasS\newline
AAAAgAAAABIBAwABAAAAAQAAABoBBQABAAS\newline
AgAUAAAAsAAAABMCAwABAAAAAQAAAGmHBA\newline
\newline
- - - - - -=\_NextPart\_000\_0063\_01C82582.9D9C6DF0- -
}

\subsection{Obecne wykorzystanie protoko³u i jego forma}

\subsubsection{SMTP-AUTH}
Protokó³ SMTP w obecnej formie wykorzystuje wiele rozszerzeñ, których powstanie
by³o naturalnym wynikiem rozwoju Internetu. Podstawowym brakiem protoko³u SMTP
w formie z RFC 2821 jest brak jakiejkolwiek autoryzacji czyli potwierdzenia
to¿samo¶ci klienta pod³±czaj±cego siê do serwera. Klient, który poprawnie
przejdzie proces autoryzacji mo¿e u¿yæ serwera, do którego jest
pod³±czony, w celach przekazania wiadomo¶ci (ang. relay). Serwer po przyjêciu
tej wiadomo¶ci jest odpowiedzialny za jej dostarczenie. Autoryzacja zapobiega m.in.
przed relay-owaniem poczty od nieautoryzowanych u¿ytkowników czyli tzw.
spammerów. Przyk³adowa sesja SMTP z poprawn± autoryzacj±:
\combox{S: 220 smtp.example.com ESMTP server ready\newline
C: EHLO jgm.example.com\newline
S: 250-smtp.example.com\newline
S: 250 AUTH CRAM-MD5 DIGEST-MD5\newline
C: AUTH FOOBAR\newline
S: 504 Unrecognized authentication type.\newline
C: AUTH CRAM-MD5\newline
S: 334 PENCeUxFREJoU0NnbmhNWitOMjNGNndAZWx3b29kLmlubm9zb=\newline
C: ZnJlZCA5ZTk1YWVlMDljNDBhZjJiODRhMGMyYjNiYmFlNzg2ZQ==\newline
S: 235 Authentication successful.
}
Widaæ wiêc, ¿e w ca³ej komunikacji pojawia siê dodatkowe polecenie AUTH. Serwer
najpierw informuje klienta, ¿e autoryzacja jest obs³ugiwana. Nastêpnie klient
korzysta z polecenia AUTH, którego sk³adnia jest nastêpuj±ca:
\combox{AUTH SPACE auth\_type [SPACE (base64 / "=")] *(CRLF [base64]) CRLF}
i próbuje dowiedzieæ siê jaka forma autoryzacji jest dostêpna. Serwer odpowiada
kodem 334 je¿eli dany typ autoryzacji obs³uguje lub 504 w przeciwnym wypadku. W
przypadku poprawnej odpowiedzi wysy³a on zakodowany base64 ci±g znaków, na
podstawie którego klient przesy³a inny ci±g znaków tak¿e zakodowany base64.
Ci±g ten z regu³y zawiera has³o i nazwê u¿ytkownika po³±czone z danymi
odkodowanymi z serwera. W przypadku prawid³owego ci±gu znaków od klienta serwer
dokonuje autoryzacji (odpowied¼ 235).

Mimo rozszerzenia SMTP-AUTH ca³y czas protokó³ SMTP nie daje gwarancji, ¿e
wiadomo¶æ pochodzi od osoby, za któr± podaje siê nadawce. Wystarczy przecie¿
z³amaæ has³o (w przypadku s³abych hase³) metod± brute-force i podszywaæ siê pod
dan± osobê.

\subsubsection{Phishing i obrona przed nieautoryzowanymi mailami}

Coraz czêstszym problemem jest te¿ phishing (zwany te¿ spoofingiem
\cite{e-mail-spoofing}). Polega on na konstruowaniu wiadomo¶ci, w których adres nadawcy (podany w nag³ówku) oraz
jej inne czê¶ci s± tak spreparowane jakby wydawa³y siê mailem z innego ¼ród³a.
Najczê¶ciej zmienianymi nag³ówkami s± From, Return-Path, Reply-To. Maile takie
najczê¶ciej powi±zane s± z tzw. phishingiem webowym. Polega to na spreparowaniu
wiadomo¶ci i zawarciu w niej odniesienia do strony internetowej, która
przypomina nam znan± strone internetow±, któr± jest równie¿ odpowiednio
spreparowana. Czêsto wiadomo¶ci te próbuj± podszywaæ siê pod wiadomo¶ci
przesy³ane nam z naszych banków, a linki w nich zawarte prowadz± do stron
przypominaj±cych strony logowañ do systemu bankowego. Po zalogowaniu siê na
takiej stronie internata staje siê ofiar±, poniewa¿ jego login i has³o
przekazywane jest osobom, które spreparowa³y maila, jak i stronê internetow±.

Aby zapobiec takim sytuacjom powsta³y rozszerzenia, których celem jest
potwierdzenie to¿samo¶ci nadawcy wiadomo¶ci. Podobn± funckjê spe³niaj± na
przyk³ad certyfikaty na szyfrowanych stronach internetowych. Niektóre z tych
rozszerzeñ to:

\begin{itemize}
  \item SPF - Sender Policy Framework - uwierzytelnia tylko adres MAIL
  FROM.\newline
  Sprawdza, czy e-mail przychodz±cy z danego serwera pocztowego
  mo¿e stosowaæ okre¶lon± nazwê domenow± w MAIL FROM. Opiera siê na infrastrukturze
  DNS oraz rekordach TXT
  \item DKIM - DomainKeys Identified Mail - uwierzytelnia tre¶æ i niektóre
  nag³ówki wiadomo¶ci.\newline
  Opiera siê na cyfrowym podpisywaniu tre¶ci wiadomo¶ci i czê¶ci nag³ówków
  (podpis w oddzielnym nag³ówku) oraz infrastrukturze DNS do dystrybucji kluczy
  publicznych. Powsta³ z po³±czenia Yahoo! DomainKeys i Cisco Identified Internet Mail.
  \item CSV - Certified Server Validation - uwierzytelnia tylko parametr
  polecenia HELO/EHLO.\newline
  Okre¶la poziom zaufania przy po³±czeniu nadchodz±cym z innego MTA na
  podstawie jego adresu IP oraz parametru polecenia HELO lub EHLO. Stosuje
  infrastrukturê DNS oraz rekordy SRV.
  \item Microsoft Sender ID - uwierzytelnia MAIL FROM oraz From.\newline
  Syntaktycznie zgodny z SPF. Rozszerza u¿ycie SPF do nag³ówków From:. Oparty
  na SPF oraz propozycji Microsoftu z 2004 r.: Caller ID for E-Mail.
\end{itemize}

W obecnej formie ka¿da z powy¿szych propozycji (prócz ma³o efektywnego i
praktycznie niestosowanego CSV) wprowadza powa¿ne ograniczenia w u¿ywaniu
poczty.

Wiêkszo¶æ wymusza stosowanie wybranych rozwi±zañ na administratorach
serwerów, które kontaktuj± siê z chronionym serwerem. ¯adna z nich nie
jest natomiast standardem, a implementacja zmian jest czêsto k³opotliwa
(np. nie ka¿dy MTA umo¿liwia stosowanie SRS). Skuteczno¶æ powy¿szych rozwi±zañ
jest zbyt niska w porównaniu z ograniczeniami, jakie wprowadzaj±. Redukuj± spam
i ataki wirusów w stopniu mniejszym, ni¿ inne rozwi±zania które nie maj± tak
powa¿nych efektów ubocznych (np. greylisting).

\subsubsection{Pipelining}

Wa¿nym rozszerzeniem protoko³u SMTP jest opisany w RFC 1854 tzw. pipelining.
Pipeling jest cech± komunikacji w ramach protoko³u polegaj±c± na wykonaniu
kilku ¿±dañ na raz, bez czekania na poszczególne odpowiedzi z serwera. 

\begin{center}
\includegraphics[scale=0.6]{pipelining_.png}
\begin{small}
\newline
\textit{Porównanie normalnej komunikacji z komunikacj± z pipeliningiem}
\end{small}
\end{center}

Serwer SMTP informuje klienta, ¿e obs³uguje rozszerzenie pipeliningu poprzez
zawarcie s³owa kluczowego PIPELINING w odpowiedzi na EHLO klienta. Klient, je¿eli
potrafi obs³ugiwaæ to rozszerzenie, mo¿e trasmitowaæ grupy komend bez
oczekiwania na rezultat ka¿dej z nich. Polecenia RSET, MAIL FROM, SEND FROM,
SOML FROM, SAML FROM i RCPT TO mog± wystêpowaæ dowolnie w grupie, za¶ EHLO, DATA,
VRFY, EXPN, TURN, QUIT oraz NOOP wystêpuj± jako ostatnie, poniewa¿ powodzenie
tych poleceñ lub b³±d w nich powoduj± zmianê stanu, na któr± reaguje klient.
Dodatkowe polecenia wprowadzone przez rozszerzenia protoko³u tak¿e wystêpuj±
jako ostatnie, chyba ¿e ich specyfikacje okre¶laj± dodatkowe mo¿liwo¶ci.

Klient, który implementuje pipelining musi sprawdziæ wszystkie statusy
odpowiedzi z serwera SMTP. Przyk³adowo je¿eli odpowiedzi± serwera na RCPT TO
bêdzie brak akceptacji dla adresu, klient musi sprawdziæ status odpowiedzi
DATA. Nie mo¿e on zak³adaæ, ¿e polecenie DATA nie zostanie zaakceptowane w
wyniku braku akceptacji polecenia RCPT TO. 

Przyk³adowa sesja z u¿yciem pipeliningu ma nastêpuj±c± postaæ:
\combox{S: <wait for open connection>\newline
C: <open connection to server>\newline
S: 220 innosoft.com SMTP service ready\newline
C: EHLO dbc.mtview.ca.us\newline
S: 250-innosoft.com\newline
S: 250 PIPELINING\newline
C: MAIL FROM:<mrose@dbc.mtview.ca.us>\newline
C: RCPT TO:<ned@innosoft.com>\newline
C: RCPT TO:<dan@innosoft.com>\newline
C: RCPT TO:<kvc@innosoft.com>\newline
C: DATA\newline
S: 250 sender <mrose@dbc.mtview.ca.us> OK\newline
S: 250 recipient <ned@innosoft.com> OK\newline
S: 250 recipient <dan@innosoft.com> OK\newline
S: 250 recipient <kvc@innosoft.com> OK\newline
S: 354 enter mail, end with line containing only "."\newline
...\newline
C: .\newline
C: QUIT\newline
S: 250 message sent\newline
S: 221 goodbye\newline
}

\subsubsection{Szyfrowanie}

Komunikacja pomiêdzy klientem, a serwerem w protokole SMTP odbywa siê za pomoc±
komend przesy³anych otwartym tekstem. W wielu przypadkach wiadomo¶æ
transportowana jest przez wiele routerów i serwerów, co do których mo¿emy nie
mieæ zaufania. Mo¿e nast±piæ przechwycenie informacji, albo jej zmiana.

Próba rozwi±zania tego problemu doprowadzi³a do powstania mechanizmu TLS,
bardziej znany jako SSL, który rozszerza komunikacjê TCP o ochronê prywatno¶ci
i autentykacjê.

W celu obs³u¿enia TLS-u stworzono rozszerzenie do protoko³u SMTP i wprowadzono
dodatkowe polecenie STARTTLS (RFC 2487 \cite{rfc-2487}). Odpowiedzi klienta na
tê komendê mog± byæ nastêpuj±ce:

\begin{itemize}
  \item \comboxinitemizenonl{220 Ready to start TLS}
  \item \comboxinitemizenonl{501 Syntax Error (no parameters allowed) w
  przypadku gdy do bezparametrowego polecenia STARTTLS klint poda³ parametr}
  \item \comboxinitemizenonl{454 TLS not available due to temporary reason}
\end{itemize}

W przypadku otrzymania odpowiedzi 220 klient powinien zacz±æ negocjacje TLS
przed wszystkimi innymi poleceniami. Po negocjacji TLS (szczegó³y dzia³ania
rozszerzenia TLS w wersji 1.0 zwarte jest w RFC 2246 \cite{rfc-2246}, obecnie
rozwijana jest wersja 1.1 opisana w RFC 4346 \cite{rfc-4346}) obie strony uzgadniaj± czy
kontynuowaæ dalsz± komunikacjê. W przypadku niepowodzenia autentykacji lub szyfrowania i tak mo¿e
nast±piæ do dalszej komunikacji klient-serwer i akceptacji przez serwer
wiadomo¶ci. Je¿eli serwer stwierdzi, ¿e wynegocjowany poziom zaufania jest zbyt
niski powinien przes³aæ klientowi komendê SMTP QUIT. 

Przyk³adowa sesja z uwzglêdnieniem negocjacji TLS mo¿e przyjmowaæ nastêpuj±c±
postaæ:
\combox{S: <waits for connection on TCP port 25>\newline
C: <opens connection>\newline
S: 220 mail.imc.org SMTP service ready\newline
C: EHLO mail.ietf.org\newline
S: 250-mail.imc.org offers a warm hug of welcome\newline
S: 250 STARTTLS\newline
C: STARTTLS\newline
S: 220 Go ahead\newline
C: <starts TLS negotiation>\newline
C \& S: <negotiate a TLS session>\newline
C \& S: <check result of negotiation>\newline
C: <continues by sending an SMTP command>\newline
. . .
}
Nale¿y jednak zaznaczyæ, ¿e je¿eli komunikacja pomiêdzy klientem, a serwer by³a
przeprowadzona przy u¿yciu TLS-u, nie oznacza to, ¿e ca³y transport wiadomo¶ci
by³ szyfrowany. Po drodze niestety mo¿e doj¶æ do nieszyfrowanego lub
nieautoryzowanego przekazywania wiadomo¶ci.

\newpage

\section{Wspó³czesne narzêdzia filtracji protoko³u SMTP}

\subsection{Konieczno¶æ wprowadzenia filtracji}

Konieczno¶æ wprowadzenia filtracji w pierwszej kolejno¶ci zauwa¿ono w
organizacjach, w których maile by³y wa¿nym kana³em wymiany informacji. Pierwsz±
niedogodno¶ci, która sta³a siê odczuwalna przy korzystanie z protoko³u SMTP
by³a oczywi¶cie niechciana poczta. \textbf{Spam}, bo o nim mowa,
rozprzestrzeni³ siê na tak± skalê, ¿e brak jego filtracji powodowa³ i¿
u¿ytkownicy tonêli w mailach o nieporz±danej tre¶ci. 

Przy du¿ych ilo¶ciach wiadomo¶ci istotnym w organizacjach sta³o siê równie¿
\textbf{zarz±dzanie} poczt± czyli m.in. odpowiednia segregacja maili w celach
u³atwienia ich przegl±dania, archiwizacja wiadomo¶ci czy backupowanie skrzynek.

Kolejnym wa¿nym elementem w organizacjach jest mo¿liwo¶æ spojrzenia na
wiadomo¶ci e-mail z szerszej perspektywy. Umo¿liwiaj± to modu³y/oprogramowanie do
\textbf{raportowania}. Raporty nie tylko daj± wgl±d w historie i aktualny stan
poczty w organizacji, ale pozwalaj± przewidywaæ przysz³o¶æ poczty w firmie i
pomagaj± wcze¶niej podj±æ strategiczne decyzje. 

Wspó³cze¶nie niezbêdnym elementem ka¿dej organizacji jest ochrona danych
znajduj±cych siê wewn±trz firmy (ang. DLP - Data Loss Prevention \cite{dlp}). W
ramach protoko³u SMTP DLP polega m.in. na blokowaniu wiadomo¶ci wychodz±cych z
organizacji uznanych za poufne. Przyk³adowa wiadomo¶æ, która mo¿e byæ
zakwalifikowana jako poufna to taka, które w stopce zawiera tre¶æ ''Company
Confidential''.

\subsection{Produkty komercyjne}

Obecnie na rynku znajduje siê sporo produktów s³u¿±cych do filtracji w ramach
protoko³u SMTP. Niektóre z nich s± czê¶ci± wiêkszych projektów, inne zosta³y
zaprojektowane tylko w tym celu.

\subsubsection{Clearswift - MIME sweeper for SMTP}

MIMEsweeper for SMTP to bardzo wyrafinowany system do zarz±dzania poczt± email.
Wed³ug twórców systemu ¿aden inny system nie oferuje tak obszernych mo¿liwo¶ci
kompleksowego zarz±dzania infrastruktur± maili. Obecny produkt firmy Clearswift
sta³ siê idealnym rozwi±zaniem dla firm, które pragn± w pe³ni ochroniæ
komunikacjê e-mail.

Firma Clearswift zajmuje siê sektorem zabezpieczeñ komunikacyji i dostarcza
filtry emailowe i webowe dla oko³o 25 milionów u¿ytkowników skupionych wokó³ 17
tysiêcy firm. Zosta³a za³o¿ona w roku 1982, a jej obecna siedziba mie¶ci siê w
Theale, niedaleko Reading w Wielkiej Brytani.

Dwie najwa¿niejsze funkcjonalno¶ci jakie dostarcza MIMEsweeper for SMTP to:
\begin{itemize}
  \item Routowanie i relayowanie wiadomo¶ci w ramach SMTP w zale¿no¶ci od
  zdefiniowanych zasad
  \item Procesowanie wiadomo¶ci w ramach domeny w oparciu o zdefiniowane zasady
  bezpieczeñstwa
\end{itemize}

W ramach polityki bezpieczeñstwa firmy MIMEsweeper umo¿liwia skonfigurowanie
wielu zasad bezpieczeñstwa, które zosta³y podzielone na 3 g³ówne typy:
\begin{enumerate}
  \item Polityka deploymentu - okre¶la ona sposób implementacji MIMEsweepera w
  danej sieci. Zale¿na jest ona od:
  \begin{itemize}
    \item architektury sieci w ramach okre¶lonej domeny
    \item sposobu pod³±czenia sieci do Internetu
    \item ilo¶ci osób zarz±dzaj±cych polityk± bezpieczeñstwa i samym systemem
    \item elastyczno¶ci systemu
  \end{itemize}
  \item Polityka routowania i relayowania poczty. Mo¿na tutaj okre¶liæ:
  \begin{itemize}
  	\item z jakich hostów bêdziemy akceptowaæ maile
  	\item jakie hosty mog± ³±czyæ siê do naszego serwera i u¿ywaæ go do
  	relayowania poczty
  	\item z jakich hostów albo adresów poczty nie przyjmujemy
  	\item dozwolon± ilo¶æ odbiorców
  	\item dozwolon± wielko¶æ wiadomo¶ci email
  	\item ilo¶æ wiadomo¶ci email jakie MIMEsweeper mo¿e jednocze¶nie przetwarzaæ
  \end{itemize}
  \item Polityka ochrony zawarto¶ci. Okre¶la ona regu³y przetwarzania przez
  system maili takie jak:
  \begin{itemize}
    \item kto mo¿e wysy³aæ i odbieraæ maile
    \item dok±d maile mog± byæ wysy³ana albo sk±d odbierane
    \item jaki rodzaj wiadomo¶ci wykryæ
    \item jaki rodzaj tekstu i jakie obiekty analizowaæ w wykrytych
    wiadomo¶ciach
    \item jaki rodzaj akcji podj±æ po analizie
    \item co zg³osiæ po wykryciu maila
    \item jakie informacje o systemie ¶ledziæ
    \item jakie przetwarzane wiadomo¶ci ¶ledziæ
    \item jak± analizê zawarto¶ci i jej wykrycie ¶ledziæ
  \end{itemize}
\end{enumerate}

Ca³o¶æ oprogramowania MIMEsweeper podzielona jest na serwisy, które umo¿liwiaj±
realizacjê wcze¶niej wymienionych zadañ. Serwisy te to:

\begin{itemize}
  \item serwis odbieraj±cy - zgodnie z ustalonymi zasadami polityki
  bezpieczeñstwa waliduje przychodz±ce po³±czenie, odbiera maila i przekazuje
  do serwisu zabezpieczeñ do dalszego procesowania
  \item serwis zabezpieczeñ - sprawdza zawarto¶æ maila i konfrontuje go z
  skonfigurowan± wcze¶niej polityk± bezpieczeñstwa
  \item serwis dostarczaj±cy - przekazuje pocztê do odbiorców
  \item serwis odpowiedzialny za infrastrukturê - zajmuje siê monitorowaniem
  systemu, konfiguracj± i kontrol± zadañ nie objêtych przez inne serwisy
  \item serwis analityczny - z³o¿onych z dwóch odrêbnych serwis. Pierwszy z
  nich zbiera dane o systemie i przekazuje je do drugiego serwisu
  odpowiedzialnego za stworzenie z nich bazy danych w odpowiedniej postaci
  \item system ¶ledzenia - odpowiedzialny za zbieranie wszystkich danych,
  których wcze¶niej zosta³y zdefiniowane w systmie do ¶ledzenia
\end{itemize}

\begin{center}
\hspace*{1.5cm}\includegraphics[scale=0.6]{mimesweeper_services.png}
\begin{small}
\newline
\textit{Schemat przetwarzania wiadomo¶ci w programie MIMEsweeper}
\end{small}
\end{center}

\subsubsection{Aladdin - eSafe Mail}

eSafe firmy Aladdin \cite{aladdin-esafe} to bardzo elastyczne i ³atwe w
zarz±dzaniu rozwi±zanie dla mniejszych i wiêkszych systemów informatycznych. Pozwala na instalacjê w wielu
konfiguracjach w zale¿no¶ci od potrzeb klienta. eSafe zawiera wiele modu³ów w
tym 2 istotne dotycz±ce protoko³u SMTP:
\begin{itemize}
  \item eSafe Mail - kompleksowa ochrona wiadomo¶ci email
  \item Advanced Antispam - filtr niechcianej poczty. Wysy³a na bie¿±co
    zapytania o weryfikacjê reputacji nadawcy, klasyfikuj±c na tej podstawie
    pocztê oraz nadawców i ewentualnie blokuj±c przes³anie szkodliwej
    zawarto¶ci do adresata. Uzyskiwana skuteczno¶æ osi±gnê³a w tym wzglêdzie
    poziom 98\% przy czym badania nowego rozwi±zania wykazuj±, ¿e zakres
    b³êdu (np. zatrzymanie oczekiwanej poczty lub poczty nie bêd±cej spamem)
    wynosi 0,05\%.
\end{itemize}

Produktem zwi±zanym z filtracj± SMTP w ramach projektu eSafe, pomijaj±c
dodatkowy modu³ do zaawansowanego zarz±dzania polityk± antypsamow± Advance
Antispam, jest oczywi¶cie eSafe Mail. Sercem tego produktu jest Dual Engine
Email Security. 

Ten dualny silnik pracuje w trybie czasu rzeczywistego - jego zadaniem jest
b³yskawiczna weryfikacja reputacji nadawcy wiadomo¶ci i poddanie analizie
wzorców dystrybucji przychodz±cych maili. Rozwi±zanie monitoruje ruch w
¶wiatowym Internecie pod k±tem wykrywania podejrzanych, masowych maili, badaj±c
przede wszystkim kluczowe punkty przep³ywu poczty elektronicznej, m.in. w¶ród
dostawców Internetu (ISP). Dziêki temu rozwi±zaniu eSafe mo¿e najszybciej jak
to mo¿liwe zidentyfikowaæ spam oraz z³o¶liwe oprogramowanie, zanim trafi± one
do firmowej sieci. Narzêdzie monitoruje masowo wysy³ane wiadomo¶ci pod k±tem
zagro¿enia spamem, phishingiem, z³o¶liwymi kodami, jednocze¶nie bez blokowania
np. tak¿e masowo wysy³anych i subskrybowanych newsletterów.
W po³±czeniu z dualnym silnikiem antyspamowaym wspomnianym wcze¶niej (Advance
Antispam), rozwi±zanie eSafe staje siê potê¿nym narzêdziem do ochrony poczty
email.

\subsubsection{Surfcontrol - E-mail Filter}

Pakietu E-mail Filter firmy Surfcontrol \cite{surfcontrol} to system
kompleksowego zarz±dzania poczt± elektroniczn±. Dostêpny jest jako samodzielna brama SMTP lub jako
rozszerzenie do serwera poczty Exchange firmy Microsoft. Oprogramowanie to
umo¿liwia:
\begin{itemize}
  \item opanowanie spamu
  \item ochronê danych poufnych
  \item filtrowanie obra¼liwych tre¶ci
  \item dodawanie kolejnych warstw ochronnych przed wirusami
  \item optymalizacjê zasobów serwera pocztowego
\end{itemize}

Oprogramowanie E-mail Filter umo¿liwia w ramach administracji polityk±
bezpieczeñstwa m.in.:
\begin{itemize}
  \item tworzenie regu³ tej polityki za pomoc± kreatora regu³
  metod± drag-and-drop
  \item wyodrêbnianie, usuwanie, opó¼nianie lub wysy³anie do adresata dowolnej
  przesy³ki, która narusza wcze¶niej zdefiniowane regu³y
  \item przegl±danie zawarto¶ci poczty przez administratorów
  \item wprowadzenie filtrowania sieci na poziomie przedsiêbiorstwa z
  mo¿liwo¶ci± zdalnego zarz±dzania
  \item automatyczne powiadamianie wyznaczonej osoby o próbie naruszenia
  polityki
  \item generowanie raportów w zale¿no¶ci od potrzeb u¿ytkownika
  \item filtrowanie poczty wewnêtrznej (tylko w przypadku serwera Exchange 5.5)
  oraz wiadomo¶ci przychodz±cych/wychodz±cych
\end{itemize}

Filtrowanie tre¶ci wiadomo¶ci wykorzystuje jeden z najobszerniejszych  w bran¿y
s³ownik w celach sugerowania potencjalnie obra¼liwych, istotnych dla firmy,
zastrze¿onych lub innych tre¶ci wysokiego ryzyka.

Firma Surfcontrol udostêpnia dodatkowe modu³y do oprogramowania E-Mail Filter.
S± nimi:
\begin{itemize}
  \item Anti-Spam Agent - chroni firmê przed spamem
  \item Virtual Learning Agent - chroni przed przypadkowym lub zamierzonym
  wys³aniem poczty zawieraj±cej zastrze¿one dane
  \item Virtual Image Agent - w oparciu o wprowadzone kryteria, filtruje
  niew³a¶ciwe obrazki zawieraj±ce tre¶ci dla doros³ych
  \item Anti-Virus Agent - skaner antywirusowy, który ochroni organizacjê
  przed plag± wirusów w przesy³kach pocztowych
\end{itemize}

\subsubsection{Oprogramowanie antywirusowe z modu³ami do filtracji SMTP}

Obecnie du¿a czê¶æ oprogramowania antywirusowego udostêpnia modu³y, które s±
odpowiedzialne za ochronê poczty e-mail. Jednym z producentów oprogramowania
antywirusowego z takimi modu³ami jest firma TrendMicro, która udostêpnia
produkty \textbf{InterScan VirusWall} oraz dla ma³ych i ¶rednich przedsiêbiorstw
\textbf{InterScan VirusWall for Small and Medium Business}. Zapewniaj± one
kompletn± ochronê antywirusow± i antyspamow± dla poczty (POP3, SMTP), dla
bramki internetowej (HTTP, FTP) oraz filtrowanie tre¶ci wiadomo¶ci oraz stron WWW. Drugim produktem firmy TrendMicro dotycz±cym poczty jest 
program \textbf{InterScan Messaging Security Suite}. Udostêpnia on ochronê przed
wirusami rozprzestrzeniaj±cymi siê za po¶rednictwem poczty elektronicznej.
Skanuje w czasie rzeczywistym ruch SMTP i POP3 przechodz±cy przez bramkê
internetow±. InterScan Messaging Security Suite chroni ¶rodowisko poczty
elektronicznej przed wszystkimi rodzajami wirusów, w tym przed wirusami
powoduj±cymi masowe, niekontrolowane rozsy³anie poczty elektronicznej, jak
równie¿ przed przedostawaniem siê wa¿nych informacji na zewn±trz.

Innym producentem antywirusowego oprogramowania, o którym warto wspomnieæ jest
firma F-Secure. W¶ród jej licznych produktów znajduje siê program \textbf{F-Secure
Anti-Virus Client Security} zawieraj±cy prze¼roczysty dla u¿ytkownika skaner
ruchu SMTP i POP3 \textbf{F-Secure E-mail Scanning}.

\subsection{Produkty open-source}

Oprócz produktów komercyjnych na rynku znajduj± siê te¿ produkty darmowe. 

\subsubsection{Amavisd-new i dodatkowe filtry}

Amavisd-new \cite{amavisd} to wysokiej jako¶ci interfejs pomiêdzy MTA, a
filtrami zawarto¶ci: skanerem wirusów i filtrem spamu. Oprogramowanie napisane jest w jêzyku Perl.
Komunikuje siê z MTA poprzez (E)SMTP lub LMTP (Local Mail Transfer Protocol)
albo przy pomocy innego dodatkowego oprogramownia. 
Czêstymi filtrami zawarto¶ci u¿ytymi wraz z amavisd-new s± chocia¿by
SpammAssassin do walki ze spamem oraz skaner antywirusowy ClamAV.
SpamAssassin to napisany g³ównie w perlu zestaw skryptów do skanowania
zawarto¶ci poczty elektronicznej i oceny prawdopodobieñstwa czy dana wiadomo¶æ
jest spamem, czy te¿ nie. W swoich oznaczeniach program stosuje metodê
punktow±, gdzie im wy¿sza ocena, tym wiêksze prawdopodobieñstwo ¿e tre¶æ
wiadomo¶ci jest niepo¿±dana. Posiada mo¿liwo¶æ ''uczenia siê'' wiadomo¶ci
chcianych i nie chcianych co przy zastosowaniu odpowiedniej ilo¶ci
przyk³adowych wiadomo¶ci pozwala na osi±gniêcie ca³kiem zadowalaj±cych efektów
filtracji.
Clam AntiVirus jest zestawem narzêdzi antywirusowych dla systemów UNIX,
dostêpnym na licencji GPL oraz zaprojektowanym z my¶l± o skanowaniu wiadomo¶ci
e-mail na poziomie serwerów pocztowych. Pakiet dostarcza wielu narzêdzi, takich
jak elastyczny i skalowalny wielow±tkowy demon, skaner z linii poleceñ, i
zaawansowane narzêdzie do automatycznych aktualizacji baz sygnatur wirusów.
G³ównym elementem pakietu jest silnik antywirusowy, dostêpny w formie
wspó³dzielonej biblioteki.

\subsubsection{Smtp vilter}

Smtp-vilter to filtr zawarto¶ci dla serwera smtp sendmail. Potrafi on wykryæ
wiadomo¶ci z wirusami oraz spam. Wykryte na podstawie regu³ wiadomo¶ci mog±
zostaæ przepuszczone, odrzucone lub zaznaczone. Filtr opiera siê na dodatkowym
oprogramowaniu do skanowania zawarto¶ci. Komunikacja z sendmail odbywa siê
poprzez milter API.

\newpage

\section{Opracowany filtr poczty SMTP}

Przedstawione powy¿ej oprogramowanie komercyjne to bardzo du¿e systemy, w
których filtrowanie wiadomo¶ci jest jednym z mniejszych programów lub modu³ów.
Oprogramowanie to oczywi¶cie nie jest za darmo i czêsto zakupienie i wdro¿enie
takiego systemu wi±¿e siê z niema³ymi kosztami. Firmy, które nie mog± pozwoliæ
sobie na takie rozwi±zanie czêsto wybieraj± wspomniane produkty open-sourcowe.
Produkty te jednak nie s± kompletne, czêsto zale¿ne s± od dodatkowych
programów. Rozwój ich nie jest tak dynamiczny, jak w przypadku produktów
komercyjnych, i czêsto spoczywa na g³owie tylko kilku programistów. Dlatego
powsta³a idea stworzenia w³asnego oprogramowania zwi±zanego z filtracj±
protoko³u SMTP. Za jêzyk programowania s³u¿±cy do implementacji projektu
zosta³a wybrany Java.

\subsection{Za³o¿enia projektu}

G³ównym zadaniem oprogramowania jest udostêpnienie mo¿liwo¶ci
segregacji wiadomo¶ci na podstawie zdefiniowanych regu³. Regu³y pozwalaj± na
okre¶lenie jakie elementy wiadomo¶ci maj± byæ analizowane i jakie akcje podj±æ
po analizie. Komunikacja z oprogramowaniem odbywa siê poprzez protokó³ SMTP -
klient pragn±cy wys³aæ wiadomo¶æ do hosta X komunikuje siê najpierw z filtrem i
jemu przekazuje wiadomo¶æ. Wiadomo¶æ taka zostaje poddana analizie i ewentualnie
odrzucona lub przes³ana do hosta docelowego.

\subsection{Modu³y projektu}

Filtr sk³ada siê z nastêpuj±cych modu³ów:
\begin{itemize}
  \item odbieraj±cego i wysy³aj±cego
  \item parsera wiadomo¶ci
  \item parser regu³
  \item analizatora wiadomo¶ci
  \item kolejki
\end{itemize}

Ogólny schemat przep³ywu wiadomo¶ci w filtrze jest nastêpuj±cy:
\begin{enumerate}
  \item Wiadomo¶æ jest odbierana przez modu³ do odbierania wiadomo¶ci, a
  nastêpnie trafia do kolejki przychodz±cej
  \item Wiadomo¶ci z kolejki pobierane s± i przekazywane do analizatora.
  Wiadomo¶ci analizowane s± wspó³bie¿nie, a ilo¶æ ich jednocze¶nie
  procesowanych zale¿y od konfiguracji filtra.
  \item Analizator jest ¶cisle zwi±zany z parserem wiadomo¶ci oraz parserem
  regu³. Wyniki parsowania wiadomo¶ci i parsowania regu³ s± przekazywane do
  analizatora w postaci odpowiednio zdefiniowanych struktur. Na tej podstawie
  analizator decyduje jak± akcjê podj±æ. Mo¿liwe s± 3 scenariusze:
  \begin{itemize}
    \item wiadomo¶æ zostanie zatrzymana przez filtr
    \item wiadomo¶æ zostanie przepuszczona i przekazana dalej bez ¿adnych zmian
    \item wiadomo¶æ zostanie przepuszczona, a jej struktura ulegnie zmianie -
    dodane zostan± odpowiednie nag³ówki
  \end{itemize}
  \item W przypadku przepuszczenia wiadomo¶ci przekazywana jest ona do kolejnej
  kolejki wychodz±cej
  \item Wiadomo¶ci z kolejki wychodz±cej obs³ugiwane s± przez modu³ wysy³aj±cy.
  Zajmuje siê on wyjmowaniem wiadomo¶ci z kolejki i wysy³aniem ich do hosta
  docelowego. Wiadomo¶ci z tej kolejki obs³ugiwane s± wspó³bie¿nie, a liczba
  równocze¶nie procesowanych wiadomo¶ci zale¿y od konfiguracji filtra. Gdy
  wiadomo¶æ zostanie poprawnie wys³ana usuwana jest z kolejki. W przypadku
  nieudanego wys³ania wiadomo¶ci jest ona tak¿e usuwana z kolejki - wielokrotne
  próby wys³ania wiadomo¶ci nie s± obs³ugiwane.
\end{enumerate}

\begin{center}
\includegraphics[scale=0.32]{filtr.png}
\begin{small}
\newline
\textit{Schemat modu³owy filtra}
\end{small}
\end{center}

\subsubsection{Parser wiadomo¶ci}

Parser wiadomo¶ci to g³ówna czê¶æ projektu - najbardziej wymagaj±ca
programistycznie i najistotniejsza w sensie dalszej analizy wiadomo¶ci. Na jego
potrzeby stworzone zosta³y nastêpuj±ce struktury (wyra¿one klasami w jêzyku
Java):
\begin{itemize}
  \item MimeMessage - g³ówna klasa reprezentuj±ca wiadomo¶æ email (typu MIME).
  Klasa ta posiada referencjê na listê obiektów typu MimeMessageHeader
  reprezentuj±c± nag³ówki wiadomo¶ci oraz referencjê do obiektu klasy Part 
  \item Part - jest to abstrakcyjna klasa, z której dziedzicz± MimePart oraz
  MimeMultiPart. Instancje tej klasy reprezentuj± cia³o (czê¶æ) wiadomo¶ci,
  które nastêpuje po nag³ówkach
  \item MimePart - klasa ta reprezentuje czê¶ci wiadomo¶ci MIME prostego typu -
  przyk³adowo text/html. Instancja obiektu MimePart jest tworzona zarówno w
  przypadku, gdy podstawowy typ wiadomo¶ci jest prosty, jak i w przypadku
  prostego typu za³±czników. Przez podstawowy typ wiadomo¶ci rozumiany jest typ
  podany w g³ównych (czyli znajduj±cych siê przed cia³em wiadomo¶ci) nag³ówkach
  wiadomo¶ci
  \item MimeMultiPart - klasa ta reprezentuje za³±cznik wiadomo¶ci typu
  multipart. Klasa posiada jedynie referencje do obiektów typu MimePart oraz
  najbardziej charakterystyczn± informacjê dla typu multipart jak± jest
  boundary. W klasie tej znajduje siê g³ówna metoda do parsowania wiadomo¶ci,
  która na podstawie boundary rekursywnie wyodrêbnia za³±czniki z wiadomo¶ci
  \item MimeMessageHeader - klasa reprezentuj±ca nag³ówek wiadomo¶ci. Sk³ada
  siê z nazwy nag³ówka oraz cia³a nag³ówka.
  \item MimeMessageHeaders - klasa reprezentuj±ca listê nag³ówków wiadomo¶ci.
  Oprócz referencji do nich zawiera g³ówn± metodê parsuj±c± nag³ówki z
  uwzglêdnieniem foldingu.
\end{itemize}

Oprócz tych najwa¿niejszych klas reprezentuj±cych odpowiednie elementy z
wiadomo¶ci istotne by³o zaprojektowanie tak¿e klas pomocniczych. Klasy te to:
\begin{itemize}
  \item Preamble - reprezentuje preambu³ê czyli tekst znajduj±c± siê pomiêdzy
  za³±cznikami nag³ówkami wiadomo¶ci typu multipary, a nag³ówkami wiadomo¶ci
  \item ContentType - klasa reprezentuj±ca nag³ówek content-type. Zawiera
  metodê, która odtwarza nag³ówek do postaci prostej, je¿eli jego fragmenty s±
  podzielone na czê¶ci. Umo¿liwia tak¿e wyodrêbnienie, je¿eli istnieje, boundary
  z nag³ówka.
\end{itemize}

G³ówna metoda parsuj±ca wiadomo¶æ i wyodrêbniaj±ca z wiadomo¶ci typu multipart
za³±czniki opiera siê na wyszukiwaniu wzorca w tek¶cie. Wyszukiwanym wzorcem
jest boundary, za¶ tekstem cia³o wiadomo¶ci. Algorytm wykorzystywanym przy tym
wyszukiwaniu to algorytm \textbf{Boyer-Moore'a}.

Uwa¿any jest on za najbardziej efektywny algorytm wyszukiwania wzorca.
Wykorzystuje siê go powszechnie w aplikacjach gdzie wystêpuje polecenie
''szukaj'' albo ''zamieñ''. 

Algorytm przyjmuje za³o¿enie, ¿e miêdzy d³ugo¶ci± tekstu (n), a wzorcem (m),
zachodzi zale¿no¶æ n>=m.

Skanowanie w tym algorytmie odbywa siê od prawej strony wzorca. W przypadku
niespasowania danego znaku b±d¼ dopasowania ca³ego wzorca stosuje siê dwie
funkcje z wcze¶niej wyliczonymi warto¶ciami. S± t±: ''good-suffix shift'' oraz
''bad-character shift''. Najlepiej przeanalizowaæ ich dzia³anie na przyk³adach.
Za³ó¿my, ¿e czê¶æ wzorca i teskstu zaznaczona jako u pasuje do siebie.
Natomiast na kolejnej pozycji wystêpuje ró¿nica. W zale¿no¶ci od sytuacji
mo¿emy przesun±æ siê w poszukiwaniu o ró¿n± warto¶æ:
\begin{itemize}
  \item ''good-suffix shift'' - je¿eli wzorzec zawiera w sobie kolejne
  wyst±pienie u to przesuwamy siê aby pokrywa³o siê ono z tekstem
  \newline
  \includegraphics[scale=0.6]{bm1.png}
  \newline
  tekst: \hspace*{0.3cm}cccccccbbabbaababbacc\newline
  wzorzec: \hspace*{0.07cm}abbaabba\newline
  \newline
  Niedopasowanie wystêpuje na 4 znaku licz±c od koñca, ale wzorzec zawiera w
  sobie fragment juz dopasowany (bba), zatem przesuwamy siê tak by kolejny taki
  fragment we wzorcu spasowa³ siê z tekstem.\newline
  \newline
  tekst: cccccccbbabbaababbacc\newline
  wzorzec:\hspace*{0.665cm}abbaabba
  
  \item ''good-suffix shift'' - wzorzec nie zawiera w sobie kolejnego
  wyst±pienia u to przesuwamy siê tak by suffix wzorca spasowa³ siê maksymalnie z jego
  dotychczas spasowanym prefiksem
  \newline
  \includegraphics[scale=0.6]{bm2.png}
  \newline
  tekst: \hspace*{0.3cm}cccccbbabbaababbacc\newline
  wzorzec: \hspace*{0.1cm}baabba\newline
  \newline
  Niedopasowanie wystêpuje na 4 znaku licz±c od koñca, wzorzec nie zawiera w
  sobie fragmentu juz dopasowanego (bba), ale mo¿emy dopasowaæ jak najd³u¿y
  suffix (bêdzie to ba)\newline
  \newline
  tekst: cccccbbabbaababbacc\newline
  wzorzec:\hspace*{0.68cm}baabba
  
  \item ''bad-character shift'' - przesuwamy siê tak by pierwszy znak od prawej
  w szukanym wzorcu spasowa³ siê z aktualnie rozpatrywanym znakiem w
  tek¶cie\newline
  \newline
  \includegraphics[scale=0.6]{bm3.png}
  \newline
  tekst: \hspace*{0.3cm}cccccccbbabbaababbacc\newline
  wzorzec: \hspace*{0.1cm}cbcaabba\newline
  \newline
  Niedopasowanie wystêpuje na 4 znaku licz±c od koñca (w tek¶cie mamy ''c'' we
  wzorcu mamy ''a''), zatem przesuwamy wzorzec w ten sposób by pierwsze ''c'' od
  prawej spasowa³o siê z tym, które ''popsu³o'' nam to dopasowanie\newline
  \newline
  tekst: cccccccbbabbaababbacc\newline
  wzorzec:\hspace*{0.68cm}cbcaabba
  
  \item ''bad-character shift'' - przesuwamy siê tak by pierwszy znak od prawej
  w szukanym wzorcu spasowa³ siê z aktualnie rozpatrywanym znakiem w tek¶cie,
  je¿eli takiego znaku nie ma to ustawiamy koniec wzorca bezpo¶rednio za
  nim\newline
  \includegraphics[scale=0.6]{bm4.png}
  \newline
  tekst: \hspace*{0.3cm}ccccccebbabbaababbacc\newline
  wzorzec: \hspace*{0.1cm}cbcaabba\newline
  \newline
  Niedopasowanie wystêpuje na 4 znaku licz±c od koñca (w tek¶cie mamy ''e'' we
  wzorcu mamy ''a''), we wzorcu ''e'' nie wystêpuje zatem przesuwamy siê tak by
  wzorzec by³ bezpo¶rednio za nim\newline
  \newline
  tekst: ccccccebbabbaababbacc\newline
  wzorzec: \hspace*{0.72cm}cbcaabba 
\end{itemize}

W algorytmie stosujemu zawsze maksymaln± warto¶æ wynikaj±c± z ''good-suffix
shift'' oraz ''bad-character shift''.

\subsubsection{Parser regu³}

Parser regu³ uruchamiany jest w trakcie ³adowania konfiguracji. Klasa do
tworzenia z pliku konfiguracyjnego regu³, na podstawie, których dokonywana jest
pó¼niej analiza, znajduje siê w klasie Configuration. Posiada ona metodê
loadConfiguration, która analizuje zawarty w poszczególnych liniach tekst i w
zale¿no¶ci od niego:
\begin{itemize}
  \item tworzy regu³y analizy wiadomo¶ci
  \item konfiguruje parametry filtra 
\end{itemize}

Mo¿liwe do utworzenia regu³y to:
\begin{itemize}
  \item regu³a definiuj±ca konieczno¶æ wyst±pienia lub zakaz wystêpowania
  konkretnego nag³ówka (lub nag³ówków) w wiadomo¶ci - reprezentowana przez
  klasê MimeMessageHeaderPresenceRule
  \item regu³a definiuj±ca wielko¶æ za³±cznika (lub za³±czników) w wiadomo¶ci -
  reprezentowana przez klasê MaxPartSizeRule
  \item regu³a definiuj±ca zakaz lub konieczno¶æ obecno¶ci w nag³ówku
  zdefiniowanego s³owa kluczowego - reprezentowana przez klasê
  KeywordSearchHeaderRule
  \item regu³a definiuj±ca akceptowane formaty plików - reprezentowana przez
  klasê AttachmentAnalizeRule
  \item regu³a definiuj±ca typy plików jakie bêd± poddawane g³êbszej analizie
  (przyk³adowo pliki zip mog± byæ sprawdzane pod k±tem poprawno¶ci sumy
  kontrolnej) - reprezentowana przez klasê FileAnalizerRule
  \item regu³a definiuj±ca zakaz lub konieczno¶æ obecno¶ci w za³±czniku
  zdefiniowanego s³owa kluczowego - reprezentowana przez klasê
  KeywordSearchAttachmentRule  
\end{itemize}

Wszystkie przedstawione klasy dziedzicz± z bazowej klasy Rule.

Przyk³adowa linia pliku konfiguracyjnego, z której mog± powstaæ dane regu³y
zostan± podane po¼niej w ramach konfiguracji rozdzia³u o konfiguracji filtra. 

\subsubsection{Analizator wiadomo¶ci}

Analizator wiadomo¶ci s³u¿y okre¶leniu akcji jaka zostanie wykonane (odrzucenie
wiadomo¶ci lub jej przepuszczenie oraz ewentualna jej modyfikacja) na podstawie
regu³, które zosta³y stworzone w trakcie ³adowania konfiguracji. Wiadomo¶æ
dostarczana do analizatora zostaje oczywi¶cie wcze¶niej sparsowana przez modu³
parsuj±cy wiadomo¶ci. Analizator jest wiêc elementem spajaj±cym regu³y, które
s± jego elementem nieodzownym elementem, oraz sparsowan± wiadomo¶æ.
Analizator jest reprezentowany przez klasê Analyser.

\subsubsection{Kolejka}

Kolejka s³u¿y do przetrzymywania wiadomo¶ci odebranych przez filtr. Wiadomo¶ci
przed analiz± trafiaj± do kolejki wiadomo¶ci przychodz±cych. Nastêpnie ka¿da
wiadomo¶æ wyjmowana z kolejki trafia do parsera i jest poddawana analizie. Po
analizie wiadomo¶ci, je¿eli nie s± one odrzucone, trafiaj± do kolejki
wychodz±cej i tam czekaj± na dalsz± transmisjê. Kolejka udostêpnia API
umo¿liwiaj±ce pobieranie i dodawanie do niej wiadomo¶ci. Reprezentowana jest
ona przez klasê Queue. Kolejki uzyskujemy z menad¿era kolejek (QueueManager),
który na podstawie klucza (nazwy kolejki) zwraca nam instancjê obiektu Queue.
QueueManager jest singletonem. W filtrze stworzone zosta³y dwie kolejki o
nazwach ''in\_queue'' i ''out\_queue''.

\subsubsection{Modu³ odbieraj±cy i wysy³aj±cy}

Modu³ odbieraj±cy przyjmuje wiadomo¶ci, które maj± trafiæ do filtra. Jest to
serwer SMTP, który nas³uchuje na okre¶lonym porcie przychodz±cych po³±czeñ.
Serwer ten nie obs³uguje autoryzacji (planowany jest rozwój filtra o t±
funkcjonalno¶æ). Ka¿de pod³±czenie siê nowego klienta powoduje uruchomienie
kolejnego w±tku odbieraj±cego. Serwer reprezentowany jest przez klasê
SMTPServer, za¶ po³±czenie (w±tek po³±czeniowy) przez klasê SMTPConnection.
Modu³ wysy³aj±cy to demon, który sprawdza cyklicznie czy w kolejce wychodz±cej
znajduj± siê wiadomo¶ci. Je¿eli tak jest, wiadomo¶æ usuwana jest z kolejki i
uruchamiany jest klient SMTP, który stara siê wys³aæ wiadomo¶æ. Obs³uga
ponawianie wysy³ania wiadomo¶ci w przypadku nieudanego jej dorêczenia bêdzie
rozwiniêta w kolejnych wersjach filtra.

\subsection{Kompilacja, konfiguracja i uruchomienie projektu}

Na konfiguracjê projektu sk³adaj± siê 2 pliki konfiguracyjne zawarte w katalogu
configuration/configuration (licz±c od g³ównego katalogu projektu):

\begin{itemize}
  \item log4j.properties - plik s³u¿±cy do konfiguracji logowania. Mo¿na w nim
  okresliæ:
  \begin{itemize}
    \item poziom logowania ogólny - dostêpne poziomy to TRACE, DEBUG, INFO,
    WARN, ERROR oraz FATAL
    \item formy logowania - konsola, plik lub inna forma (serwer z logami)
    \item przy aktywnym logowaniu do pliku nazwê pliku do logowania
    \item poziom logowania dla poszczególnych pakietów
  \end{itemize}
  \item filter.conf - plik s³u¿±cy do konfiguracji filtra. Mo¿na w nim okre¶liæ:
  \begin{itemize}
    \item numer portu, na którym nas³uchuje serwer SMTP znajduj±cy siê w ramach
    filtra
    \item maksymaln± liczbê klientów jaka jednocze¶nie mo¿e pod³±czyæ siê do
    filtra (czyli po³±czyæ siê z serwerem SMTP)
    \item maksymaln± liczba jednocze¶nie uruchomionych w±tków do analizy
    wiadomo¶ci
    \item formê modyfikacji wiadomo¶ci po analizie i przed wys³aniem - dodawanie
    kolejnego nag³ówka do wiadomo¶ci lub pozostawienie wiadomo¶ci w formie
    pierwotnej
    \item maksymaln± liczbê klientów wysy³aj±cych jednocze¶nie wiadomo¶ci
    \item regu³y filtruj±ce wiadomo¶ci
  \end{itemize}
\end{itemize}

Kompilacja oraz uruchomienie projektu odbywa siê przy pomocy narzêdzia ant.
Narzêdzie to wymaga ustawienia w systemie zmiennych systemowych JAVA\_PATH i
JAVA\_HOME. W pliku build.xml w projekcie zdefiniowane s± zadania (ang. tasks),
które ant mo¿e uruchamiaæ. G³ówne zadania to:

\begin{itemize}
  \item compile - kompiluje projekt
  \item run - uruchamia filtr
  \item run\_daemon - uruchamia filtr jako daemona
  \item stop\_deamon - zatrzymuje daemona filtru  
\end{itemize}

Wszystkie polecenia uruchamiane s± w nastêpuj±cy sposób:
\combox{ant nazwa\_zadania np. \textbf{ant compile} }
Przed uruchomieniem projektu nale¿y go skompilowaæ.

Przyk³ad ka¿dej regu³y filtruj±cej wiadomo¶æ (wraz ze szczegó³owym opisem)
znajduje siê w pliku example\_configuration\_file.conf w katalogu
configuration/configuration.

\subsection{Testy wydajno¶ciowe}

Stworzony filtr zosta³ poddany testom wydajno¶ciowym. Sprawdzona zosta³a
wydajno¶æ modu³u parsowania, jak i ca³o¶ci systemu.

\subsubsection{Parser}

Jednym z g³ównych elementów zapewniaj±cych du¿± wydajno¶æ filtra jest parser.
Filtr zosta³ poddany testom zarówno maj±cym na celu sprwadzenie szybko¶ci
parsowania w zale¿no¶ci od wielko¶ci wiadomo¶ci i jej skomplikowania, jak i
zachowania w przypadku coraz wiêkszej liczby wiadomo¶ci parsowanych
jednocze¶nie.

Poni¿sza tabela przedstawia czas parsowania pojedynczej wiadomo¶ci w
filtrze w zale¿no¶ci od typu wiadomo¶ci i jej wielko¶ci.
\newlines{\begin{center}
\begin{tabular}{ | c | c | c | }
\hline
Wielko¶æ [KB] & Typ & Czas parsowania [ms]\\
\hline
\hline
1,8 & multipart mixed (text+textfile) & 1 \\
2,4 & text plain & 2 \\
6,9 & multipart mixed (text+image) & 5 \\
226 & multipart mixed (text+pdf) & 70 \\
3400 & multipart mixed (text+image) & 922 \\
\hline
\end{tabular}
\end{center}
}
Ca³kowita d³ugo¶æ parsowania wiadomo¶ci czyli czas mierzony pomiêdzy pocz±tkiem
parsowania pierwszej wiadomo¶ci, a koñcem parsowania ostatniej wyniós³
\textbf{3988} ms. W czasie tym zawarty jest tak¿e czas wysy³ania wiadomo¶ci z wy³±czeniem
pierwszej z nich.

Wyniki jednoznacznie wskazuj±, ¿e szybko¶æ parsowania zwiêksza siê wraz ze
wzrostem wielko¶ci wiadomo¶ci, a typ wiadomo¶ci nie ma du¿ego wp³ywu na ten
czas.

Kolejna tabela przedstawia czas parsowania pojedynczej wiadomo¶ci w przypadku
równoleg³ego przetwarzania wiadomo¶ci od klientów.
\newlines{\begin{center}
\begin{tabular}{ | c | c | c | }
\hline
Wielko¶æ [KB] & Typ & Czas parsowania [ms]\\
\hline
\hline
1,8 & multipart mixed (text+textfile) & 3 \\
2,4 & text plain & 1 \\
6,9 & multipart mixed (text+image) & 32 \\
226 & multipart mixed (text+pdf) & 147 \\
3400 & multipart mixed (text+image) & 1011 \\
\hline
\end{tabular}
\end{center}
}
Ca³kowita d³ugo¶æ parsowania wiadomo¶ci czyli czas mierzony pomiêdzy pocz±tkiem
parsowania pierwszej wiadomo¶ci, a koñcem parsowania ostatniej wyniós³
\textbf{1089} ms. W czasie tym zawarty jest tak¿e czas wysy³ania wiadomo¶ci z
wy³±czeniem pierwszej z nich.

Wyniki potwierdzaj±, ¿e poszczególne czasy parsowania s± d³u¿sze w przypadku
równoleg³ego przetwarzania wiadomo¶ci. Zwi±zane jest to oczywi¶cie z
konieczno¶ci± prze³±czania siê wirtualnej maszyny pomiêdzy w±tkami. Jednak
ca³kowity czas parsowania dziêki równoleg³emu przetwarzaniu zosta³ zmniejszony
ponad trzykrotnie.

\subsubsection{Pozosta³e modu³y}

Poni¿sza tabela przedstawia czasy przebywania wiadomo¶ci w poszczególnych
modu³ach.
\newlines{\begin{tabular}{ | c | c | c | c | c | c | }
\hline
Lp & Odbieranie [ms]& Kolejka 1 [ms]& Parsowanie [ms]& Analiza [ms]& Kolejka
2 [ms]\\
\hline
\hline
1 & 174 & 2585 & 1 & 7 & 2795 \\
2 & 170 & 330  & 1 & 3 &  -   \\
3 & 210 & 143 & 10 & 1 & 2753 \\
4 & 165 & 2798 & 1 & 1 & 2739 \\
5 & 988 & 2887 & 240 & 4 & -  \\
\hline
\end{tabular}
}
Kolejka 1 okre¶la czas przebywania odebranej wiadomo¶ci w kolejce wiadomo¶ci
przychodz±cych, za¶ kolejka 2 okre¶la czas przebywania wiadomo¶ci w kolejce
wiadomo¶ci wychodz±cych. Brak warto¶ci w kolumnie ''Kolejka 2'' oznacza
odrzucenie wiadomo¶ci na poziomie analizy. Wiadomo¶ci by³y wysy³ane przez
klientów, które pod³±cza³y siê do filtra po loopbacku. Czasy wysy³ania nie
zosta³y uwzglêdnione, gdy¿ zale¿± od systemów zewnêtrznych (w przypadku
³±czenia siê do serwera po loopbacku bêd± podobne jak czasy w kolumnie
''Odbieranie'').

Tabela jednoznacznie pokazuje, ¿e oprócz modu³ów odbieraj±cego i wysy³aj±cego
spory czas wiadomo¶æ spêdza w kolejkach. W przypadku testowanym zwi±zane jest
to z usypianiem na 3000 ms demonów analizuj±cych kolejkê w przypadku braku w
niej elementów. Najkrótsze czasy widoczne s± w kolumnie ''Analiza''.
Bezpo¶rednio zwi±zane jest to z konfiguracj± regu³ wiadomo¶ci, a konkretnie
okre¶leniem jednej regu³y wyszukuj±cej w polu ''Subject'' okre¶lonego s³owa. W
przypadku zwiêkszenia ilo¶ci i skomplikowania regu³ czasy analizy wzrosn± i
d³ugo¶æ przebywania wiadomo¶ci w tym module mo¿e znacznie wzrosn±æ. Tabela
pokazuje tak¿e, ¿e czas parsowania wiadomo¶ci, jak to ju¿ wcze¶niej by³o
zaznaczone, jest bardzo istotnym elementem i jego obni¿enie mo¿e znacznie
wp³yn±æ na wydajno¶æ ca³ego filtra.

\newpage

\section{Podsumowanie i wnioski}

Stworzenie filtra protoko³u SMTP jest z³o¿onym zadaniem. Wymaga obszernej
wiedzy na temat protoko³u SMTP i jego rozszerzeñ, które s± nieustannie
rozwijane i zmieniane. Konieczne jest stworzenie serwera i klienta SMTP, które
stanowi± swoistego rodzaju API do komunikacji pomiêdzy filtrem, a systemami
zewnêtrznymi. Mo¿liwa oczywi¶cie jest inna forma dostêpu do filtra, ale to
niesie za sob± konieczno¶æ stworzenia odpowiednich wtyczek/rozszerzeñ do
istniej±cych ju¿ serwerów SMTP. Ze wzglêdu na ich mnogo¶æ, a tak¿e w przypadku
komercyjnych serwerów brak otwarto¶ci, mo¿e byæ to du¿ym problemem i dostêp do
filtra z wykorzystaniem protoko³u SMTP wydaje siê najlepszym rozwi±zaniem.

Kolejny problem zwi±zany jest z niezgodno¶ci± niektórych
implementacji klientów SMTP ze standardami opisanymi w RFC. Ma to wp³yw na
postaæ wiadomo¶ci przesy³anej przez klientów do filtra i wymusza konieczno¶æ
dodatkowych zmian w jego implementacji. Dotyczy to oczywi¶cie odpowiednich zmian
w parserze wiadomo¶ci (obecnie akceptuje on jedynie wiadomo¶ci zgodne z RFC),
od którego to poprawnego dzia³ania uzale¿nione jest dalsza analiza wiadomo¶ci.
Wprowadzenie usprawnieñ w parszerze mo¿liwe jest oczywi¶cie po obszernych
testach ró¿nych klientów dostêpnych obecnie na rynku, przez których tworzone
wiadomo¶ci nie spe³niaj± wszystkich standardów opisanych w RFC. Przyk³adowym
problemem jest chocia¿by brak jakichkolwiek zmian w boundary w ciele wiadomo¶ci
w stosunku do boundary z nag³ówka Content-type. Zgodnie z RFC linia ta powinna
zostaæ zmodyfikowana o dodatkowe dwa znaki ''-'' z przodu.

Du¿ym problemem jest tak¿e ¶rodowisko do testowania, szczególnie gdy
chcieliby¶my przeprowadziæ testy na du¿a skalê. Musi ono umo¿liwiaæ jednoczesne
uruchomienie wielu klientów wysy³aj±cych wiadomo¶ci ró¿nego typu. Potrzebny
jest tak¿e serwer docelowy, a najlepiej kilka z ró¿nymi czasami dostêpu, do
którego wiadomo¶ci powinny byæ s³ane po przej¶ciu przez filtr.

Pomimo wszelkich trudno¶ci otwarty projekt filtra protoko³u SMTP jest ciekawym
zagadnieniem wartym rozwoju. 

W autorskim filtrze planowane jest rozszerzenie funkcjonalno¶ci o:
\begin{itemize}
  \item ponawianie wysy³ania w przypadku nieudanego dorêczenia wiadomo¶ci
  \item mechanizmy zapisywania wiadomo¶ci trafiaj±cych do kolejek na dysk w
  celach mo¿liwo¶ci odtworzenia ich zawarto¶ci w przypadku nieoczekiwanego
  zatrzymania dzia³ania systemu
  \item obs³ugê autoryzacji, pipeliningu, szyfrowania w serwerze SMTP w module
  odbieraj±cym oraz wysy³aj±cym
  \item dodatkowe regu³y filtruj±ce w analizatorze:
  	\begin{itemize}
      \item rozpoznawanie plików binarnych (exe) przesy³anych w za³±cznikach
      nawet w przypadku zmienionego rozszerzenia za³±cznika
      \item analiza adresów internetowych zawartych w wiadomo¶ciach (mo¿liwo¶æ
      odrzucenia wiadomo¶ci z adresami z okre¶lonych domen)
    \end{itemize}
  \item mo¿liwo¶æ parsowania wiadomo¶ci nie do koñca zgodnych z RFC 
\end{itemize} 

\newpage
