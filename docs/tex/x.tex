%%%% ZAWARTO¦Æ OBLIGATORYJNA - NALE¯Y DOSTOSOWAÆ %%%%%%%%%%%%%%%%%%%%%%%%

%% Tytu³ opracowania
\title{Filtr protoko³u SMTP\\
%% Tu nale¿y podaæ nazwê przedmiotu, którego tyczy sprawozdanie.
\begin{small}
Praca in¿ynierska
\end{small}}

%% Autorzy opracowania, po dwie linie z nazwiskiem i adresem e-mail na
%% osobê. Ka¿dy opis oddzielony separatorem 'and'.
%% \author{Tomasz Jordan Kruk\\ T.Kruk@ia.pw.edu.pl \and Jan Nieznany\\ jn@n.pl}
\author{Zbigniew Artemiuk\\ Z.Artemiuk@stud.elka.pw.edu.pl}

% To stworzy w³a¶ciwy format tytu³u oraz spis tre¶ci.
\maketitle

\newpage

\tableofcontents



%%%% PONI¯EJ ZAWARTO¦Æ DOWOLNA %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Dokument podzielony powinien byæ na elementy: section, subsection,
% ewentualnie subsubsection.

\newpage

\section{Wstêp}

Obecnie w Internecie, pomimo szeregu rozwijaj±cych siê form komunikacji,
chocia¿by technologii takich jak tekstowa komunikacja czasu rzeczywistego (czyli
IM - instant messaging i popularne chaty) czy te¿ jeszcze bardziej zaawansowanych
technologii, które umo¿liwiaj± przesy³anie g³osu oraz wideo (chocia¿by Skype),
pospolite maile ca³y czas znajduj± zastosowanie. U¿ywamy ich chyba obecnie najcze¶ciej
do kontaktów biznesowych, rodzinnych, przyjacielskich, g³ównie w celach informacyjnych
(czyli sam tekst), jak równie¿ do przekazywania niewielkich plików. Chyba ka¿dy
internauta legitymuje siê przynajmniej jedn± skrzynk± mailow± (a czasami jest
ich znacznie wiêcej). Ka¿dy spotka³ siê tak¿e z niechcian±
poczt± (niechcianymi mailami), nazywan± bardzo ogólnym okre¶leniem Spam, i
narzêdziami (chocia¿by tymi wbudowanymi w klientów pocztowych dostêpnych z
poziomu przegl±darki internetowej), które umo¿liwiaj± odseparowanie takiej
poczty, od tej która niesie interesuj±c± nas zawarto¶æ merytoryczn±. Separacja
ta to tzw. filtrowanie ze wzglêdu na obiekt filtracji zwane filtracja poczty.
Dokonanie filtracji wymaga jednak poznania dok³adnie w jaki sposób
transportowane s± nasze maile, a to wszystko zawarte jest w protokole Simple
Mail Transfer Protocol (w skrócie SMTP).
Co¶ tutaj jeszcze dopisaæ o protokole, o jego wadach, o konieczno¶ci filtracji.

\newpage

\section{Cel i zakres pracy}

Celem pracy jest zaprojektowanie oprogramowania, które po
uruchomieniu umo¿liwia³oby filtracjê wiadomo¶ci w ramach protoko³u SMTP.
Oprogramowanie to by³oby konfigurowalne poprzez plik tekstowy zawieraj±cy
regu³y dotycz±ce wiadomo¶ci SMTP i zachowania oprogramowania po napotkaniu
takiej wiadomo¶ci. Regu³y te dawa³yby mo¿liwo¶æ nastêpuj±cej filtracji:

\begin{itemize}
  \item wykrywanie wiadomo¶ci posiadaj±cych b±d¼ nie posiadaj±cych okre¶lony
  nag³ówek (nag³ówki)
  \item wykrywanie wiadomo¶ci posiadaj±cych b±d¼ nie posiadaj±cych okre¶lonej
  frazy w nag³ówku (nag³ówkach)
  \item wykrywanie wiadomo¶ci posiadaj±cych b±d¼ nie posiadaj±cych okre¶lonej
  frazy w nag³ówkach czê¶ci maila (gdy nie jest to prosty mail)
  \item wykrywanie okre¶lonych content-type-ow w wiadomo¶ciach
  \item wykrywanie wiadomo¶ci o okre¶lonej wielko¶ci czê¶ci (je¿eli wiadomo¶æ
  jest jednoczê¶ciowa to tyczy siê tre¶ci wiadomo¶ci)
\end{itemize}
 
Po natrafieniu na wiadomo¶æ spe³niaj±c± kryteria danej regu³y zostanie ona w
zale¿no¶ci od zapisu w konfiguracji: 

\begin{itemize}
  \item odrzucona (wyfiltrowana)
  \item przepuszczona, a jej obecno¶æ zostanie zaznaczona w logach
  \item przepuszczona 
\end{itemize}

\newpage

\section{Protokó³ SMTP}

\subsection{Historia powstania}

\subsubsection{ARPANET czyli pocz±tki Internetu}

Historia powstania protoko³u SMTP jest ¶ci¶le zwi±zana z pocz±tkami Internetu.
Internet za¶ i jego kreowanie zwi±zane jest bezpo¶rednio ze swoim przodkiem
czyli ARPANETEm.

ARPANET (Advanced Research Projects Agency Network) zosta³ stworzony przez
przez jedn± z agencji United States Department of Defense (departament
bezpieczeñstwa Stanów Zdjednoczonych) o nazwie ARPA (Advanced Research
Projects Agency). Nazwa agencji zosta³a pó¼niej przekszta³cona na DARPA (D od
Defence). Agencja ta mia³a zaj±c siê rozwojem nowych technologii na potrzebê
amerykañskiego wojska.

W miarê wchodzenia w ¿ycie komputerów wykorzystywanych w ramach agencji
powsta³a idea stworzenia sieci pomiêdzy nimi, która to umo¿liwi³aby
komunikacje pomiêdzy ich u¿ytkownikami. Idea ta zosta³a po raz pierwszy
zaproponowana przez Josepha Carla Robnetta Licklidera z firmy Bolt, Beranek and
Newman (obecnie BBN Technologies) w sierpniu 1962 w serii notatek na temat
koncepcji ''Miêdzygalaktycznej Sieci Komputerowej''. Zawiera³a ona prawie
wszystko czego mo¿emy do¶wiadczyæ w dzisiejszym Internecie.

W pa¼dzierniku 1963 roku Licklider zosta³ mianowany szefem programu Behavioral
Sciences and Command and Control w ARPA. Przekona³ on wtedy Ivana Sutherlanda i
Boba Taylora, ¿e jego wizja jest czym¶ naprawdê istotnym. Sam Licklider nie
doczeka³ jednak ¿adnych konkretnych prac w kierunku jej urzeczywistnienia, gdy¿
opu¶ci³ ARPA.

ARPA i Taylor ca³y czas byli zainteresowanie stworzeniem sieci komputerowej,
a¿eby zapewniæ naukowcom pracuj±cym w ramach ARPA w ró¿nych lokalizacjach,
dostêp do innych komputerów, które firma oferowa³a. Istotne by³o tak¿e, aby
nowe oprogramowanie i rezultaty badañ by³y jak najszybciej widoczne dla ka¿dego
u¿ytkownika sieci. Sam Taylor posiada³ 3 ró¿ne terminale, które dawa³y mu
pod³±czenie do 3 ró¿nych komputerów - jeden do SDC Q-32 w Santa Monica, drugi w
ramach projektu Project Genie do komputera na Uniwersytecie w Kalifornii
(Berkley) i ostatni do komputera z Multicsem w MIT (The Massachusetts Institute of Technology).

Taylor w taki sposób opowiada³ od pod³±czeniu do tych komputerów:
'' Dla ka¿dego z tych terminali mia³em inny zestaw poleceñ. Dlatego te¿ kiedy
rozmawia³em z kim¶ z Santa Monica, a po¼niej chcia³em ten sam temat
skonsultowaæ z kim¶ z Berkley albo MIT, musia³em przesi±¶æ siê do innego
terminala. Oczywistym wtedy wyda³o mi siê, ¿e musi byæ 1 terminal, który
obs³u¿y te 3 po³±czenia. Idea ta to w³a¶nie ARPANET''

Do po³owy 1968 roku kompletny plan sieci zosta³ stworzony i po zatwierdzeniu
przez ARPA, zapytanie ofertowe RFQ (Request For Quotation) zosta³o pos³ane do
140 potencjalnych wykonawców. Wiêkszo¶æ potraktowa³a propozycjê jako dziwaczn±.
Tylko 12 firm z³o¿y³o oferty z czego 4 zosta³y uznane za najwa¿niejsze. Do
koñca roku wy³oniono 2 firmy, z których ostatecznie 7 kwietnia 1969 roku
zosta³a wybrana firma BBN.

Propozycja BBN by³a najbli¿sza planom ARPA. Pomys³em ich by³o stworzenie sieci
z ma³y komputerów zwanych Interface Message Processors (bardziej znanych jako
IMPs), które to obecnie nazywamy routerami. IMPsy z ka¿dej strony zapewnia³y
funkcje przechowywania i przekazywania pakietów, a po³±czone by³y miêdzy sob±
przy u¿yciu modemów podpiêtych do ³±czy dzier¿awionych (o przepustowo¶ci 50
kbit/sekundê). Komputery pod³±czone by³y do IMPsów poprzez specjalny bitowy
interfejs. W ten sposób stawa³y siê one czê¶ci± sieci ARPANET.

Do zbudowania pierwszej generacji IMPsów BBN wykorzysta³a komputer Honeywell
DDP-516. Zosta³ on wyposa¿ony w 24kB pamiêci rdzenia (z mo¿liwo¶ci±
rozszerzenia) oraz 16 kana³ów Direct Multiplex Control (DMC) do bezpo¶redniogo
dostêpu do tej pamiêci. Poprzez DMC pod³±czane by³y komputery u¿ytkowników
(hosty) i modemy. Dodatkowo 516 otrzyma³ ezstaw 24 lamp, które pokazywa³y
status kana³ów komunikacyjnych IMPa. Do ka¿dego IMPa mo¿na by³o pod³±czyæ do
czterech hostów i móg³ siê on komunikowaæ z 6 zdalnymi IMPami poprzez
wspó³dzielone ³±cza.

Zespó³ z BBN (pocz±tkowo 7 osób) szybko stworzy³ pierwsze dzia³aj±ce jednoski
(IMPy). Ca³y system, który zawiera³ zarówno sprzêt jak i pierwsze
oprogramowania zarz±dzaj±ce pakietami, zosta³ zaprojektowany i zainstalowany w
ci±gu 9 miesiêcy.

Pocz±tkowo ARPANET sk³ada³ siê z 4 IMPów. Zosta³y one zainstalowane w:

\begin{itemize}
  \item UCLA (University of California, Los Angeles), gdzie Leonard Kleinrock
  za³o¿y³ centrum pomiaru sieci (Network Measurment Center)
  \item The Stanford Research Institute's Augmentation Research Center, gdzie
  Douglas Engelbert stworzy³ system NLS, który miêdzy innymi wprowadzi³ pojêcie
  hypertextu
  \item UC Santa Barbara
  \item The University of Utah's Graphics Department, gdzie przebywa³ ówcze¶nie
  Ivan Sutherland
\end{itemize}

\subsubsection{Piersze wiadomo¶ci w ARPANETcie}

Pierwsza komunikacja host-host w sieci ARPANET wykorzystywa³a protokó³ 1822,
który definiowa³ sposób w jakis host przesy³a³ wiadomo¶æ do IMPa. Format
wiadomo¶ci by³ tak zaprojektowany, ¿eby bez problemu móg³ pracowaæ z szerokim
zakresem architektur. Zasadniczo wiadomo¶æ sk³ada³a siê z:

\begin{itemize}
  \item typu wiadomo¶ci
  \item adresu hosta
  \item pola z danymi
\end{itemize}

W celu wys³ania wiadomo¶ci do innego hosta, host wysy³aj±cy powinien sformatowaæ
wiadomo¶æ tak, aby ta zawiera³a adres hosta docelowego oraz dane, a nastêpnie
dokonaæ transmisji wiadomo¶ci przez interfejs sprzêtowy 1822. IMP dostrze¿e
dostarczenie wiadomo¶ci albo poprzez dostarczenie jej bezpo¶rednio do hosta
docelowego albo poprzez przekazanie jej do kolejnego IMPa. Kiedy wiadomo¶æ
zosta³a odebrana przez docelowego hosta, IMP do którego host by³ pod³±czony
wysy³a potwierdzenie odbioru (zwane Ready for Next Message or RFNM) do hosta
wysy³aj±cego.

W przeciwieñstwie do obecnych protoko³ów datagramowych w Interecie (takich jak
no IP), ARPANETowy porotokó³ 1822 zapewnia³ niezawodno¶æ w taki sposób, ¿e
informowa³ o niedostarczonej wiadomo¶ci. Niemniej protokó³ 1822 nie by³
odpowiedni do ¿onglowania wieloma po³±czeniami w ró¿nych aplikacjach
uruchomionych na pojedynczym ho¶cie. Problem ten zosta³ rozwi±zany dziêki
wprowadzeniu na hostach Network Control Program (NCP), dziêki któremu mo¿liwe
by³o niezawodne, z kontro³± przep³ywu, dwukierunkowe po³±czenia pomiêdzy
ró¿nymi procesami na ró¿nych hostach. NCP implementowa³ kolejn± warstwê
znajduj±c± siê na górze stosu protoko³ów. Dziêki niemu aplikacje, które mia³y
mieæ ju¿ jak±¶ konkretn± funkcjonalno¶æ, mog³y wykorzystywaæ spójny interfejs i
korzystaæ swobodnie z dobrodziejstw ARPANETu czyli wykonywaæ po³±czenia do
innych aplikacji przez sieæ. 

\subsubsection{SNDMSG i READMAIL}

Na pocz±tku roku 1970, powsta³ program (a w zasadzie 2
oddzielne) do wysy³ania i odbierania wiadomo¶ci. Zaimplementowa³ go Ray
Tomlinson. Programy te to SNDMSG i READMAIL. Pierwsza wersja tych
programów, by³a kolejn± implementacj±, która umo¿liwia³a wymiane
informacji miêdzy u¿ytkownikami jednej maszyny (jednego hosta), a konkretnie
komponowanie, adresowanie i wysy³anie wiadomo¶ci do skrzynek u¿ytkowników. Ju¿
jednak w 1971 Tomlinson stworzy³ pierwsz± aplikacjê ARPANETow± (w ramach prac
nad systemem TENEX), która umo¿liwia³a wysy³anie wiadomo¶ci do dowolnych
hostów. Tomlinson dokona³ usprawnieñ w programie SNDMSG przy okazji pracy nad
projektem CPYNET, którego celem by³o stworzenie protoko³u do wymiany plików
miêdzy komputerami w sieci.

Skrzynkê emailow± by³ wówczas by³ zwyk³y plik o okre¶lonej nazwie. Specjaln±
w³a¶ciwo¶ci± jego by³o to, ¿e mia³ ochronê tak±, ¿e umo¿liwia³ innym
u¿ytkownikom dopisywanie do pliku. Mogli oni wiêc pozostawiaæ kolejne
wiadomo¶ci ale nie mogli ich czytaæ ani nadpisywaæ wcze¶niejszych (jedynie
w³a¶ciciel móg³ to robiæ). Tomilson zauwa¿y³, ¿e CPYNET mo¿e dopisywaæ zawarto¶æ
do pliku skrzynki mailowej, na takiej zasadzie jak SNDMSG (SNDMSG umia³
zapisywaæ wtedy tylko na lokalnej maszynie). Dlatego te¿ SNDMSG móg³ po prostu
skorzystaæ z kodu CPYNET i bezpo¶rednio dostarczaæ wiadomo¶ci poprzez
po³±czenie sieciowe do zdalnych skrzynek poprzez dopisywanie kolejnych
informacji do plików na innych hostach.

Brakuj±c± czê¶ci± by³a mo¿liwo¶æ dopisywania do plików przy pomocy CPYNET.
Dotychczas móg³ on tylko s³aæ i odbieraæ pliki. Dodanie tej funkcjonalno¶ci nie
by³o czym¶ wielkim dla twórców protoko³u i funkcjonalno¶æ ta wkrótce
zainstnia³a.

Nastêpnie Tomilson w³±czy³ kod CPYNET do SNDMSG. Pozosta³o jedynie rozró¿nienie
maili lokalnych od maili zdalnych. Dlatego te¿ Tomilson zdecydowa³ siê, ¿e
maile zdalne bêd± rozpoznawane po tym, ¿e po loginie (czyli wyznaczniku
u¿ytkownika do którego wiadomo¶æ jest s³ana) nast±pi specjalny znaczek @ (ang.
at, a polska znana wszystkim ma³pa) , a tu¿ po nim nazwa hosta czyli zdalnego
komputera, na którym skrzynkê ma dany loginem u¿ytkownik. Tomilson tak
powiedzia³ o wyborze ma³py jako znaczka rozdzielaj±cego login od hosta: ''I am
frequently asked why I chose the at sign, but  the at sign just makes sense''
(w wolnym t³umaczeniu: Jestem czêsto pytany czemu wybra³em znaczek ma³py, ale
on po prostu mia³ sens).

Pierwsza wiadomo¶æ zosta³a przes³ana pomiêdzy maszynami, które fizycznie by³y
obok siebie. Jedyne po³±czenie jakie by³o miêdzy maszynami (oprócz pod³ogi ;] )
by³o za po¶rednictwem sieci ARPANET. Tomilson przes³a³ wiele wiadomo¶ci do
samego siebie z jednej maszyny na drug±. Pierwsze tre¶ci wiadomo¶ci od razu
zosta³y zapomniane. Najprawdopodobniejsza ich tre¶æ by³a w stylu QWERTYUIOP.
Kiedy Tomilson by³ zadowolony z programu wys³a³ do swoich kolegów z zespo³u
wiadomo¶æ z instrukcj± jak s³aæ wiadomo¶ci przez sieæ. I tak pierwsza
wys³ana wiadomo¶æ og³osi³a swoje istnienie.

Te pierwsze wiadomo¶ci zosta³y wys³ane pod koniec 1971 roku. Nastêpne wydanie
TENEXa, które ukaza³o siê w 1972 roku, zawiera³o SNDMSG, z mo¿liwo¶ci±
wysy³ania maili przy u¿yciu sieci ARPANET. Protokó³ CPYNET wkrótce zosta³
zast±piony prawdziwym protoko³em do transferu plików i posiada³ specyficzne
dodatki do obs³ugi maila. 

\subsubsection{MAIL i MLFL w protokole FTP}
Protoko³em, o którym wcze¶niej by³a mowa by³ protokó³ FTP, którego specyfikacja
wstêpna zosta³a zawarta w RFC (Request For Comment) 114. Kolejne ulepszenia
protoko³u zosta³y dokonana w roku 1972 i wtedy te¿ wesz³y do niego nowe polecenia pozwalaj±ce
korzystaæ ze skrzynek emailowych. Poleceniami tymi by³y:

\begin{itemize}
  \item MAIL - polecenie to pozwala³o u¿ytkownikowi przy pomocy telnetu wys³aæ
  maila. Pomocne to by³o gdy u¿ytkownik ten nie korzysta³ ze swojego hosta i
  logowa³ sie do niego poprzez protokól telnet
  \item MLFL - polecenie to pozwala³o na normalne skonstruowanie maila i
  przes³anie odpowiednio wskazanego pliku jako jego tre¶ci
\end{itemize}

Protokó³ ten sta³ siê a¿ do roku 1980 standardem przesy³ania emaili w
ARPANETcie. Wtedy to zosta³ wypart przez protokó³ SMTP, który z pewnymi
usprawnieniami funkcjonuje a¿ do dzi¶.

\subsubsection{Rozwój innych programów do obs³ugi poczty}

Zanim jednak powsta³ protokó³ SMTP ca³y czas pracowano nad rozwojem ówczesnych
programów chocia¿by do odbioru maili. W ten sposób na pro¶be Steve'a Lukasika
Lawrence Roberts, ówczesny dyrektor IPTO, stworzy³ program RD, który sk³ada³
siê z makr w edytorze TECO (Text Editor and COrrector).

Program RD umo¿liwia³:

\begin{itemize}
  \item sortowanie emaili po temacie i dacie
  \item czytanie, zapisywanie i czytanie wiadomo¶ci w dowolnym porz±dku
\end{itemize}

RD nie powsta³ wiêc jako wynik badañ, ale z czysto praktycznej potrzeby
swobodnego zarz±dzania emailami.

Wkrótce powsta³y te¿ kolejne ulepszenia programu RD oraz SENDMSG, takie jak NRD
czy WRD, które to wprowadza³y kolejne ulepszenia istniej±cych ju¿
implementacji. 

Warte wspomnienia jest tak¿e powstanie programu MSG, który umo¿liwia³ miêdzy
innymi przekazywanie maili (ang. forwarding), konfigurowalny interfejs, czy te¿
polecenie Odpowiedz (ang. Answer), które automatycznie uzupe³nia³o adres
odbiorcy. MSG mo¿na by³o nazwaæ pierwszym nowoczesnym programem pocztowym. 

W 1977 roku ró¿ne formaty wiadomo¶ci zosta³y zebrane w jedn± spójn±
specyfikacjê co doprowadzi³o do stworzenia RFC 733.  Specyfikacja ta po³±czy³a
wcze¶niej istniej±ce dokumentacjê z odrobion± innowacji i by³a jednocze¶nie
pierwszym RFC, które deklarowa³o standard Internetowy (ówcze¶nie ARPANETowy).

\subsection{Szczegó³y protoko³u}

W 1982 roku powsta³o g³ówne RFC opisuj±ce protokó³ SMTP - RFC 821. W 2001 roku
zosta³o ono rozbudowane i powsta³ dokument, który jest obowi±zuj±c± obecnie
specyfikacj± protoko³u. Informacje te zawarte zosta³y w RFC o numerze 2821.

\subsubsection{Model protoko³u, podstawy}

\includegraphics[scale=0.4]{klient_serwer_smtp.png}

Komunikacja w protokole SMTP oparta jest na nastepuj±cym modelu: kiedy klient
SMTP posiada wiadomo¶æ, któr± chce przetransmitowaæ ustanawia dwukierunkowy
kana³ transmisyjny z serwerem SMTP. Klient SMTP bierze na siebie
odpowiedzialno¶æ za przetransportowanie wiadomo¶ci do jednego lub wielu
serwerów SMTP, lub zg³oszenie b³êdu je¶li operacji przekazania maila nie
powiod³a siê. 

Adres serwera SMTP klient determinuje poprzez zamianê domeny podanej w
adresie na po¶redni host (Mail eXchanger) lub ostateczny host docelowy.

Serwer SMTP mo¿e byæ ostatecznym celem albo te¿ po¶rednim ''przeka¼nikiem''
(po odebraniu wiadomo¶ci to on mo¿e przej±æ rolê klienta SMTP) albo ''bram±''
(mo¿e transportowaæ wiadomo¶æ dalej u¿ywaj±c innego protoko³u ni¿ SMTP).
Polecenia protoko³u SMTP generowane s± przez klienta i posy³ane do serwera.
Odpowiedzi s³ane s± jak reakcja na ¿±dania klienta.

Innymi s³owy wiadomo¶æ mo¿e byæ przetransportowana w trakcie pojedynczego
po³±czenia pomiêdzy pierwotnym adresatem, a ostatecznym klientem albo mo¿e
sk³adaæ siê z kilku po¶rednich po³±czeñ. W obu przypadkach zachowana jest
odpowiedzialno¶æ za wiadomo¶æ - protokó³ wymaga od serwera wziêcia
odpowiedzialno¶ci za dostarczenie wiadomo¶ci albo w przypadku nieprawid³owo¶ci
za zg³oszenie b³êdu.

Kiedy kana³ transmisyjny zostanie zestawiony klient SMTP inicjuje transakcjê
maila. Sk³ada siê ona z serii poleceñ, które maj± na celu wyspecyfikowanie
nadaj±cego i celu wiadomo¶ci, a nastêpnie przes³ania jej zawarto¶ci (oczywi¶cie
z nag³ówkami, które wchodz± w jej sk³ad). Kiedy ta sama wiadomo¶æ jest
adresowana do wielu odbiorców, protokó³ przesy³a jedn± kopiê wiadomo¶æ dla
wszystkich odbiorców w obrêbie jednego hosta.

Serwer reagujê na ka¿d± komendê odpowiedziami. Wskazuj± one akceptacjê komendy
(tej przes³anej od klienta) i oczekiwanie na kolejne, b±d¼ te¿ wyst±pienie
tymczasowych albo sta³ych b³êdów.

Kiedy mail zostanie przetransmitowany, klient mo¿e zamkn±æ po³±czniee albo te¿
zainicjowaæ kolejn± tranzakcjê innego maila. Dodatkowo klienty SMTP mog± u¿ywaæ
po³±czenia z serwerem w celach np. weryfikacji adresu email b±d¼ te¿ uzyskanie
adresów subskrybentów listy dyskusyjnej.

Jak zosta³o wcze¶niej zasugerowane transmisja w protokole mo¿e odbywaæ siê
bezpo¶rednio pomiêdzy hostem ¶l±cym wiadomo¶c, a hostem docelowym, kiedy s± one
po³±czone tym samym serwisem transportowym. Kiedy tak nie jest, transmisja
odbywa siê poprzez hosty po¶rednie. Hosty te wybierane s± poprzez
mechanizm serwera domen (DNS) zwany Mail eXchanger.

\subsubsection{Model rozszerzeñ}

W wyniku prac, które rozpoczê³y siê oko³o dekadê po wydaniu pierwszego RFC
dotycz±cego protoko³u SMTP (czyli RFC 822), protokó³ zosta³ rozszerzony i
pojawi³y siê w nim nowe funckjonalno¶ci. Standardowy model zosta³ wiêc
zmodyfikowany o dodatkowe serwisy. Pozwalaj± one na ustalenie pomiêdzy klientem,
a serwerem us³ug dodatkowych jakie s± oni w stanie obs³u¿yæ (poza podstawowymi
wymaganiami SMTP). Mechanizm rozszerzeñ SMTP okre¶la ¶rodki, za pomoc± których
klient i serwer mog± dokonaæ wzajemnego ropoznania, a serwer mo¿e tak¿e
poinformowaæ klienta o rozszerzeniach, które on wspiera.

Wspó³czesna implementacja SMTP musi obs³ugiwaæ podstawowe mechanizmy
rozszerzeñ. Przyk³adowo serwer musi wspieraæ komendê EHLO, je¶li nawet nie
implementuje innych specyficznych rozszerzeñ, natomiast klient powinien
sk³aniaæ siê ku u¿ywaniu komendy EHLO ni¿ HELO. 

SMTP jest szeroko u¿ywany i pojawi³o siê wiele bardzo dobrych implementacji
protoko³u wyposa¿onych w liczne rozszerzenia. Spo³eczno¶æ w Internecie jednak
uwa¿a, ¿e niektóre z serwisów s± bardzo wa¿ne, mimo tego, ¿e nie powsta³y gdy
protokó³ by³ po raz pierwszy projektowany. Je¶li serwisy te maj± zostaæ dodane
to w zachowaniem zgodno¶ci wstecz. 

Obecnie szkielet rozszerzeñ sk³ada siê z:

\begin{itemize}
  \item Polecenia EHLO, które powinno byæ u¿ywane zamiast wcze¶niejszego HELO
  \item Rejestr rozszerzeñ SMTP
  \item Dodatkowe parametry do poleceñ SMTP MAIL i RCPT
  \item Opcjonalnych zast±pieñ poleceñ w protokole SMTP, jak na przyk³ad DATA w
  transmisji nie przy pomocy ASCII (ang. pipelining opisany pó¼niej)
\end{itemize}

Si³± SMTP jest jego prostota. Do¶wiadczenia z protoko³ami pokazuj±, ¿e te z
kilkoma mo¿liwo¶ciami staj± siê powszechnie u¿ywanymi, podczas gdy te z
wieloma mo¿liwo¶ciami przestaj± byæ czytelne. 

\subsubsection{Sesja protoko³u}

Sesja jest inicjowana kiedy klient otwiera po³±czenie do serwera i serwer
odpowie wiadomo¶ci± zapraszaj±c±.

SMTP serwer po pod³±czeniu siê klienta mo¿e po kodzie powitalnym 220
poinformowaæ klienta o swoim oprogramowaniu i jego wersji.

\framebox{220 mail.foo.com SuperSMTP v 6.1.2 Service ready}

Protokó³ SMTP pozwala serwerowi na odmówienie transakcji podczas gdy formalnie
umo¿liwia na pod³±czenie siê do serwera SMTP. Wtedy zamiast kodu 220 serwer
odpowiada kodem 554. 

\framebox{554 Transaction failed (Or, in the case of a
connection-opening response, ''No SMTP service here'')}

Serwer w tym przypadku musi czekaæ zanim zakoñczeny po³±czenie na
komende QUIT ze strony klienta. W trakcie tego oczekiwania wszystkie inne
komendy zostan± potraktowane odpowiedzi± 503.

\framebox{503 Bad sequence of commands}

Kiedy serwer przywita siê z klientem i klient otrzyma wiadomo¶æ powitaln±,
standardowo wysy³a on polecenie EHLO do serwera i w wiadomo¶ci tej przedstawia
siê.
 
\framebox{EHLO bar.com}

U¿ycie komendy EHLO wskazuje, ¿e klient jest w stanie obs³u¿yæ
rozszerzenia protoko³u i prosi serwer o ich listê. Starsze systemy SMTP, które
nie obs³uguj± rozszerzeñ protoko³u czy te¿ starsze klienty SMTP, które nie
wymagaj± tych¿e rozszerzeñ, mog± u¿ywaæ komendy HELO.

\framebox{HELO bar.com}

Serwer w odpowiedzi na HELO nie powinien zwróciæ listy rozszerzeñ. Je¿eli
serwer zwróci na EHLO 

\framebox{500 Command not recognized}

, wtedy klient powinien byæ w stanie przes³aæ komende HELO.

Nastêpnie dochodzi do transakcji maila. Rozpoczyna siê ona poleceniem MAIL,
która identyfikuje nadawcê. Po niej nastêpuje seria poleceñ RCPT, które
przekazuj± informacjê o odbiorcy, a na sam koniec DATA czyli cia³o maila, które
koñczone jest wyznacznikiem koæa maila. Znacznik ten potwierdza transakcjê. 

Pierwszym krokiem w procedurze transakcji jest komenda MAIL. Ogólna jej
sk³adnia wygl±da nastêpuj±co:

\framebox{MAIL FROM:<reverse-path> [SP <mail-parameters> ] <CRLF>}

przyk³adowo

\framebox{MAIL FROM:<bob@example.org>}

Poleceni to mówi odbiorcy SMTP (serwerowi), ¿e rozpoczynana jest nowa
transakcja. Dlatego powinien on zresetowaæ (chyba na danym po³±czeniu?)
wszystkie poprzednie stany tabel i buforów, w³±czaj±c w to odbiorców i dane
maila. Argument <reverse-path> zawiera adres ¼ród³owej skrzynki mailowej, która
mo¿e pos³u¿yæ w celu informacji o ewentualnych b³êdach (bêdzie dalej opisane
[4.2]). Je¶li polecenie zostanie zaakcpetowane serwer odpowiada poleceniem 250
OK. 

\framebox{250 OK}

Je¶li przes³any adres nie zosta³ zaakceptowany serwer musi odpowiedzieæ czy
b³±d jest sta³y (zawsze bêdzie siê pojawia³ przy tym adresie) czy tymczasowy
(klient bêdzie móg³ wykonaæ ponown± próbê, która mo¿e zakoñczyæ siê sukcesem).
Czasami jednak serwer mo¿e dokonaæ akceptacji adresu przekazanego w poleceniu
MAIL i dopiero po analizie adresów przes³anych w poleceniu RCPT, mo¿e zg³osiæ
b³±d. Normalnie jednak gdy b³±d jest sta³y odpowied¼ serwera to

\framebox{550 mailbox not found}

albo tymczasowy

\framebox{503 i co tutaj?}

Historycznie <reverse-path> mo¿e nie tylko zawieraæ adres skrzynki, jednak¿e
obecne oprogramowanie nie powinno u¿ywaæ routingu ¼ród³a.

Parametry opcjonalne w poleceniu MAIL <mail-parameters> s³u¿± do negocjacji
rozszerzeñ protoko³u i bêd± opisane pó¼niej. (2.2 sekcja - to juz pisalem -
moze gdzies dalej bêdzie napisane co dok³adnie mog± tutaj gadaæ)

Nastêpnym krokiem w transakcji jest polecenie RCPT. Jego sk³adnia to

RCPT TO:<forward-path> [ SP <rcpt-parameters> ] <CRLF>

Argumentem tego polecenia jest adres (z regu³y adres skrzynki oraz domena)
identyfikuj±cy odbiorcê. Je¶li zostanie on zaakceptowany przez serwer odpowiada
on komunikatem 250 OK i zapisuje sobie argument forward-path. Je¿eli adres nie
jest prawid³owy serwer odpowiada kodem 550. Z regu³y odpowied¼ wygl±da tak

\framebox{550 No such user}

Procedura ta mo¿e byæ powtórzona parokrotnie przyk³adowo

\framebox{C: MAIL FROM:<bob@example.org>
S: 250 Ok
C: RCPT TO:<alice@example.com>
S: 250 Ok}

W tym przypadku kopia maila trafi do 2 u¿ytkowników korzystaj±cych z tego
samego serwera pocztowego (tej samej domeny). Jak ju¿ wcze¶niej by³o wspomniane
dzieje siê to przy nawi±zaniu 1 po³±czenia.

Argument <forward-path> mo¿e zawieraæ wiêcej ni¿ jeden adres skrzynki
odbiorczej. Ze wzglêdów historycznych mog± siê tutaj pojawiæ równie¿ lista
hostów ¼ród³owych i skrzynka odbiorcza, jednak klienty SMTP (jak ju¿ wcze¶niej
by³o wspomniane) nie powinny korzystaæ z tej mo¿liwo¶ci. Serwer jednak musi byæ
przygotowany na tak± ewentualno¶æ, ale powinien zignorowaæ t± listê.

Dodatkowe parametry (<rcpt-parameters>) bêd± omówione pó¼niej.

Trzecim krokiem w trakcie transakcji jest polecenie DATA. Sk³adnia jego jest
prosta po prostu

\framebox{DATA <CRLF>}

Je¿eli polecenie zosta³o zaakceptowane serwer SMTP zwraca status 354 i prosi
klienta aby odpowiedzia³ jak najszybciej tre¶ci± maila, koñcz±c transmisjê
znacznikiem koñca maila. Przyk³adowo 

\framebox{354 End data with <CR><LF>.<CR><LF>}

Kiedy serwer otrzyma znak koñca wiadomo¶ci, a mail zostanie zapisany odbiorca
maila odpowiada standardowo 250 OK. Koniec wiadomo¶ci klient zaznacza poprzez
przes³anie linii zawieraj±cej jeden znak ''.'' (kropkê). Wystêpuj± dodatkowo
odpowiednia procedura zabezpieczaj±ca nieporozumienie zwi±zane z tym, ¿e przy
przekazywaniu tekstu wiadomo¶ci klient prze¶le linie zawieraj±c± jedynie
znak kropki ''.'' (4.5.2 sekcja).

Polecenie DATA mo¿e nie udaæ siê tylko w 2 przypadkach:

\begin{itemize}
  \item Je¿eli nie by³o polecenia MAIL albo RCPT albo oba zosta³y odrzucone
  wtedy serwer na DATA mo¿ê odpowiedzieæ
  \newline 
  \framebox{503 Command out of sequence} 
  \newline 
  albo te¿ 
  \newline
  \framebox{554 No valid recipients} 
  \newline
  Je¿eli która¶ z tych odpowiedzi (albo inna z serii 5yz czyli mówi±cych
  o b³êdzie) zostanie odebrana przez klienta, nie powinien on przesy³aæ tre¶ci
  wiadomo¶ci. Powinien on robiæ to tylko w przypadku odpowiedzi 354.
  \item Je¿eli polecenie DATA zosta³o zaakceptowane odpowiedzi± 354, mo¿e doj¶æ
  do nieudanego przes³ania maila tylko gdy transakcja jest niekompletna (brak
  zdefiniowancyh odbiorców), albo niespodziewanie odbiorca przestanie byæ
  dostêpny lub te¿ serwer z innych powodów (np. polityka ochrony) serwer
  postanowi odrzuciæ wiadomo¶æ.
\end{itemize}

W praktyce jednak niektóre serwery nie dokonuj± weryfikacji odbiorcy przed
otrzymaniem ca³ej wiadomo¶ci. Nie jest to dobre zachowanie, gdy¿ je¿eli po
zaakceptowaniu adresów odbiorców nagle po poleceniu DATA serwer odpowie ''550
mailbox not found'' to klient nie jest w stanie okre¶liæ, który adresat jest
nieprawid³owy.

Serwer nie powinien na tym etapie odrzucaæ wiadomo¶ci na podstawie nag³ówków
przekazanych w tre¶ci wiadomo¶ci (po poleceniu DATA).

Oto ca³a przyk³adowa, prawid³owa sesja protoko³u SMTP: 
\newline
Klient otwiera po³±czenie do serwera.
\newline
S: 220 smtp.example.com ESMTP Postfix
\newline
C: HELO relay.example.org
\newline
S: 250 Hello relay.example.org, I am glad to meet you
\newline
C: MAIL FROM:<bob@example.org>
\newline
S: 250 Ok
\newline
C: RCPT TO:<alice@example.com>
\newline
S: 250 Ok
\newline
C: RCPT TO:<theboss@example.com>
\newline
S: 250 Ok
\newline
C: DATA
\newline
S: 354 End data with <CR><LF>.<CR><LF>
\newline
C: From: "Bob Example" <bob@example.org>
\newline
C: To: Alice Example <alice@example.com>
\newline
C: Cc: theboss@example.com
\newline
C: Date: Tue, 15 Jan 2008 16:02:43 -0500
\newline
C: Subject: Test message
\newline
C:
\newline
C: Hello Alice.
\newline
C: This is a test message with 5 headers and 4 lines in the body.
\newline
C: Your friend,
\newline
C: Bob
\newline
C: .
\newline
S: 250 Ok: queued as 12345
\newline
C: QUIT
\newline
S: 221 Bye
\newline
Serwer zamyka po³±czenie.

\subsubsection{Polecenia do debugowania}



\subsubsection{Konstrukcja wiadomo¶ci}

Konstrukcja

\subsection{Obecne wykorzystanie protoko³u i jego forma}

Obecne wykorzystanie

\newpage

\section{Dzisiejsze narzêdzia do filtracji protoko³u SMTP}

Dzisiejsze

\subsection{Konieczno¶æ wprowadzenia filtracji}

Konieczno¶æ

\subsection{Produkty komercyjne}

Produkty komercyjne

\subsubsection{Clearswift}

Clearswift

\subsubsection{Aladdin eSafe}

Aladdin eSafe

\subsubsection{Surfcontrol Email Filter}

Suontrol Email Filter

\subsection{Produkty open-source}

\newpage

\section{Opracowany filtr poczty SMTP}

\subsection{Za³o¿enia projektu}

\subsection{Modu³y projektu}

\subsubsection{Parser wiadomo¶ci}

\subsubsection{Parser regu³}

\subsubsection{Analizator wiadomo¶ci}

\subsubsection{Kolejka}

\subsection{Kompilacja, konfiguracja i uruchomienie projektu}

\subsection{Testy wydajno¶ciowe}

\newpage

\section{Spostrze¿enia, wnioski}

\newpage

