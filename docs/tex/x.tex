%%%% ZAWARTO¦Æ OBLIGATORYJNA - NALE¯Y DOSTOSOWAÆ %%%%%%%%%%%%%%%%%%%%%%%%

%% Tytu³ opracowania
\title{Filtr protoko³u SMTP\\
%% Tu nale¿y podaæ nazwê przedmiotu, którego tyczy sprawozdanie.
\begin{small}
Praca in¿ynierska
\end{small}}

%% Autorzy opracowania, po dwie linie z nazwiskiem i adresem e-mail na
%% osobê. Ka¿dy opis oddzielony separatorem 'and'.
%% \author{Tomasz Jordan Kruk\\ T.Kruk@ia.pw.edu.pl \and Jan Nieznany\\ jn@n.pl}
\author{Zbigniew Artemiuk\\ Z.Artemiuk@stud.elka.pw.edu.pl}

% To stworzy w³a¶ciwy format tytu³u oraz spis tre¶ci.
\maketitle

\newpage

\tableofcontents



%%%% PONI¯EJ ZAWARTO¦Æ DOWOLNA %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Dokument podzielony powinien byæ na elementy: section, subsection,
% ewentualnie subsubsection.

\newpage

\section{Wstêp}

Obecnie w Internecie, pomimo szeregu rozwijaj±cych siê form komunikacji,
chocia¿by technologii takich jak tekstowa komunikacja czasu rzeczywistego (czyli
IM - instant messaging i popularne chaty) czy te¿ jeszcze bardziej zaawansowanych
technologii, które umo¿liwiaj± przesy³anie g³osu oraz wideo (chocia¿by Skype),
pospolite maile ca³y czas znajduj± zastosowanie. U¿ywamy ich chyba obecnie najcze¶ciej
do kontaktów biznesowych, rodzinnych, przyjacielskich, g³ównie w celach informacyjnych
(czyli sam tekst), jak równie¿ do przekazywania niewielkich plików. Chyba ka¿dy
internauta legitymuje siê przynajmniej jedn± skrzynk± mailow± (a czasami jest
ich znacznie wiêcej). Ka¿dy spotka³ siê tak¿e z niechcian±
poczt± (niechcianymi mailami), nazywan± bardzo ogólnym okre¶leniem Spam, i
narzêdziami (chocia¿by tymi wbudowanymi w klientów pocztowych dostêpnych z
poziomu przegl±darki internetowej), które umo¿liwiaj± odseparowanie takiej
poczty, od tej która niesie interesuj±c± nas zawarto¶æ merytoryczn±. Separacja
ta to tzw. filtrowanie ze wzglêdu na obiekt filtracji zwane filtracja poczty.
Dokonanie filtracji wymaga jednak poznania dok³adnie w jaki sposób
transportowane s± nasze maile, a to wszystko zawarte jest w protokole Simple
Mail Transfer Protocol (w skrócie SMTP).
Co¶ tutaj jeszcze dopisaæ o protokole, o jego wadach, o konieczno¶ci filtracji.

\newpage

\section{Cel i zakres pracy}

Celem pracy jest zaprojektowanie oprogramowania, które po
uruchomieniu umo¿liwia³oby filtracjê wiadomo¶ci w ramach protoko³u SMTP.
Oprogramowanie to by³oby konfigurowalne poprzez plik tekstowy zawieraj±cy
regu³y dotycz±ce wiadomo¶ci SMTP i zachowania oprogramowania po napotkaniu
takiej wiadomo¶ci. Regu³y te dawa³yby mo¿liwo¶æ nastêpuj±cej filtracji:

\begin{itemize}
  \item wykrywanie wiadomo¶ci posiadaj±cych b±d¼ nie posiadaj±cych okre¶lony
  nag³ówek (nag³ówki)
  \item wykrywanie wiadomo¶ci posiadaj±cych b±d¼ nie posiadaj±cych okre¶lonej
  frazy w nag³ówku (nag³ówkach)
  \item wykrywanie wiadomo¶ci posiadaj±cych b±d¼ nie posiadaj±cych okre¶lonej
  frazy w nag³ówkach czê¶ci maila (gdy nie jest to prosty mail)
  \item wykrywanie okre¶lonych content-type-ow w wiadomo¶ciach
  \item wykrywanie wiadomo¶ci o okre¶lonej wielko¶ci czê¶ci (je¿eli wiadomo¶æ
  jest jednoczê¶ciowa to tyczy siê tre¶ci wiadomo¶ci)
\end{itemize}
 
Po natrafieniu na wiadomo¶æ spe³niaj±c± kryteria danej regu³y zostanie ona w
zale¿no¶ci od zapisu w konfiguracji: 

\begin{itemize}
  \item odrzucona (wyfiltrowana)
  \item przepuszczona, a jej obecno¶æ zostanie zaznaczona w logach
  \item przepuszczona 
\end{itemize}

\newpage

\section{Protokó³ SMTP}

\subsection{Historia powstania}

\subsubsection{ARPANET czyli pocz±tki Internetu}

Historia powstania protoko³u SMTP jest ¶ci¶le zwi±zana z pocz±tkami Internetu.
Internet za¶ i jego kreowanie zwi±zane jest bezpo¶rednio ze swoim przodkiem
czyli ARPANETEm.

ARPANET (Advanced Research Projects Agency Network) zosta³ stworzony przez
przez jedn± z agencji United States Department of Defense (departament
bezpieczeñstwa Stanów Zdjednoczonych) o nazwie ARPA (Advanced Research
Projects Agency). Nazwa agencji zosta³a pó¼niej przekszta³cona na DARPA (D od
Defence). Agencja ta mia³a zaj±c siê rozwojem nowych technologii na potrzebê
amerykañskiego wojska.

W miarê wchodzenia w ¿ycie komputerów wykorzystywanych w ramach agencji
powsta³a idea stworzenia sieci pomiêdzy nimi, która to umo¿liwi³aby
komunikacje pomiêdzy ich u¿ytkownikami. Idea ta zosta³a po raz pierwszy
zaproponowana przez Josepha Carla Robnetta Licklidera z firmy Bolt, Beranek and
Newman (obecnie BBN Technologies) w sierpniu 1962 w serii notatek na temat
koncepcji ''Miêdzygalaktycznej Sieci Komputerowej''. Zawiera³a ona prawie
wszystko czego mo¿emy do¶wiadczyæ w dzisiejszym Internecie.

W pa¼dzierniku 1963 roku Licklider zosta³ mianowany szefem programu Behavioral
Sciences and Command and Control w ARPA. Przekona³ on wtedy Ivana Sutherlanda i
Boba Taylora, ¿e jego wizja jest czym¶ naprawdê istotnym. Sam Licklider nie
doczeka³ jednak ¿adnych konkretnych prac w kierunku jej urzeczywistnienia, gdy¿
opu¶ci³ ARPA.

ARPA i Taylor ca³y czas byli zainteresowanie stworzeniem sieci komputerowej,
a¿eby zapewniæ naukowcom pracuj±cym w ramach ARPA w ró¿nych lokalizacjach,
dostêp do innych komputerów, które firma oferowa³a. Istotne by³o tak¿e, aby
nowe oprogramowanie i rezultaty badañ by³y jak najszybciej widoczne dla ka¿dego
u¿ytkownika sieci. Sam Taylor posiada³ 3 ró¿ne terminale, które dawa³y mu
pod³±czenie do 3 ró¿nych komputerów - jeden do SDC Q-32 w Santa Monica, drugi w
ramach projektu Project Genie do komputera na Uniwersytecie w Kalifornii
(Berkley) i ostatni do komputera z Multicsem w MIT (The Massachusetts Institute of Technology).

Taylor w taki sposób opowiada³ od pod³±czeniu do tych komputerów:
'' Dla ka¿dego z tych terminali mia³em inny zestaw poleceñ. Dlatego te¿ kiedy
rozmawia³em z kim¶ z Santa Monica, a po¼niej chcia³em ten sam temat
skonsultowaæ z kim¶ z Berkley albo MIT, musia³em przesi±¶æ siê do innego
terminala. Oczywistym wtedy wyda³o mi siê, ¿e musi byæ 1 terminal, który
obs³u¿y te 3 po³±czenia. Idea ta to w³a¶nie ARPANET''

Do po³owy 1968 roku kompletny plan sieci zosta³ stworzony i po zatwierdzeniu
przez ARPA, zapytanie ofertowe RFQ (Request For Quotation) zosta³o pos³ane do
140 potencjalnych wykonawców. Wiêkszo¶æ potraktowa³a propozycjê jako dziwaczn±.
Tylko 12 firm z³o¿y³o oferty z czego 4 zosta³y uznane za najwa¿niejsze. Do
koñca roku wy³oniono 2 firmy, z których ostatecznie 7 kwietnia 1969 roku
zosta³a wybrana firma BBN.

Propozycja BBN by³a najbli¿sza planom ARPA. Pomys³em ich by³o stworzenie sieci
z ma³y komputerów zwanych Interface Message Processors (bardziej znanych jako
IMPs), które to obecnie nazywamy routerami. IMPsy z ka¿dej strony zapewnia³y
funkcje przechowywania i przekazywania pakietów, a po³±czone by³y miêdzy sob±
przy u¿yciu modemów podpiêtych do ³±czy dzier¿awionych (o przepustowo¶ci 50
kbit/sekundê). Komputery pod³±czone by³y do IMPsów poprzez specjalny bitowy
interfejs. W ten sposób stawa³y siê one czê¶ci± sieci ARPANET.

Do zbudowania pierwszej generacji IMPsów BBN wykorzysta³a komputer Honeywell
DDP-516. Zosta³ on wyposa¿ony w 24kB pamiêci rdzenia (z mo¿liwo¶ci±
rozszerzenia) oraz 16 kana³ów Direct Multiplex Control (DMC) do bezpo¶redniogo
dostêpu do tej pamiêci. Poprzez DMC pod³±czane by³y komputery u¿ytkowników
(hosty) i modemy. Dodatkowo 516 otrzyma³ ezstaw 24 lamp, które pokazywa³y
status kana³ów komunikacyjnych IMPa. Do ka¿dego IMPa mo¿na by³o pod³±czyæ do
czterech hostów i móg³ siê on komunikowaæ z 6 zdalnymi IMPami poprzez
wspó³dzielone ³±cza.

Zespó³ z BBN (pocz±tkowo 7 osób) szybko stworzy³ pierwsze dzia³aj±ce jednoski
(IMPy). Ca³y system, który zawiera³ zarówno sprzêt jak i pierwsze
oprogramowania zarz±dzaj±ce pakietami, zosta³ zaprojektowany i zainstalowany w
ci±gu 9 miesiêcy.

Pocz±tkowo ARPANET sk³ada³ siê z 4 IMPów. Zosta³y one zainstalowane w:

\begin{itemize}
  \item UCLA (University of California, Los Angeles), gdzie Leonard Kleinrock
  za³o¿y³ centrum pomiaru sieci (Network Measurment Center)
  \item The Stanford Research Institute's Augmentation Research Center, gdzie
  Douglas Engelbert stworzy³ system NLS, który miêdzy innymi wprowadzi³ pojêcie
  hypertextu
  \item UC Santa Barbara
  \item The University of Utah's Graphics Department, gdzie przebywa³ ówcze¶nie
  Ivan Sutherland
\end{itemize}

\subsubsection{Piersze wiadomo¶ci w ARPANETcie}

Pierwsza komunikacja host-host w sieci ARPANET wykorzystywa³a protokó³ 1822,
który definiowa³ sposób w jakis host przesy³a³ wiadomo¶æ do IMPa. Format
wiadomo¶ci by³ tak zaprojektowany, ¿eby bez problemu móg³ pracowaæ z szerokim
zakresem architektur. Zasadniczo wiadomo¶æ sk³ada³a siê z:

\begin{itemize}
  \item typu wiadomo¶ci
  \item adresu hosta
  \item pola z danymi
\end{itemize}

W celu wys³ania wiadomo¶ci do innego hosta, host wysy³aj±cy powinien sformatowaæ
wiadomo¶æ tak, aby ta zawiera³a adres hosta docelowego oraz dane, a nastêpnie
dokonaæ transmisji wiadomo¶ci przez interfejs sprzêtowy 1822. IMP dostrze¿e
dostarczenie wiadomo¶ci albo poprzez dostarczenie jej bezpo¶rednio do hosta
docelowego albo poprzez przekazanie jej do kolejnego IMPa. Kiedy wiadomo¶æ
zosta³a odebrana przez docelowego hosta, IMP do którego host by³ pod³±czony
wysy³a potwierdzenie odbioru (zwane Ready for Next Message or RFNM) do hosta
wysy³aj±cego.

W przeciwieñstwie do obecnych protoko³ów datagramowych w Interecie (takich jak
no IP), ARPANETowy porotokó³ 1822 zapewnia³ niezawodno¶æ w taki sposób, ¿e
informowa³ o niedostarczonej wiadomo¶ci. Niemniej protokó³ 1822 nie by³
odpowiedni do ¿onglowania wieloma po³±czeniami w ró¿nych aplikacjach
uruchomionych na pojedynczym ho¶cie. Problem ten zosta³ rozwi±zany dziêki
wprowadzeniu na hostach Network Control Program (NCP), dziêki któremu mo¿liwe
by³o niezawodne, z kontro³± przep³ywu, dwukierunkowe po³±czenia pomiêdzy
ró¿nymi procesami na ró¿nych hostach. NCP implementowa³ kolejn± warstwê
znajduj±c± siê na górze stosu protoko³ów. Dziêki niemu aplikacje, które mia³y
mieæ ju¿ jak±¶ konkretn± funkcjonalno¶æ, mog³y wykorzystywaæ spójny interfejs i
korzystaæ swobodnie z dobrodziejstw ARPANETu czyli wykonywaæ po³±czenia do
innych aplikacji przez sieæ. 

\subsubsection{SNDMSG i READMAIL}

Na pocz±tku roku 1970, powsta³ program (a w zasadzie 2
oddzielne) do wysy³ania i odbierania wiadomo¶ci. Zaimplementowa³ go Ray
Tomlinson. Programy te to SNDMSG i READMAIL. Pierwsza wersja tych
programów, by³a kolejn± implementacj±, która umo¿liwia³a wymiane
informacji miêdzy u¿ytkownikami jednej maszyny (jednego hosta), a konkretnie
komponowanie, adresowanie i wysy³anie wiadomo¶ci do skrzynek u¿ytkowników. Ju¿
jednak w 1971 Tomlinson stworzy³ pierwsz± aplikacjê ARPANETow± (w ramach prac
nad systemem TENEX), która umo¿liwia³a wysy³anie wiadomo¶ci do dowolnych
hostów. Tomlinson dokona³ usprawnieñ w programie SNDMSG przy okazji pracy nad
projektem CPYNET, którego celem by³o stworzenie protoko³u do wymiany plików
miêdzy komputerami w sieci.

Skrzynkê emailow± by³ wówczas by³ zwyk³y plik o okre¶lonej nazwie. Specjaln±
w³a¶ciwo¶ci± jego by³o to, ¿e mia³ ochronê tak±, ¿e umo¿liwia³ innym
u¿ytkownikom dopisywanie do pliku. Mogli oni wiêc pozostawiaæ kolejne
wiadomo¶ci ale nie mogli ich czytaæ ani nadpisywaæ wcze¶niejszych (jedynie
w³a¶ciciel móg³ to robiæ). Tomilson zauwa¿y³, ¿e CPYNET mo¿e dopisywaæ zawarto¶æ
do pliku skrzynki mailowej, na takiej zasadzie jak SNDMSG (SNDMSG umia³
zapisywaæ wtedy tylko na lokalnej maszynie). Dlatego te¿ SNDMSG móg³ po prostu
skorzystaæ z kodu CPYNET i bezpo¶rednio dostarczaæ wiadomo¶ci poprzez
po³±czenie sieciowe do zdalnych skrzynek poprzez dopisywanie kolejnych
informacji do plików na innych hostach.

Brakuj±c± czê¶ci± by³a mo¿liwo¶æ dopisywania do plików przy pomocy CPYNET.
Dotychczas móg³ on tylko s³aæ i odbieraæ pliki. Dodanie tej funkcjonalno¶ci nie
by³o czym¶ wielkim dla twórców protoko³u i funkcjonalno¶æ ta wkrótce
zainstnia³a.

Nastêpnie Tomilson w³±czy³ kod CPYNET do SNDMSG. Pozosta³o jedynie rozró¿nienie
maili lokalnych od maili zdalnych. Dlatego te¿ Tomilson zdecydowa³ siê, ¿e
maile zdalne bêd± rozpoznawane po tym, ¿e po loginie (czyli wyznaczniku
u¿ytkownika do którego wiadomo¶æ jest s³ana) nast±pi specjalny znaczek @ (ang.
at, a polska znana wszystkim ma³pa) , a tu¿ po nim nazwa hosta czyli zdalnego
komputera, na którym skrzynkê ma dany loginem u¿ytkownik. Tomilson tak
powiedzia³ o wyborze ma³py jako znaczka rozdzielaj±cego login od hosta: ''I am
frequently asked why I chose the at sign, but  the at sign just makes sense''
(w wolnym t³umaczeniu: Jestem czêsto pytany czemu wybra³em znaczek ma³py, ale
on po prostu mia³ sens).

Pierwsza wiadomo¶æ zosta³a przes³ana pomiêdzy maszynami, które fizycznie by³y
obok siebie. Jedyne po³±czenie jakie by³o miêdzy maszynami (oprócz pod³ogi ;] )
by³o za po¶rednictwem sieci ARPANET. Tomilson przes³a³ wiele wiadomo¶ci do
samego siebie z jednej maszyny na drug±. Pierwsze tre¶ci wiadomo¶ci od razu
zosta³y zapomniane. Najprawdopodobniejsza ich tre¶æ by³a w stylu QWERTYUIOP.
Kiedy Tomilson by³ zadowolony z programu wys³a³ do swoich kolegów z zespo³u
wiadomo¶æ z instrukcj± jak s³aæ wiadomo¶ci przez sieæ. I tak pierwsza
wys³ana wiadomo¶æ og³osi³a swoje istnienie.

Te pierwsze wiadomo¶ci zosta³y wys³ane pod koniec 1971 roku. Nastêpne wydanie
TENEXa, które ukaza³o siê w 1972 roku, zawiera³o SNDMSG, z mo¿liwo¶ci±
wysy³ania maili przy u¿yciu sieci ARPANET. Protokó³ CPYNET wkrótce zosta³
zast±piony prawdziwym protoko³em do transferu plików i posiada³ specyficzne
dodatki do obs³ugi maila. 

\subsubsection{MAIL i MLFL w protokole FTP}
Protoko³em, o którym wcze¶niej by³a mowa by³ protokó³ FTP, którego specyfikacja
wstêpna zosta³a zawarta w RFC (Request For Comment) 114. Kolejne ulepszenia
protoko³u zosta³y dokonana w roku 1972 i wtedy te¿ wesz³y do niego nowe polecenia pozwalaj±ce
korzystaæ ze skrzynek emailowych. Poleceniami tymi by³y:

\begin{itemize}
  \item MAIL - polecenie to pozwala³o u¿ytkownikowi przy pomocy telnetu wys³aæ
  maila. Pomocne to by³o gdy u¿ytkownik ten nie korzysta³ ze swojego hosta i
  logowa³ sie do niego poprzez protokól telnet
  \item MLFL - polecenie to pozwala³o na normalne skonstruowanie maila i
  przes³anie odpowiednio wskazanego pliku jako jego tre¶ci
\end{itemize}

Protokó³ ten sta³ siê a¿ do roku 1980 standardem przesy³ania emaili w
ARPANETcie. Wtedy to zosta³ wypart przez protokó³ SMTP, który z pewnymi
usprawnieniami funkcjonuje a¿ do dzi¶.

\subsubsection{Rozwój innych programów do obs³ugi poczty}

Zanim jednak powsta³ protokó³ SMTP ca³y czas pracowano nad rozwojem ówczesnych
programów chocia¿by do odbioru maili. W ten sposób na pro¶be Steve'a Lukasika
Lawrence Roberts, ówczesny dyrektor IPTO, stworzy³ program RD, który sk³ada³
siê z makr w edytorze TECO (Text Editor and COrrector).

Program RD umo¿liwia³:

\begin{itemize}
  \item sortowanie emaili po temacie i dacie
  \item czytanie, zapisywanie i czytanie wiadomo¶ci w dowolnym porz±dku
\end{itemize}

RD nie powsta³ wiêc jako wynik badañ, ale z czysto praktycznej potrzeby
swobodnego zarz±dzania emailami.

Wkrótce powsta³y te¿ kolejne ulepszenia programu RD oraz SENDMSG, takie jak NRD
czy WRD, które to wprowadza³y kolejne ulepszenia istniej±cych ju¿
implementacji. 

Warte wspomnienia jest tak¿e powstanie programu MSG, który umo¿liwia³ miêdzy
innymi przekazywanie maili (ang. forwarding), konfigurowalny interfejs, czy te¿
polecenie Odpowiedz (ang. Answer), które automatycznie uzupe³nia³o adres
odbiorcy. MSG mo¿na by³o nazwaæ pierwszym nowoczesnym programem pocztowym. 

W 1977 roku ró¿ne formaty wiadomo¶ci zosta³y zebrane w jedn± spójn±
specyfikacjê co doprowadzi³o do stworzenia RFC 733.  Specyfikacja ta po³±czy³a
wcze¶niej istniej±ce dokumentacjê z odrobion± innowacji i by³a jednocze¶nie
pierwszym RFC, które deklarowa³o standard Internetowy (ówcze¶nie ARPANETowy).

\subsection{Szczegó³y protoko³u}

W 1982 roku powsta³o g³ówne RFC opisuj±ce protokó³ SMTP - RFC 821. W 2001 roku
zosta³o ono rozbudowane i powsta³ dokument, który jest obowi±zuj±c± obecnie
specyfikacj± protoko³u. Informacje te zawarte zosta³y w RFC o numerze 2821.

\subsubsection{Model protoko³u, podstawy}

\includegraphics[scale=0.4]{klient_serwer_smtp.png}

Komunikacja w protokole SMTP oparta jest na nastepuj±cym modelu: kiedy klient
SMTP posiada wiadomo¶æ, któr± chce przetransmitowaæ ustanawia dwukierunkowy
kana³ transmisyjny z serwerem SMTP. Klient SMTP bierze na siebie
odpowiedzialno¶æ za przetransportowanie wiadomo¶ci do jednego lub wielu
serwerów SMTP, lub zg³oszenie b³êdu je¶li operacji przekazania maila nie
powiod³a siê. 

Adres serwera SMTP klient determinuje poprzez zamianê domeny podanej w
adresie na po¶redni host (Mail eXchanger) lub ostateczny host docelowy.

Serwer SMTP mo¿e byæ ostatecznym celem albo te¿ po¶rednim ''przeka¼nikiem''
(po odebraniu wiadomo¶ci to on mo¿e przej±æ rolê klienta SMTP) albo ''bram±''
(mo¿e transportowaæ wiadomo¶æ dalej u¿ywaj±c innego protoko³u ni¿ SMTP).
Polecenia protoko³u SMTP generowane s± przez klienta i posy³ane do serwera.
Odpowiedzi s³ane s± jak reakcja na ¿±dania klienta.

Innymi s³owy wiadomo¶æ mo¿e byæ przetransportowana w trakcie pojedynczego
po³±czenia pomiêdzy pierwotnym adresatem, a ostatecznym klientem albo mo¿e
sk³adaæ siê z kilku po¶rednich po³±czeñ. W obu przypadkach zachowana jest
odpowiedzialno¶æ za wiadomo¶æ - protokó³ wymaga od serwera wziêcia
odpowiedzialno¶ci za dostarczenie wiadomo¶ci albo w przypadku nieprawid³owo¶ci
za zg³oszenie b³êdu.

Kiedy kana³ transmisyjny zostanie zestawiony klient SMTP inicjuje transakcjê
maila. Sk³ada siê ona z serii poleceñ, które maj± na celu wyspecyfikowanie
nadaj±cego i celu wiadomo¶ci, a nastêpnie przes³ania jej zawarto¶ci (oczywi¶cie
z nag³ówkami, które wchodz± w jej sk³ad). Kiedy ta sama wiadomo¶æ jest
adresowana do wielu odbiorców, protokó³ przesy³a jedn± kopiê wiadomo¶æ dla
wszystkich odbiorców w obrêbie jednego hosta.

Serwer reagujê na ka¿d± komendê odpowiedziami. Wskazuj± one akceptacjê komendy
(tej przes³anej od klienta) i oczekiwanie na kolejne, b±d¼ te¿ wyst±pienie
tymczasowych albo sta³ych b³êdów.

Kiedy mail zostanie przetransmitowany, klient mo¿e zamkn±æ po³±czniee albo te¿
zainicjowaæ kolejn± tranzakcjê innego maila. Dodatkowo klienty SMTP mog± u¿ywaæ
po³±czenia z serwerem w celach np. weryfikacji adresu email b±d¼ te¿ uzyskanie
adresów subskrybentów listy dyskusyjnej.

Jak zosta³o wcze¶niej zasugerowane transmisja w protokole mo¿e odbywaæ siê
bezpo¶rednio pomiêdzy hostem ¶l±cym wiadomo¶c, a hostem docelowym, kiedy s± one
po³±czone tym samym serwisem transportowym. Kiedy tak nie jest, transmisja
odbywa siê poprzez hosty po¶rednie. Hosty te wybierane s± poprzez
mechanizm serwera domen (DNS) zwany Mail eXchanger.

\subsubsection{Model rozszerzeñ}

W wyniku prac, które rozpoczê³y siê oko³o dekadê po wydaniu pierwszego RFC
dotycz±cego protoko³u SMTP (czyli RFC 822), protokó³ zosta³ rozszerzony i
pojawi³y siê w nim nowe funckjonalno¶ci. Standardowy model zosta³ wiêc
zmodyfikowany o dodatkowe serwisy. Pozwalaj± one na ustalenie pomiêdzy klientem,
a serwerem us³ug dodatkowych jakie s± oni w stanie obs³u¿yæ (poza podstawowymi
wymaganiami SMTP). Mechanizm rozszerzeñ SMTP okre¶la ¶rodki, za pomoc± których
klient i serwer mog± dokonaæ wzajemnego ropoznania, a serwer mo¿e tak¿e
poinformowaæ klienta o rozszerzeniach, które on wspiera.

Wspó³czesna implementacja SMTP musi obs³ugiwaæ podstawowe mechanizmy
rozszerzeñ. Przyk³adowo serwer musi wspieraæ komendê EHLO, je¶li nawet nie
implementuje innych specyficznych rozszerzeñ, natomiast klient powinien
sk³aniaæ siê ku u¿ywaniu komendy EHLO ni¿ HELO. 

SMTP jest szeroko u¿ywany i pojawi³o siê wiele bardzo dobrych implementacji
protoko³u wyposa¿onych w liczne rozszerzenia. Spo³eczno¶æ w Internecie jednak
uwa¿a, ¿e niektóre z serwisów s± bardzo wa¿ne, mimo tego, ¿e nie powsta³y gdy
protokó³ by³ po raz pierwszy projektowany. Je¶li serwisy te maj± zostaæ dodane
to w zachowaniem zgodno¶ci wstecz. 

Obecnie szkielet rozszerzeñ sk³ada siê z:

\begin{itemize}
  \item Polecenia EHLO, które powinno byæ u¿ywane zamiast wcze¶niejszego HELO
  \item Rejestr rozszerzeñ SMTP
  \item Dodatkowe parametry do poleceñ SMTP MAIL i RCPT
  \item Opcjonalnych zast±pieñ poleceñ w protokole SMTP, jak na przyk³ad DATA w
  transmisji nie przy pomocy ASCII (ang. pipelining opisany pó¼niej)
\end{itemize}

Si³± SMTP jest jego prostota. Do¶wiadczenia z protoko³ami pokazuj±, ¿e te z
kilkoma mo¿liwo¶ciami staj± siê powszechnie u¿ywanymi, podczas gdy te z
wieloma mo¿liwo¶ciami przestaj± byæ czytelne. 

\subsubsection{Sesja protoko³u}

Sesja jest inicjowana kiedy klient otwiera po³±czenie do serwera i serwer
odpowie wiadomo¶ci± zapraszaj±c±.

SMTP serwer po pod³±czeniu siê klienta mo¿e po kodzie powitalnym 220
poinformowaæ klienta o swoim oprogramowaniu i jego wersji.

\framebox{220 mail.foo.com SuperSMTP v 6.1.2 Service ready}

Protokó³ SMTP pozwala serwerowi na odmówienie transakcji podczas gdy formalnie
umo¿liwia na pod³±czenie siê do serwera SMTP. Wtedy zamiast kodu 220 serwer
odpowiada kodem 554. 

\framebox{554 Transaction failed (Or, in the case of a
connection-opening response, ''No SMTP service here'')}

Serwer w tym przypadku musi czekaæ zanim zakoñczeny po³±czenie na
komende QUIT ze strony klienta. W trakcie tego oczekiwania wszystkie inne
komendy zostan± potraktowane odpowiedzi± 503.

\framebox{503 Bad sequence of commands}

Kiedy serwer przywita siê z klientem i klient otrzyma wiadomo¶æ powitaln±,
standardowo wysy³a on polecenie EHLO do serwera i w wiadomo¶ci tej przedstawia
siê.
 
\framebox{EHLO bar.com}

U¿ycie komendy EHLO wskazuje, ¿e klient jest w stanie obs³u¿yæ
rozszerzenia protoko³u i prosi serwer o ich listê. Starsze systemy SMTP, które
nie obs³uguj± rozszerzeñ protoko³u czy te¿ starsze klienty SMTP, które nie
wymagaj± tych¿e rozszerzeñ, mog± u¿ywaæ komendy HELO.

\framebox{HELO bar.com}

Serwer w odpowiedzi na HELO nie powinien zwróciæ listy rozszerzeñ. Je¿eli
serwer zwróci na EHLO 

\framebox{500 Command not recognized}

, wtedy klient powinien byæ w stanie przes³aæ komende HELO.

Nastêpnie dochodzi do transakcji maila. Rozpoczyna siê ona poleceniem MAIL,
która identyfikuje nadawcê. Po niej nastêpuje seria poleceñ RCPT, które
przekazuj± informacjê o odbiorcy, a na sam koniec DATA czyli cia³o maila, które
koñczone jest wyznacznikiem koæa maila. Znacznik ten potwierdza transakcjê. 

Pierwszym krokiem w procedurze transakcji jest komenda MAIL. Ogólna jej
sk³adnia wygl±da nastêpuj±co:

\framebox{MAIL FROM:<reverse-path> [SP <mail-parameters> ] <CRLF>}

przyk³adowo

\framebox{MAIL FROM:<bob@example.org>}

Poleceni to mówi odbiorcy SMTP (serwerowi), ¿e rozpoczynana jest nowa
transakcja. Dlatego powinien on zresetowaæ (chyba na danym po³±czeniu?)
wszystkie poprzednie stany tabel i buforów, w³±czaj±c w to odbiorców i dane
maila. Argument <reverse-path> zawiera adres ¼ród³owej skrzynki mailowej, która
mo¿e pos³u¿yæ w celu informacji o ewentualnych b³êdach (bêdzie dalej opisane
[4.2]). Je¶li polecenie zostanie zaakcpetowane serwer odpowiada poleceniem 250
OK. 

\framebox{250 OK}

Je¶li przes³any adres nie zosta³ zaakceptowany serwer musi odpowiedzieæ czy
b³±d jest sta³y (zawsze bêdzie siê pojawia³ przy tym adresie) czy tymczasowy
(klient bêdzie móg³ wykonaæ ponown± próbê, która mo¿e zakoñczyæ siê sukcesem).
Czasami jednak serwer mo¿e dokonaæ akceptacji adresu przekazanego w poleceniu
MAIL i dopiero po analizie adresów przes³anych w poleceniu RCPT, mo¿e zg³osiæ
b³±d. Normalnie jednak gdy b³±d jest sta³y odpowied¼ serwera to

\framebox{550 mailbox not found}

albo tymczasowy

\framebox{503 i co tutaj?}

Historycznie <reverse-path> mo¿e nie tylko zawieraæ adres skrzynki, jednak¿e
obecne oprogramowanie nie powinno u¿ywaæ routingu ¼ród³a.

Parametry opcjonalne w poleceniu MAIL <mail-parameters> s³u¿± do negocjacji
rozszerzeñ protoko³u i bêd± opisane pó¼niej. (2.2 sekcja - to juz pisalem -
moze gdzies dalej bêdzie napisane co dok³adnie mog± tutaj gadaæ)

Nastêpnym krokiem w transakcji jest polecenie RCPT. Jego sk³adnia to

RCPT TO:<forward-path> [ SP <rcpt-parameters> ] <CRLF>

Argumentem tego polecenia jest adres (z regu³y adres skrzynki oraz domena)
identyfikuj±cy odbiorcê. Je¶li zostanie on zaakceptowany przez serwer odpowiada
on komunikatem 250 OK i zapisuje sobie argument forward-path. Je¿eli adres nie
jest prawid³owy serwer odpowiada kodem 550. Z regu³y odpowied¼ wygl±da tak

\framebox{550 No such user}

Procedura ta mo¿e byæ powtórzona parokrotnie przyk³adowo

\framebox{C: MAIL FROM:<bob@example.org>
S: 250 Ok
C: RCPT TO:<alice@example.com>
S: 250 Ok}

W tym przypadku kopia maila trafi do 2 u¿ytkowników korzystaj±cych z tego
samego serwera pocztowego (tej samej domeny). Jak ju¿ wcze¶niej by³o wspomniane
dzieje siê to przy nawi±zaniu 1 po³±czenia.

Argument <forward-path> mo¿e zawieraæ wiêcej ni¿ jeden adres skrzynki
odbiorczej. Ze wzglêdów historycznych mog± siê tutaj pojawiæ równie¿ lista
hostów ¼ród³owych i skrzynka odbiorcza, jednak klienty SMTP (jak ju¿ wcze¶niej
by³o wspomniane) nie powinny korzystaæ z tej mo¿liwo¶ci. Serwer jednak musi byæ
przygotowany na tak± ewentualno¶æ, ale powinien zignorowaæ t± listê.

Dodatkowe parametry (<rcpt-parameters>) bêd± omówione pó¼niej.

Trzecim krokiem w trakcie transakcji jest polecenie DATA. Sk³adnia jego jest
prosta po prostu

\framebox{DATA <CRLF>}

Je¿eli polecenie zosta³o zaakceptowane serwer SMTP zwraca status 354 i prosi
klienta aby odpowiedzia³ jak najszybciej tre¶ci± maila, koñcz±c transmisjê
znacznikiem koñca maila. Przyk³adowo 

\framebox{354 End data with <CR><LF>.<CR><LF>}

Kiedy serwer otrzyma znak koñca wiadomo¶ci, a mail zostanie zapisany odbiorca
maila odpowiada standardowo 250 OK. Koniec wiadomo¶ci klient zaznacza poprzez
przes³anie linii zawieraj±cej jeden znak ''.'' (kropkê). Wystêpuj± dodatkowo
odpowiednia procedura zabezpieczaj±ca nieporozumienie zwi±zane z tym, ¿e przy
przekazywaniu tekstu wiadomo¶ci klient prze¶le linie zawieraj±c± jedynie
znak kropki ''.'' (4.5.2 sekcja).

Polecenie DATA mo¿e nie udaæ siê tylko w 2 przypadkach:

\begin{itemize}
  \item Je¿eli nie by³o polecenia MAIL albo RCPT albo oba zosta³y odrzucone
  wtedy serwer na DATA mo¿ê odpowiedzieæ
  \newline 
  \framebox{503 Command out of sequence} 
  \newline 
  albo te¿ 
  \newline
  \framebox{554 No valid recipients} 
  \newline
  Je¿eli która¶ z tych odpowiedzi (albo inna z serii 5yz czyli mówi±cych
  o b³êdzie) zostanie odebrana przez klienta, nie powinien on przesy³aæ tre¶ci
  wiadomo¶ci. Powinien on robiæ to tylko w przypadku odpowiedzi 354.
  \item Je¿eli polecenie DATA zosta³o zaakceptowane odpowiedzi± 354, mo¿e doj¶æ
  do nieudanego przes³ania maila tylko gdy transakcja jest niekompletna (brak
  zdefiniowancyh odbiorców), albo niespodziewanie odbiorca przestanie byæ
  dostêpny lub te¿ serwer z innych powodów (np. polityka ochrony) serwer
  postanowi odrzuciæ wiadomo¶æ.
\end{itemize}

W praktyce jednak niektóre serwery nie dokonuj± weryfikacji odbiorcy przed
otrzymaniem ca³ej wiadomo¶ci. Nie jest to dobre zachowanie, gdy¿ je¿eli po
zaakceptowaniu adresów odbiorców nagle po poleceniu DATA serwer odpowie ''550
mailbox not found'' to klient nie jest w stanie okre¶liæ, który adresat jest
nieprawid³owy.

Serwer nie powinien na tym etapie odrzucaæ wiadomo¶ci na podstawie nag³ówków
przekazanych w tre¶ci wiadomo¶ci (po poleceniu DATA).

Oto ca³a przyk³adowa, prawid³owa sesja protoko³u SMTP: 
\newline
Klient otwiera po³±czenie do serwera.
\newline
S: 220 smtp.example.com ESMTP Postfix
\newline
C: HELO relay.example.org
\newline
S: 250 Hello relay.example.org, I am glad to meet you
\newline
C: MAIL FROM:<bob@example.org>
\newline
S: 250 Ok
\newline
C: RCPT TO:<alice@example.com>
\newline
S: 250 Ok
\newline
C: RCPT TO:<theboss@example.com>
\newline
S: 250 Ok
\newline
C: DATA
\newline
S: 354 End data with <CR><LF>.<CR><LF>
\newline
C: From: "Bob Example" <bob@example.org>
\newline
C: To: Alice Example <alice@example.com>
\newline
C: Cc: theboss@example.com
\newline
C: Date: Tue, 15 Jan 2008 16:02:43 -0500
\newline
C: Subject: Test message
\newline
C:
\newline
C: Hello Alice.
\newline
C: This is a test message with 5 headers and 4 lines in the body.
\newline
C: Your friend,
\newline
C: Bob
\newline
C: .
\newline
S: 250 Ok: queued as 12345
\newline
C: QUIT
\newline
S: 221 Bye
\newline
Serwer zamyka po³±czenie.

\subsubsection{Polecenia do debugowania adresów}

SMTP dostarcza poleceñ za pomoc± których mo¿na dokonaæ weryfikacji nazwy
u¿ytkownika albo uzyskaæ zawarto¶æ listy mailingowej. Dokonuje siê tego przy
pomocy poleceñ VRFY i EXPN, których wspacie powinno byæ zaimplementowane w
serwerze SMTP. 

Argumentem polecenia VRFY jest po prostu napisa, który sk³ada siê z nazwy
u¿ytkownika lub te¿ dodatkowo domeny. Je¿eli w wyniku polecenia serwer zwróci
odpowied¼ 250, mo¿e zawrzeæ w nim pe³n± nazwê u¿ytkownika i musi zawrzeæ
skrzynkê u¿ytkownika. Musi wiêc byæ to jedno z poni¿szych:

\begin{itemize}
  \item User Name <local-part@domain>
  \item local-part@domain 
\end{itemize}

Kiedy argument podany w komendzie VRFY sk³ada siê z kilku adresów, serwer mo¿e
zg³osiæ niejasno¶æ w adresie jakos ca³o¶ci albo wskazaæ na jeden z podanych w
argumencie adresów. Dla przyk³adu odpowiedzi serwera na komendê VRFY mog±
przyj±æ postaæ:

\begin{itemize}
  \item \framebox{530 User ambiguous}
  \item \framebox{553- Ambiguous;  Possibilities are 553-Joe Smith
  <jsmith@foo.com> 553-Harry Smith <hsmith@foo.com> 553 Melvin Smith <dweep@foo.com>}
  \item \framebox{553-Ambiguous;  Possibilities 553- <jsmith@foo.com> 553-
  <hsmith@foo.com> 553 <dweep@foo.com>}
\end{itemize}

W normalnych okoliczno¶ciach klient, który otrzyma odpowied¼ 553 oczekuje, ¿e
zwrócone wyniki bêdzie móg³ zaprezentowaæ u¿ytkownikowi czyli bêd± one dla
niego zrozumia³e. W powy¿szym przyk³adzie mo¿liwe jest to tylko w przypadku 2
i 3 (pierwszy nic konkretnego poza informacj± o b³êdzie nie mówi).

Drugie polecenie EXPN przyjmuje jako argument napis (string), który
identyfikuje listê maili, a odpowied¼ poprawna serwera mo¿e zawieraæ pe³ne
nazwy u¿ytkowników i musi podawaæ ich skrzynki mailowe.

Na niektórych hostach wystêpuje problem z rozró¿nieniem pomiêdzy list± mailow±,
a aliasem do pojedynczej skrzynki mailowej, poniewa¿ struktura danych
przechowuj±ca informacje na ten temat mo¿e przyjmowaæ oba typy wpisów i jest na
przyk³ad mo¿liwe, ¿e lista mailowa zawiera tylko jeden adres skrzynki. Próba
weryfikacji takiego adresu poprzez VRFY, mo¿e udaæ siê jedynie gdy serwer SMTP
umie obs³u¿yæ wiadomo¶æ wys³an± na ten adres poprzez dostarczenie jej do ka¿dej
skrzynki z listy. Je¿eli nie jest on w stanie tego zrobiæ zwróci jeden z
nastêpuj±cych b³êdów

\framebox{550 That is a mailing list, not a user}
lub te¿ 
\framebox{252 Unable to verify members of mailing list}

W przypadku wielolinijkowej odpowiedzi serwera na polecenie EXPN dok³adnie
jedna skrzynka mailowa powinna znale¼æ siê w lini. 

Przyk³adowe polecenie EXPN i odpowiedzi na nie:

\framebox{C: EXPN Example-People S: 250-Jon Postel <Postel@isi.edu> S: 250-Fred
Fonebone <Fonebone@physics.foo-u.edu> S: 250 Sam Q. Smith <SQSmith@specific.generic.com>}

\framebox{C: EXPN Executive-Washroom-List S: 550 Access Denied to You.}

Serwerowi nie wolno w odpowiedzi na VRFY lub EXPN zwracaæ odpowiedzi 250 dopóki
nie dokona faktycznej weryfikacji adresu. S± jednak przypadki, w których adres
wydaje siê byæ prawid³owy, ale w czasie rzeczywistym nie mo¿e on zostaæ
zweryfikowany. Jest tak np. kiedy serwer s³u¿y jako po¶redni dla innego serwera
albo domeny. W takim przypadku serwer dokonuje jakby ''pozornej weryfikacji''.
Sprawdza on poprawno¶æ sk³adniow± adresu, jak równie¿ mo¿e dokonaæ sprawdzenia
domeny czy jest ona w zakresie domen do których maile mo¿e przekazywaæ.
Odpowied¼ serwera powinna wiêc uwzglêdniæ, ¿e jest to tylko czê¶ciowa
weryfikacja adresu i zamiast statusu 250 powinien pojawiæ siê status 252. 

Implementacje serwera SMTP powinny zawieraæ przedstawione powy¿ej komendy. W
celach bezpieczeñstwa implementacje mog± dostarczaæ narzêdzi (np. poprzez plik
konfiguracyjny) do wy³±czenia tych poleceñ. Polecenia te by³y opcjonalne w RFC
821, ale obecnie powinny byæ wylistowane jako dodatkowe serwisy w odpowiedzi na
EHLO.

\subsubsection{Koniec sesji i po³±czenia}

Jak ju¿ wcze¶niej zosta³o wspomniane sesja w protokole SMTP koñczy siê wraz z
przes³aniem przez klienta polecenia QUIT. Serwer odpowiada pozytywnym kodem, po
którym zamyka po³±czenie.

Serwerowi nie wolno zamkn±æ po³±czenia intuicyjnie poza 2 przypadkami:

\begin{itemize}
  \item otrzyma polecenie QUIT i odpowie kodem 221
  \item po wykryciu potrzeby zamkniêcia serwisu SMTP i przes³aniu kodu 421.
  Odpowied¼ ta mo¿ê byæ umieszczona po ka¿dej komendzie lub asynchronicznie
  (przy za³o¿eniu, ¿e klient odbierze j± zanim kolejne polecenie zostanie
  przes³ane)
\end{itemize}

Klient SMTP, który spotka siê z zamkniêciem po³±czenia w wyniku okoliczno¶ci,
których nie mo¿e obs³u¿yæ, powinien traktowaæ przeprowadzan± transakcjê jak
gdyby otrzyma³ od serwera odpowied¼ 451 ''Requested action aborted: error in
processing''.

\subsubsection{Listy mailowe (mailingowe) i aliasy}

Serwer SMTP powinien wspieraæ zarówno aliasy, jak i listy mailowe, które
s³u¿± w celach dostarczenia wiadomo¶ci do wiêkszej ilo¶ci adresów. 

Alias to inaczej pseudo-skrzynka, której nazwa przy odbieraniu maila t³umaczona
jest na rzeczywisty adres (b±d¼ adresy). Zmieniane jest tylko pole (RCPT TO),
reszta wiadomo¶ci (''koperta'' i cia³o wiadomo¶ci) pozostaje nietkniêta. 

Lista mailowa za¶ s³u¿y dostarczoniu albo przekazaniu maila do
wszysktich adresów znajduj±cych siê na li¶cie. W wyniku tej operacji adres
zwrotny na ''kopercie'' (MAIL FROM) musi byæ zmieniony na adres osoby albo innej
jednostki, która sprawuje opiekê nad list±. Nag³ówki wiadomo¶ci (w
szczególno¶ci pole From) pozostaj± nietkniête.

\subsubsection{Informace o trasie}

Kiedy serwer SMTP otrzyma wiadomo¶æ do dostarczenia albo dalszego procesowania
pozostawia w niej swój ¶lad. ¦lad ten umieszczany jest na pocz±tku cia³a
wiadomo¶ci (nag³ówki ''time stamp'' albo ''Received'').

Linia ta powinna siê sk³adaæ z nastêpuj±cych informacji:

\begin{itemize}
  \item pola FROM, które powinno zawieraæ zarówno nazwe hosta ¼ród³owego (tak
  ja w zaprezentowanym w ramach odpowiedzi na komende EHLO) i adres IP ¼ród³a,
  zdeterminowane z po³±czenia TCP
  \item pola ID, które mo¿e zawieraæ zgodnie z sugestiami w RFC 822 znaczke
  ''@'', ale nie jest to wymagane
  \item pola FOR, które mo¿e zawieraæ listê wpisów <path> kiedy w poleceniu
  RCPT zosta³o podanych ich kilka
\end{itemize}

Wcze¶niej dodane linijka Received nie powinna byæ zmieniana. Serwery SMTP
powinny mieæ przygotowan± linie Received do ''wstrzykniêcia'' do wiadomo¶ci.
Nie wolno im zmieniaæ obecnych lini ani te¿ wpisywaæ swojej lini w innym ni¿
przeznaczone miejscu.

Przyk³adowa linia wygl±da nastêpuj±co:

\framebox{Received: from mizar.astronet.pl ([127.0.0.1])
 by localhost (mizar [127.0.0.1]) (amavisd-new, port 10024) with ESMTP
 id 18935-01 for <zbychu@astronet.pl>; Fri, 29 Feb 2008 14:44:55 +0100 (CET)}


W miarê rozwoju Internetu linie Received s± bardzo istotne w celach wykrywania
wyst±pienia jakichkolwiek problemów. 

Kiedy wiadomo¶æ jest ostatecznie dostarczana, serwer SMTP wstawia nag³ówek
''Return-path'' na pocz±tku maila. Zachowanie to jest wymagane. Systemy mailowe
SMTP musz± to implementowaæ. ''Return-path'' to zachowane informacje z
argumentu <reverse-path> z polecenia MAIL. Po tym oznaczeniu uznawane jest, ¿e
wiadomo¶æ opu¶ci³a ¶rodowisko SMTP, jednak¿e nie oznacza to obecnie, ¿e zosta³a
ona ostatecznie dostarczona. Mo¿e byæ transmitowana przez inny system mailowy.

\subsubsection{Rozmiary i opó¼nienia}

W protokole SMTP wystêpuj± obiekty, które maj± wymagane minimalne b±d¼ te¿
maksymalne rozmiary. Ka¿da implementacja musi byæ w stanie odbieraæ o takich
wielko¶ciach. Obiekty wiêksze powinny byæ unikane. Klient mo¿e liczyæ siê z
tym, ¿e przy próbie transmisji zbyt du¿ych obiektów, mo¿e spotkaæ siê z odmow±
ze strony serwera.

Obiekty o których mowa to:

\begin{itemize}
  \item local-part - maksymalna d³ugo¶æ nazwy u¿ytkownika. Wynosie ona 64 znaki
  \item domain - maksymalna d³ugo¶æ domeny. Wynosi to 255 znaków
  \item path - maksymalna d³ugo¶æ argumentu reverse-path albo forward-path.
  Wynosi ona 256 znaków (wliczaj±c w to interpunkcje i separatory elementów)
  \item comman line - maksymalna d³ugo¶æ polecenia wraz z jego nazw± i znakiem
  <CRLF>. Wynosi ona 512 znaków. Rozszerzenia SMTP mog± pos³u¿yæ w celach
  zwiêkszenia tego limitu
  \item reply line - maksymalna d³ugo¶æ lini odpowiedzi. Wynosia oan 512 znaków
  wliczaj±c w to kod odpowiedzi oraz znak <CRLF>
  \item text line - maksymalna d³ugo¶æ lini tekstu wliczaj±c w to znak <CRLF>.
  Wynosi ona 1000 znaków. Mo¿e byæ ona rozszerzona przez dodatkowe serwisy
  SMTP.
  \item message content - d³ugo¶æ zawarto¶ci wiadomo¶ci (wliczaj±c
  w to nag³ówki wiadomo¶ci jak i jego cia³o). Musi mieæ ona co najmniej 64K
  octets (czyli ile?). Odk±d wprowadzono standard Multipurpose Internet Mail
  Extensions (MIME) wielko¶æ wiadomo¶ci wzros³a diametralnie, dlatego te¿
  zaleca siê obecnie aby serwery SMTP nie nak³ady ¿adnych ograniczeñ na wielko¶æ
  wiadomo¶ci
  \item recipients buffer - rozmiar buffora adresowego. Minimalna ca³kowita
  liczba odbiorców, która musi byæ zbuforowana to 100. Klient, który chce
  dostarczyæ wiadomo¶æ do wiêcej ni¿ 100 odbiorców powinien byæ przygotowany na
  transmisjê maila w kawa³kach po 100 odbiorców (je¿eli oczywi¶ci serwer
  akceptuje wiadomo¶ci z tak± ilo¶ci± odbiorców)
\end{itemize}

B³êdy zwi±zane z powy¿szymi ograniczeniami mog± byæ zg³oszone poprzez
standardowe kody b³êdów. Przyk³ady takich b³êdów:

\begin{itemize}
  \item 500 Line too long
  \item 501 Path too long
  \item 452 Too many recipients
  \item 552 Too much mail data
\end{itemize}

W ramach protoko³u SMTP nie mo¿emy tak¿e zapomnieæ o opó¼nieniach, które nale¿y
wzi±æ pod uwagê przy implementacji klienta. Klient musi repektowaæ opó¼nienia
zwi±zane z poleceniami. Powinny one byæ w prosty sposób w kliencie
konfigurowalne (w celach ewentualnych zmian i próby dostosowanie opó¼nieñ do
warunków panuj±cych w sieci). Proponowane opó¼nienia w kliencie:

\begin{itemize}
  \item Pocz±tkowa wiadomo¶æ 220 od serwera: 5 minut
  \newline
  Klient SMTP powinien mieæ mo¿liwo¶æ rozró¿nienia pomiêdzy problemami
  zwi±zanymi z TCP (zerwane po³±czenie) a opó¼nieniami w otrzymaniu powitalnego
  220. Wiele serwerów SMTP akceptuje po³±czenia, ale opo¼nia ich obs³ugê dopóki
  load na maszynie nie spadnie do odpowiedniego poziomu
  \item Polecenie MAIL: 5 minut
  \item Polecenie RCPT: 5 minut
  \newline
  Wiêksze opó¼nienie jest wymagane w przypadkach, gdy procesowanie obs³ugi
  listy mailowej czy aliasu nie nastêpuje po akceptacji maila
  \item Inicjalizacja polecenie DATA: 2 minuty
  \newline
  Potrzeba na czekanie na odpowied¼ serwera ''354 Start Input''
  \item Blok danych: 3 minuty
  \newline
  Ewentualna potrzeba na oczekiwanie na zakoñczenie wywo³anai TCP SEND do
  transmisji kolejnych porcji danych
  \item Zakoñczenie polecenia DATA: 10 minut
  \newline
  Potrzebne w celach oczekiwania na odpowied¼ 250 OK. Kiedy odbiorca otrzyma
  ostatni znak oznaczaj±cy koniec wiadomo¶ci, przewa¿nie zaczyna on
  procesowanie dostarczenia wiadomo¶ci do skrzynku u¿ytkownika. Nieodpowiednie
  opó¼nienie tutaj mo¿e skutkowaæ dostarczeniem paru tego samego maila,
  poniewa¿ klient za³o¿y, ¿e transakcja siê nie uda³a (minie odpowiedni czas),
  a tak naprawde odbiorca zaakceptuje wiadomo¶æ, a jeszcze nie zd±¿y powiadomiæ
  o tym klienta.
\end{itemize}

W przypadku opo¼nieñ serwera mo¿emy mówiæ o sta³ym opó¼nieniu 5 minut w
oczekiwaniu na komendy od klienta.

\subsubsection{Strategie wysy³ania i odbierania}

Przewa¿nie struktura implementacji hosta SMTP zawiera skrzynki u¿ytkowników,
jedn± lub wiêcej kolejek wiadomo¶ci oraz jednego lub wiêcej demonów do
odbierania i wysy³ania maili. Dok³adna struktura ró¿ni siê w zale¿no¶ci od
potrzeby u¿ytkowników oraz liczby i wielko¶ci list mailowych obs³ugiwanych
przez host. Poni¿ej strategie, które okaza³y siê bardzo pomocne w przypadku
obs³ugi du¿ego ruchu mailowego:

\begin{itemize}
  \item Wysy³anie:
  \newline
  G³ównym modelem dla klienta SMTP jest jeden lub kilka procesów, które
  cyklicznie próbuj± transmitowaæ maile wychodz±ce. W typowym systemie,
  program, który komponuje wiadomo¶æ posiada odpowiednie metody, aby zwróciæ
  natychmiastow± uwagê na nowy element w wiadomo¶ciach wychodz±cych. Maile,
  które nie s± transmitowane od razu s± kolejkowane i cyklicznie wysy³ane.
  Kolejka mailowa zawiera oprócz samej wiadomo¶ci ''kopertê'' czyli dodatkowe
  informacje s³u¿±ce do wysy³ania. 
  \newline
  Nadawca po nieudanym wys³aniu powinien odczekaæ pewn± jednostkê czasu zanim
  ponowi próbê transmisji maila. Generalnie jednostka ta powinna wynosiæ oko³o
  30 minut.
  \newline
  Ponawianie wys³ania nastêpuje dopóki zakoñczy siê ono sukcesem b±d¼ te¿
  klient siê podda. Przyjmuje siê, ¿e po 4-5 dniach nieudanych próbach,
  wiadomo¶æ zostaje uznana za niedorêczon±. 
  \newline
  Klient powinien trzymaæ listê hostów do których nie mo¿e dotrzeæ i
  zapamiêtywaæ opó¼nienia do nich, zamiast nieustannie kolejkowaæ maile
  przeznaczone do tych hostów. W ten sposób szybciej odrzuci maile, które nie
  maj± szansy osi±gn±æ celu.
  \newline
  Klient SMTP mo¿e zmniejszyæ oczekiwanie w kolejce we wspó³pracy z serwerem
  SMTP. Dla przyk³adu, je¿eli mail z danego adresu (domeny), zosta³ odebrany
  prawdopodobne jest, ¿e maile kolejkowane dla tego adresu (domeny), mog±
  zostaæ wys³ane.
  \newline
  Klient SMTP mo¿e mieæ kolejkê wielu wiadomo¶ci dla ka¿dego nieosi±galnego
  hosta docelowego. Je¿eli ka¿da z tych wiadomo¶ci w cyklu ponawiania bêdzie
  wysy³ana system zostanie zablokowany na d³ugi okres czasu, poniewa¿ klient
  mo¿e stwierdziæ, ¿e dostarczenie siê nie uda³o jedynie po okre¶lonym czasie
  (do kilku minut). Nawet zmniejszenie opó¼nienia do 1 minuty przy setkach
  wiadomo¶ci powoduje zamro¿enie systemu. 
  \newline   
  W przypadku wysy³ania wiadomo¶ci do wielu odbiorców z tego samego hosta klient
  powinien stosowaæ taktykê MAIL, RCPT, RCPT, \ldots RCPT, DATA zamiast MAIL,
  RCPT, DATA, \ldots, MAIL, RCPT, DATA. 
  
  \item Strategie odbioru
  \newline
  SMTP server powinien oczekiwaæ nieustannie nadchodz±cych po³±czeñ. Wymaga to
  oczywi¶cie od implementacji obs³ugi wielu po³±czeñ jednocze¶nie. Jak ju¿
  wspomniano wcze¶niej obs³uga procesu dostarczenia maila do konkretnej
  skrzynki mo¿e odbywaæ siê nie tu¿ po obs³udze polecenia DATA, ale w odzielnym
  procesie. Zmniejszony jest wtedy czas oczekiwania klienta na ostateczne
  potwierdzenie zakoñczenia transakcji maila.
\end{itemize}

\subsubsection{Rozwi±zywanie adresu i przekazywanie maila}

Zanim klient SMTP zidentyfikuje dok±d ma byæ pos³any mail, musi nast±piæ
odpytanie serwera DNS o adres domeny. Oczekuje siê, ¿e podane w adresie nazwy
domen s± w pe³ni akceptowanymi nazwami domen (fully qualified domain name,
FQDN). Pierwsze odpytanie serwera to zapytanie o rekorkdy MX zwi±zane z nazw±.

Rekord MX (Mail exchanger) to jeden z typów rekordów w serwerze domen DNS,
który specyfikuje w jakis sposób maile powinny byæ routowane (przekazywane w
sieci) przy u¿yciu protokolu SMTP. Ka¿dy rekord MX ma nastêpuj±c± postaæ:
[name] [ttl] IN MX preference host
gdzie: 

\begin{itemize}
  \item name - nazwa komputera lub domeny czyli cel ostateczny naszego maila
  \item ttl - czas ¿ycia rekordu
  \item preference - komputer lub domena mo¿e mieæ wiêcej ni¿ jeden komputer
  wskazany jako odbiorca poczty, wpisana w tym polu liczba okre¶la preferencjê
  - im mniejsza jej warto¶æ tym priorytet wy¿szy
  \item host - nazwa serwera pocztowego
\end{itemize}

Je¿eli przed rekordem MX zostanie znaleziony rekord CNAME, host który znajduje
siê pod tym rekordem jest nastêpnie traktowany jak host, który by³ pierwotnie
podany do poszukiwañ w DNS-ie. Rekord CNAME to swego rodzaju alias w DNS-ie. 

Je¿eli ¿aden rekord MX nie zostanie odnaleziony, ale za to odnaleziony zostanie
rekord A, jest on traktowany jakby by³ rekordem MX z preferencj± 0 (czyli
najwy¿szym priorytetem). 

Je¿eli uda siê znale¼æ jeden lub wiêcej rekordów MX dla danej nazwy,
implementacjom systemów SMTP nie wolno u¿ywaæ ¿adnych rekordów A zwi±zanych z
nazw±.

Kiedy odpytanie DNS-ów zostanie zakoñczone sukcesem, mo¿emy w wyniku mapowania
otrzymaæ kilka adresów, ze wzglêdu na mo¿liwo¶æ kilku rekordów MX czy te¿
multihoming (albo to i to). A¿eby zapewniæ niezawodn± transmisjê maila, klient
SMTP musi próbowaæ (i ew. ponawiaæ próby) dla ka¿dego z adresów wg porz±dku,
a¿ uda siê dostarczyæ wiadomo¶æ. Klient mo¿e posiadaæ konfigurowaln± liczbê
maksymalnych alternatywnych adresów. Liczba ta powinna wynosiæ przynajmniej 2
adresy.

Jak wy¿ej wspomniano klient posy³a maile do kilku adresów na podstawie
uporz±dkowanej listy, która to zale¿na jest od priorytetów w rekordach MX oraz
od hostów z wieloma adresami. Im ni¿szy priorytet tym serwer jest bardziej
preferowany, za¶ przy tych samych priorytetach dokonywany jest wybór losowy. 

Adres hosta docelowego mo¿e okazaæ siê nie pojedynczym adresem, ale list±
adresów (multihomed host). Zadaniem serwera DNS jest zwrócenie ju¿
uporz±dkowanej listy adresów IP, a klient po kolei próbuje wys³aæ pod nie maile.

Obs³uga alternatywnych adresów zwi±zanych z multihomingiem mo¿e zostaæ w
kliencie ograniczona do okre¶lonej liczby albo w ogóle wy³±czona.

\subsection{Konstrukcja wiadomo¶ci}

G³ówne informacje na temat wygl±du wiadomo¶ci s± obecnie zebrane w kilku
dokumentach. Jednym z g³ównych opisuj±ych wygl±d wiadomo¶ci bez rozszerzeñ jest
obecnie RFC 2822 (nastêpca ju¿ uznanego za przedawniony RFC 822). Rozszerzenia
wiadomo¶ci, które bêd± opisane pó¼niej, zdefiniowane s± w kolejnych dokumentach
(seria dokumentów o MIME RFC2045, RFC2046, RFC2047, RFC2048, RFC2049).

Sama wiadomo¶æ, z punktu widzenia mocno niskopoziomowego, to po prostu seria
znaków. Wiadomo¶æ zgodna ze standardem sk³ada siê ze znaków od 1 do 127
interpretowanych jako znaki kodowania US-ASCII. Wynika to oczywi¶cie ze
wzglêdów historycznych, gdy¿, jak to juz by³o wspomniane, to w Stanach zosta³y
pos³ane pierwsze wiadomo¶ci i to na tamte potrzeby stworzono pierwsze standardy.

Wiadomo¶ci s± podzielone na linie. Linia to seria znaków, która jest
ograniczona przez 2 znaki powrót karetki (CR - carriege return - w ASCII znak
numer 13) i znak nowej linii (LF - line-feed - w ASCII znak numer 10). Znaki te
z regu³y wystêpuj± razem w ramach wiadomo¶ci i oznaczane s± jako CRLF.

Ogólnie wiadomo¶æ mo¿na podzieliæ na 2 czê¶ci - pola z nag³ówkami wiadomo¶ci
(nazywane po prostu nag³ówkiem wiadomo¶ci) oraz cia³a wiadomo¶ci, które jest
opcjonalne. 

\subsubsection{Ograniczenia w d³ugo¶ci linii}

Ilo¶æ znaków w linii jest ograniczona dwoma limitami. Maksymalna ilo¶æ znaków w
linii (z pominiêciem CRLF), musi byæ mniejsza ni¿ 998 znaków, i nie powinna byæ
wiêksza ni¿ 78 znaków.

Limit 998 znaków wynika z ograniczeñ wielu obecnych implementacji, które
zajmuj± siê odbiorem, wysy³k± oraz przechowywaniem wiadomo¶ci. Nie obs³uguj±
one po prostu d³u¿szych linii. 

Bardziej konserwatywne ograniczenie zwi±zane z liczb± 78 znaków wynika z próby
dostosowania wiadomo¶ci do wielu implementacji interfejsu u¿ytkownika, które
wy¶wietlaj± te wiadomo¶ci. Implementacje te mog± uci±æ linie zawieraj±ce wiêcej
ni¿ 78 znaków.

\subsubsection{Nag³ówki wiadomo¶ci}

Pole nag³ówka sk³ada siê z:

\begin{itemize}
  \item nazwy nag³ówka po której nastêpuje dwukropek '':''
  \item cia³a nag³ówka po które nastêpuje znak CRLF
\end{itemize}

Nazwa nag³ówka musi sk³adaæ siê z drukowalnych znaków US-ASCII (czyli tych,
których kody s± pomiêdzy 33, a 126 w³±cznie) bez przecinka '',''. Cia³o
nag³ówka mo¿e zawieraæ wszystkie znaki oprócz CR i LF, chyba, ¿e przy
konstrukcji nag³ówka u¿yto sk³adania (ang. folding) opisanego ni¿ej.

Same nag³ówki mo¿na podzieliæ na posiadaj±ce (structered) lub nie posiadaj±ce
dodatkowej struktury (unstructered).

Te drugie (unstructered) oprócz wcze¶niej na³o¿onych restrykcji co do
wystêpowania okre¶lonych znaków, nie maj± dodatkowych obostrzeñ. Semantycznie
nie poddaje siê ich dodatkowemu procesowaniu (chyba, ¿e nag³ówek nale¿y
posk³adaæ [ang. unfold])

Niektóre nag³ówki wymagaj± w ramach swojego cia³a dodatkowej semantyki
(struktury). Je¿eli dane cia³o nag³ówka nie jest zgodne z t± semantyk± to taki
nag³ówek, a przez to tak¿e wiadomo¶æ, nie jest zgodna ze specyfikacj± opisywan±
w RFC 2822. 

Jak ju¿ by³o wcze¶niej zaznaczone pojedynczy nag³ówek to pojedyncza linia
sk³adaj±ca siê z nazwy, dwukropka i cia³a nag³ówka. Dla wygody, a tak¿e aby
poradziæ sobie z ograniczeniem na maksymalna d³ugo¶æ linii, pojedynczy nag³ówek
mo¿e byæ roz³o¿ony na kilka linii. Dzielenie to okre¶lamy angielskim s³owem
''folding''. 
Dzielenie to polega na tym, ¿e cia³o nag³ówka mo¿e zostaæ, w przypadku d³ugiej
lini, przeniesione do nastêpnej. Linia koñczona jest normalnym znakiem CRLF,
ale nowa linia musi byæ rozpoczêta znakiem WSP (white space czyli spacj± space
[SP] - kod 32 lub tabulatorem horizontal-tab [HTAB] - kod 11). Przyk³adowo
nag³ówek:
\newline
\newline
Subject: This is a test
\newline
\newline
mo¿e byæ reprezentowany jako
\newline
\newline
Subject: This
\newline
\vspace{10mm} is a test
 
Dzielenie nag³ówka na wiele lini mo¿e nast±piæ w wielu miejscach jednak zaleca
siê wstawianie znaku CRLF pomiêdzy tokenami, które znajduj± siê na najwy¿szym
stopniu w semantyce nag³ówka. Dla przyk³adu kiedy cia³o nag³ówka sk³ada siê z
podzielonych przecinkami warto¶ci, zaleca siê ³amanie lini po przecinku
rozdzielaj±cym struktury.

Jak ju¿ wcze¶niej by³o zaznaczone sk³adanie nag³ówka z wielu lini okre¶lane
jest angieslkim s³owem ''unfolding''.

\subsubsection{Opis niektórych nag³ówków}

Niektóre z nag³ówków wiadomo¶ci (jak to juz wcze¶niej wspomniano) posiadaj±
pewn± dodatkow± strukturê i s± przeznaczone do okre¶lonych celi. Dok³adny opis
semantyki cia³a ''zaawansowanych'' nag³ówków umieszczony jest w RFC 2822 i nie
bêdzie tutaj poruszany, jednak warto wspomnieæ jakie informacje nios± te
nag³ówki.

\begin{description}
  \item[Date] - nag³ówek ten specyfikuje datê i czas, któr± to twórca
  wiadomo¶ci wskazuje, ¿e jest ona skoñczona i gotowa do wej¶cia w system
  dostarczania poczty (czyli gotowa do wys³ania). Dla przyk³adu mo¿e byæ to
  czas kiedy u¿ytkownik tworz±c maila klika przycisk ''wy¶lij''
  \item[From, Sender, Reply-to] - nag³ówki okre¶lane s± nag³ówkami autora
  wiadomo¶ci. Pola te wskazuj± na skrzynkê (skrzynki) ¼ród³a wiadomo¶ci. W
  szczególno¶ci pole From okre¶la autora (b±d¼ autorów) wiadomo¶ci czyli
  skrzynkê (b±d¼ skrzynki) osoby (lub osób) odpowiedzialnych za stworzenie
  maila. Nag³ówek Sender okre¶la skrzynkê odpowiedzialn± za aktualn± transmisjê
  maila. Je¿eli twórc± wiadomo¶ci jest pojedyncza skrzynka oraz pole autora i
  transmituj±cego maila s± identyczne nag³ówek Sender nie powinien wyst±piæ.
  Inaczej oba (From i Sender) powinny siê pojawiæ. 
  \newline
  Reply-to (je¶li jest obecne) wskazuje skrzynkê (skrzynki), do których autor
  chcia³by, aby s³ane by³y odpowiedzi. Je¿eli brakuje nag³ówka Reply-to wtedy
  odpowiedzi powinny byæ s³ane na adres spod nag³ówka From. Nag³ówek From nie
  powinien zawieraæ ¿adnych adresów skrzynek nie nale¿±cych do autora
  wiadomo¶ci.
  \item[To, Cc, Bcc] - zwane s± polami docelowymi. Okre¶laj± one odbiorców
  wiadomo¶ci. Pole To okre¶la adres g³ównego odbiorcy (b±d¼ adresy g³ównych
  odbiorców). Pole Cc (nazwa pochodzi od Carbon Copy w rozumieniu tworzenia
  kopii przez pisarza przy u¿yciu kalki) zawiera inne adresy osób, które
  powinny otrzymaæ maila, chocia¿ to nie oni s± g³ównymi adresatami. Bcc (Blind
  Carbon Copy) zawiera adresy odbiorców, które nie maj± byæ pokazane innym
  odbiorcom. S± trzy sposoby u¿ycia Bcc: 
  \begin{itemize}
    \item Pierwszy z nich polega na usuniêciu z wiadomo¶ci linijki Bcc (tu¿
    przed wys³aniem wiadomo¶ci) i przes³anie jej kopii tak¿e do tych adresów z
    Bcc. 
    \item Drugi sposób polega na pos³aniu do adresatów z To i Cc wiadomo¶ci z
    usuniêt± linijk± Bcc, za¶ adresy spod lini Bcc dostaj± maila w ca³o¶ci
    czyli z linijk± Bcc. Tutaj pojawiaj± siê ró¿ne zachowania, je¿eli w polu
    Bcc mamy kilka adresów. Niektóre implementacje modyfikuj± tak Bcc, ¿e
    zawiera on za ka¿dym razem tylko tego odbiorce do którego trafia mail.
    \item Ostatni sposób podobny jest do pierwszego tylko zamiast usuwania
    lini Bcc jest ona s³ana bez ¿adnego adresu 
  \end{itemize}
  Sposób u¿ycia Bcc zale¿y od implementacji klienta.
  \item[Message-ID, In-Reply-To, Regerences] - chocia¿ opcjonalne pola te
  powinny byæ (i z regu³y s±) obecne w wiadomo¶ci. Message-ID zapewnia
  wiadomo¶ci unikalny identyfikator, który odnosi siê do danej wersji danej
  wiadomo¶ci. Unikalno¶æ gwarantowana jest przez host, który generuje to id.
  Pola In-Reply-To i References s± wykorzystywane przy tworzeniu odpowiedzi na
  wiadomo¶æ. Zawieraj± one identyfikator wiadomo¶ci oryginalnej (In-Reply-To)
  oraz identyfikatory innych wiadomo¶ci (References), gdy na przyk³ad wiadomo¶æ
  jest odpowiedzi± na odpowied¼. Tak wiêc In-Reply-To (je¶li istnieje) wskazuje
  nam na jak± wiadomo¶æ jest odpowiedzi± ta wiadomo¶æ, za¶ References zawiera
  wskazanie na ''w±tek'' w którym jest wiadomo¶æ. W trakcie konstrukcji
  wiadomo¶ci nag³ówki In-Reply-To i References tworzone s± w nastêpuj±cy sposób:
  \newline
  In-Reply-To przepisuje zawarto¶æ z Message-ID. Je¶li istnieje kilka
  wiadomo¶ci nadrzêdnych (parent message) wtedy In-Reply-To bêdzie zawiera³o
  wszystkie pola Message-ID poprzedników. Je¶li pole Message-ID nie istnieje
  In-Reply-To oczywi¶cie nie jest tworzone.
  \newline
  References przejmuje warto¶æ z wszystkich References (je¶li jakie¶ istniej±)
  po których przepisywane s± warto¶ci z Message-ID wszystkich wiadomo¶ci
  nadrzêdnych. Je¶li wiadomo¶ci nadrzêdne nie posiadaj± pola References, a
  posiadaj± pole In-Reply-To to miejsce References nadrzêdnych wiadomo¶ci
  przejmuje In-Reply-To. Je¶li nadrzêdne wiadomo¶ci nie maj± ¿adnego z trzech
  pól o których tutaj mowa, nowa wiadomo¶æ odpowied¼ nie bêdzie mia³a pola
  References.
  \newline 
  Czê¶æ implementacji parsuje pole References, aby odtworzyæ przebieg dyskusji
  i utworzyæ w±tek z uporz±dkowanymi wiadomo¶ciami. Tak robi na przyk³ad bardzo
  ostatnimi czasy popularny webowy klient poczty Gmail. Czytanie tak u³o¿onych
  wiadomo¶ci jest niesamowicie wygodne.
  \item[Subject, Comments, Keywords] - pola te przeznaczone do celów
  informacyjnych powinny mieæ formê czyteln± dla ludzi. Subject to tytu³
  wiadomo¶ci. Comments zawiera bardziej szczegó³owy opis wiadomo¶ci, za¶
  Keywords to porozdzielane przecinkami najwa¿niejsze wyrazy opisuj±ce
  wiadomo¶æ.
  \item[Return-Path, Received] - pola te zawieraj± informacje na temat drogi
  wiadomo¶ci w systemie (tworzenie ich by³o opisane wcze¶niej)
\end{description}

Dodatkowo u¿ytkownik mo¿e sobie sam zdefiniowaæ i u¿ywaæ dodatkowych nag³ówków.
Oczywi¶cie nazwy tych nag³ówkó nie mog± siê pokrywaæ z nazwami ju¿ u¿ywanymi.
Dlatego przyjmuje siê, ¿e nag³ówki dodatkowo definiowane (nie objête
specyfikacjami RFC 822 oraz RFC 2822) powinny byæ poprzedzane wyra¿eniem ''X-''
jak na przyk³ad:

\framebox{X-Mailer: Microsoft Windows Mail 6.0.6001.18000}

\subsubsection{Cia³o wiadomo¶ci}

Cia³o wiadomo¶ci to po prostu linie z³o¿one ze znaków US-ASCII. S± tylko dwa
wymogi co do znaków w ciele wiadomo¶ci:

\begin{itemize}
  \item znaki CR i LF musz± wystêpowaæ razem w postaci CRLF
  \item d³ugo¶æ lini musi byæ nie wiêksza ni¿ 998 znaków i powinna byæ nie
  wiêksza ni¿ 78 znaków (wy³±czaj±c CRLF)
\end{itemize}

\subsubsection{Rozszerzenie wiadomo¶ci, MIME}

Jak zosta³o wspomniane wy¿ej RFC 822 oraz RFC 2822 definiuj± w jaki sposób ma
wygl±daæ cia³o wiadomo¶ci w bardzo zawê¿ony sposób. Nie uwzglêdniaj± one
problemu zwi±zanego z obs³ug± wielu jêzyków (tylko znaki US-ASCII s± mo¿liwe w
ramach cia³a wiadomo¶ci), nie wspominaj±c ju¿ o mo¿liwo¶ci przesy³ania plików
audio, wideo czy zdjêæ. Dlatego te¿ w 1996 powsta³o pierwsze RFC (2045)
wychodz±ce na przeciw tym wszystkim problemom. Specyfikacja tych rozszerzeñ
znalaz³a siê w a¿ 4 RFC (2045-2048), które to zosta³y nazwane Multipurpose
Internet Mail Extensions w skrócie MIME. 

MIME definiuje kilka dodatkowych nag³ówków, które s³u¿± do opisu cia³a
wiadomo¶ci. Nag³ówki te pojawiaj± siê w 2 miejscach:

\begin{itemize}
  \item jako normalne nag³ówki na pocz±tku wiadomo¶ci
  \item jako nag³ówki w ramach czê¶ci wiadomo¶ci, o których mowa bêdzie pó¼niej 
\end{itemize}

Pierwszy z dodatkowych nag³ówków to nag³ówek MIME-VERSION, który obowi±zkowo
musi byæ zawarty w wiadomo¶ci (je¶li ma ona byæ zgodne ze standardem MIME) jako
g³ówny nag³ówek, za¶ nie jest konieczny w przypadku nag³ówków w czê¶ci
wiadomo¶ci. Przyk³adowo nag³ówek ten mo¿e wygl±daæ tak:

\framebox{MIME-Version: 1.0}

Kolejnym nag³ówkiem w ramach wiadomo¶ci typu MIME jest nag³ówek Content-Type,
który definiuje w sposób zapisania danych w wiadomo¶ci. Argument wystêpuj±cy w
nag³ówku Content-Type jest nazywany ''media type'' (w wolnym t³umaczeniu
rodzaj/typ danych). Przyk³adowo typ ''image/xyz'' mówi nam, ¿e mamy do
czynienia z danymi, które przedstawiaj± zdjêcie, nawet je¶li klient pocztowy
nie jest w stanie rozpoznaæ typu xyz. 
Dodatkowe parametry przy typie danych nie maj± wp³ywu na ich naturê, a jedynie
dodatkowo okre¶laj± te dane. Niektóre implementacje mog± nie rozpoznawaæ
pewnych dodatkowych argumentów MIME i gdy taka sytuacja ma miejsce, argumenty
te powinny byæ pomijane. Przyk³adowym dodatkowym parametrem dla typu ''text'',
mo¿e byæ ''charset'' okre¶laj±cy kodowanie tekstu w wiadomo¶ci.

G³ównymi typy MIME (zdefiniowanymi w RFC 2046) to:
\begin{itemize}
  \item text - wiadomo¶æ tekstowa. Podtyp ''plain'' okre¶la wiadomo¶æ bez
  dodatkowego formatowania. Nie wymaga ona ¿adnego dodatkowego oprogramowania
  poza ewentualnie obs³ug± odpowiedniego kodowania. Mo¿liwe oczywi¶cie s± inne
  podtypy chocia¿by html, który wskazuje, ¿e dana wiadomo¶æ mo¿e byæ parsowana
  jakby by³a stron± html
  \item image - dane ze zdjêciem. Wymagaj± one dodatkowego oprogramowania w
  celu wy¶wietlenia zdjêcia. Podtypami s± tutaj ró¿ne formaty zdjêæ jak np.
  jpeg, gif czy png
  \item audio - dane d¼wiêkowe. Potrzebne jest dodatkowe oprogramowanie w celu
  ods³uchania d¼wiêku. Pocz±tkowyn podtypem jest ''basic''
  \item video - dane video. Potrzebne jest dodatkowoe oprogramowanie w celu
  otwarcia pliku. Pocz±tkowym podtypem jest mpeg.
  \item application - dane binarne bli¿ej nie sprecyzowane, które mog± byæ
  poprawnie zinterpretowane przez dodatkowe oprogramowanie. Podtyp
  ''octet-stream'' powinien byæ u¿ywany je¿eli chcemy aby najprostsz± akcj±,
  która zostanie nam zaoferowana przez klienta pocztowego to zapis pliku na
  dysk. ''Application'' powinno byæ tak¿e u¿ywane np. w przypadku arkuszy
  kalkulacyjnych, materia³ów PostScript czy innych formatów, które w prosty
  sposób nie s± czytelne.
  \item multipart - typ ten definiuje, ¿e wiadomo¶æ bêdzie z³o¿ona z kilku
  czê¶ci. Typ ten posiada 4 podtypy:
  
  \begin{itemize}
    \item mixed - obecnie bardzo czêsto wykorzystywany w przypadku kiedy
    wiadomo¶æ sk³ada siê z kilku elementów ró¿nych od siebie np. tekstu oraz
    zdjêcia. 
    \item alternative - s³u¿y do zdefiniowania tej samej tre¶ci w ró¿nym
    formatowaniu np. tekst w postaci plain oraz html.
    \item parallel - s³u¿y do wiadomo¶ci, której czê¶ci maj± byæ zaprezentowane
    jednocze¶nie
    \item digest - wykorzystywany przy wiadomo¶ciach z³o¿onych z czê¶ci, z
    których ka¿da ma inny typ
  \end{itemize}
   
  \item message - enkapsulacja wiadomo¶ci. Zawarto¶æ takiej wiadomo¶ci jest sama
  w sobie wiadomo¶ci±. Przyk³adowy podtyp ''rfc822'' definiuje wiadomo¶æ zgodn±
  z RFC 822, za¶ ''partial'' s³u¿y do zdefiniowania czê¶ci wiadomo¶ci zgodnej z
  RFC 822 w celach transmisji jej fragmentów ze wzglêdu na jej du¿± wielko¶ci
  uniemo¿liwiaj±c± przekazanie w jednym kawa³ku.
\end{itemize}

Wiadomo¶ci MIME, które nie posiadaj± nag³ówka Content-type traktowane s± jako
wiadomo¶ci z nag³ówkiem ''Content-type: text/plain; charset=us-ascii''.

Bardzo istotnym nag³ówkiem jest nag³ówek Content-Transfer-Encoding, który
definiuje algorytm wg którego zakodowana zosta³a wiadomo¶æ (lub jej czê¶æ).
Transformacje zapisane w ramach nag³ówka to znane algorytmy kodowania i nie
zale¿± nigdy one od zewnêtrznych informacji (spoza wiadomo¶ci). Jedn±
z wa¿niejszych funkcji kodowania wiadomo¶ci jest mo¿liwo¶æ przes³ania
oryginalnie 8-bitowych danych za pomoc± 7-bitowych znaków US-ASCII.

Dostêpne formy kodowania wiadomo¶ci to:
\begin{itemize}
  \item 7bit - dane reprezentowane w postaci krótkich lini ze znakami US-ASCII
  \item 8bit - dane reprezentowane w postaci krótkich linni ale mog± wystêpowaæ
  znaki spoza US-ASCII
  \item binary - oprócz mo¿liwo¶ci wystêpowania znaków spoza US-ASCII mo¿e
  brakowaæ podzia³u na krótkie linie
  \item quoted-printable - szczegó³owy opis podany pó¼niej
  \item base64 - szczegó³owy opis podany pó¼niej
  \item ietf-token - forma kodowania wyspecyfikowana w okre¶lonym RFC i
  zarejestrowna w IANA (Internet Assigned Numbers Authority) (wcze¶niej IETF -
  Internet Engineering Task Force)
  \item x-token - programi¶ci mog± u¿yæ w³asnego kodowania w nag³ówku
  Content-Transfer-Encoding np. Content-Transfer-Encoding: x-my-new-encoding.
  Dodatkowe formy kodowania mog± byæ wyspecyfikowana w RFC. Wymogi takiej
  specyfikacji znajduj± siê w RFC 2048
\end{itemize}

Prawid³owy nag³ówek Content-Transfer-Encoding musi zostaæ u¿yty. Nadanie
wiadomo¶ci z 8-bitowymi danymi jako 7bit jest niedozwolone, za¶ niekodowane dane
musz± byæ ''oflagowane'' jako binary. Transfer niekodowanych danych
protoko³em SMTP jest obecnie uwa¿any jako niezgodny ze specyfikacj±.

W odró¿nieniu od typów i podtypów MIME tworzenie w³asnych nazw kodowañ dla
nag³ówka Content-Transfer-Encoding jest mocno odradzane.

Nag³ówek Content-Transfer-Encoding tyczy siê ca³ego cia³a wiadomo¶ci. Je¿eli
za¶ znajdzie siê w czê¶ci wiadomo¶ci to dotyczy tylko jej. Je¿eli wiadomo¶æ lub
jej czê¶æ jest typu multipart, wtedy Content-Transfer-Encoding mo¿e przyjmowaæ
tylko 7bit, 8bit lub binary.

Content-Transfer Encoding jest bezpo¶rednio powi±zany z drugim nag³ówkiem jakim
jest Content-Type, chocia¿ wydawa³oby siê, ¿e s± to ca³kowicie rozdzielne
rzeczy. Po pierwsze niektóre kodowania mog± byæ stosowne w przypadku niektórych
rodzajów typów MIME, jak choæby w przypadku 8bit-owego transportu (je¿eli
serwer SMTP udostêpnia tak± mo¿liwo¶æ) nie wymagany jest jakiekolwiek kodowanie dla tekstu
o okre¶lonym kodowaniu znaków, podczas gdy dla 7bit-owego transportu tekstu
takie kodowanie jest ju¿ niezbêdne gdy¿ mog± wyst±piæ w nim znaki spoza
US-ASCII. Po drugie niektóre typy MIME wymagaj± ró¿nych typów kodowania w
zale¿no¶ci od warunków. Przyk³adowo wiele dokumentów PostScript posiada krótkie
linie z 7bit-owymi danymi i dlatego te¿ nie wymagaj± one dodatkowego kodowania.
Inne dokumenty PostScriptowe (szczególnie te u¿ywaj±ce mechanizmu kodowania
binarnego 2 poziomu) mog± byæ przekazane tylko przy pomocy kodowania binary. I
wreszcie po trzecie, ¶cis³a specyfikacja pomiêdzy typami MIME, a kodowaniem
skutecznie ³±czy specyfikacjê protoko³u aplikacji z specyfikacj±
niskopoziomowego transportu. Nie jest to jednak porz±dane, gdy¿
zmusza³oby deweloperów typów MIME do posiadania znajomo¶ci rodzajów transportu
i ich ograniczeñ.

Je¿eli jaka¶ wiadomo¶æ lub jej czê¶æ posiada nierozpoznawalny
Content-Transfer-Encoding musi byæ traktowana jakby warto¶æ nag³ówka
Content-Type wynosi³a ''application/octet-stream'' niezale¿nie od tego jak±
warto¶æ rzeczywi¶cie posiada ten nag³ówek.

Kodowanie Quoted-Printable pozostawia wszystkie bajty o warto¶ci mniejszej od
128, które nie s± znakami steruj±cymi ASCII (z wyj±tkiem znaku równo¶ci =) bez
zmian, a pozosta³e (z wyj±tkiem znaku tabulacji poziomej - HT, kod 9) zamienia
na napis zakodowany w ASCII reprezentuj±cy kod szesnastkowy danego bajtu
poprzedzony znakiem równo¶ci =. Sam znak równo¶ci w celu unikniêcia
wieloznaczno¶ci jest zastêpowany ci±giem =3D. Dodatkowe regu³y rz±dz±
kodowaniem koñców linii, m.in. ''miêkkim'' ³amaniem linii, oraz reprezentacj±
linii koñcz±cych siê bia³ymi znakami.

Base64 s³u¿y do kodowania ci±gu bajtów przy pomocy ci±gu znaków. Kodowanie to
przypisuje 64 wybranym znakom (patrz tabelka ni¿ej) warto¶ci od 0 do 63. Ci±g
bajtów poddawany kodowaniu dzielony jest na grupy po 3 bajty. Poniewa¿ bajt ma
8 bitów, grupa 3 bajtów sk³ada siê z 24 bitów. Ka¿d± tak± grupê dzieli siê
nastêpnie na 4 jednostki 6-bitowe. Istniej± wiêc dok³adnie 64 mo¿liw warto¶ci
ka¿dej takiej jednostki. Wszystkim tym jednostkom s± przypisywane znaki na
podstawie podanego ni¿ej arbitralnie ustalonego przypisania.

\begin{tabular}{ | c | c | c | c | c | c | }
\hline
Warto¶æ & Znak & Warto¶æ & Znak & Warto¶æ & Znak \\ \hline
\hline
0 &	A & 22 & W & 44 & s  \\
1 &	B & 23 & X & 45 & t  \\
2 &	C & 24 & Y & 46 & u  \\
3 &	D & 25 & Z & 47 & v  \\
4 &	E &	26 & a & 48 & w  \\
5 &	F &	27 & b & 49 & x  \\
6 &	G &	28 & c & 50 & y  \\
7 &	H &	29 & d & 51 & z  \\
8 &	I & 30 & e & 52 & 0  \\
9 &	J & 31 & f & 53 & 1  \\
10 & K & 32 & g & 54 & 2 \\
11 & L & 33 & h & 55 & 3 \\
12 & M & 34 & i & 55 & 3 \\
13 & N & 35 & j & 56 & 4 \\
14 & O & 36 & k & 57 & 5 \\
15 & P & 37 & l & 58 & 6 \\
16 & Q & 38 & m	& 59 & 7 \\
17 & R & 39 & n & 60 & 8 \\
18 & S & 40 & o & 61 & 9 \\
19 & T & 41 & p & 62 & + \\
20 & U & 42 & q & 63 & / \\
21 & V & 43 & r & pad & = \\
\hline
\end{tabular}

Je¶li rozmiar wej¶ciowego ci±gu bajtów nie jest wielokrotno¶ci± liczby 3, to
stosowane jest dope³nianie (na koñcu wynikowego ci±gu dodawana jest taka ilo¶æ
symboli dope³nienia (pad), aby ten mia³ d³ugo¶æ podzieln± przez 4).

Widaæ, ¿e dane zakodowane przy pomocy base64 na maszynie, która u¿ywa
8-bitowego s³owa do reprezentacji znaków powiêkszaj± swój rozmiar o 33%.

Je¶li rozmiar wej¶ciowego ci±gu bajtów nie jest wielokrotno¶ci± liczby 3, to
stosowane jest dope³nianie (na koñcu wynikowego ci±gu dodawana jest taka ilo¶æ
symboli dope³nienia (pad), aby ten mia³ d³ugo¶æ podzieln± przez 4).

Widaæ, ¿e dane zakodowane przy pomocy base64 na maszynie, która u¿ywa
8-bitowego s³owa do reprezentacji znaków powiêkszaj± swój rozmiar o 33%.

Wspomnieæ te¿ nale¿y o nag³ówku Content-ID, który jest w zastosowaniu podobny
do Message-ID i pozwala na referencjê pomiêdzy ró¿nymi wiadomo¶ciami. Tak samo
jak Message-ID warto¶æ zawarta w Content-ID musi pozostaæ unikalna. 

Ostatnim dodatkowym nag³ówkiem jaki zawarty jest w standardzie MIME to
nag³ówek Content-Description. Warto¶æ tego nag³ówka to tekst US-ASCII. Opisuje
on po prostu cia³o danego za³±cznika np. ''rysunek Galaktyki Andromedy''.

Dodatkowe nag³ówki opisuj±ce za³±czniki mog± zostaæ w przysz³o¶ci zdefiniowane.
Nazwa ka¿dego nowego nag³ówka powinna rozpoczynaæ siê od ''Content-'' np.
''Content-Newone''. 

Jak by³o wcze¶niej wspomniane typ MIME multipart s³u¿y do tworzenia wiadomo¶ci
sk³adaj±cych siê z za³±czników ró¿nego rodzaju. Minimalnie mo¿e ona zawieraæ
jeden za³±cznik. Ka¿dy z nich poprzedzony jest lini± podzia³u (boundary line),
za¶ po ostatnim z za³±czników wystêpuje linia koñcz±ca. Po ka¿dej lini
rozpoczynaj±cej za³±cznik znajduj± siê nag³ówki okre¶laj±ce go (opisane
wcze¶niej), nastêpnie wystêpuje pusta linia, a za ni± znajduje siê cia³o.
Ze wzglêdu na posiadanie nag³ówków i cia³a za³±cznik podobny jest do wiadomo¶ci
zgodnej z RFC 822, jednak mo¿e on na przyk³ad nie zawieraæ nag³ówków. Taki
za³±cznik traktowany jest (podobnie jak wiadomo¶æ MIME bez nag³ówka
Content-Type) jako posiadaj±cy nag³ówek Content-Type typu text/plain;
charset=US-ASCII. Linia dziel±ca za³±czniki wiadomo¶ci nie mo¿e pojawiæ siê w
tek¶cie cia³a za³±cznika. Dlatego te¿ jest niezwykle istotne, aby
oprogramowanie klienckie tworzy³o wiadomo¶ci zawieraj±ce bardzo unikalne linie
podzia³u. Przyk³adowa linia podzia³u mo¿e wygl±daæ nastêpuj±co:
\newline
\newline
- - - -=\_NextPart\_001\_0064\_01C82582.9D9EB7E0
\newline
\newline

Poni¿ej przyk³adowa wiadomo¶æ (ze wzglêdu na czytelno¶æ wiadomo¶ci niektóre
nag³ówki zosta³y usuniête, a za³±czniki zosta³y zmniejszone). Sk³ada siê ona z 2
za³±czników:

\begin{itemize}
  \item multipart/mixed z boundary \newline 
  - - - -=\_NextPart\_000\_0063\_01C82582.9D9C6DF0), który sam w sobie
  jest typu multipart/alternative (text/plain i text/html) z boundary \newline 
  - - - -=\_NextPart\_001\_0064\_01C82582.9D9EB7E0
  \item image/jpeg - zdjêcie w formacie jpeg
\end{itemize}

Tre¶æ wiadomo¶ci:\newline
\newline
Date: Mon, 12 Nov 2007 23:20:30 +0100\newline
From: "jerzy\_bielecki" <jbielecki@klc.vectranet.pl>\newline
To: <redakcja@astronet.pl>\newline
MIME-Version: 1.0\newline
Message-ID: <006701c8257a$3d2100b0$45e7584e@compurbae2b8cf>\newline
Subject: Luna\newline
Content-Type: multipart/mixed;\newline
\hspace*{1cm}boundary="- - -
-=\_NextPart\_000\_0063\_01C82582.9D9C6DF0"\newline
\newline
This message is in MIME format. Since your mail reader does not
understand\newline
this format, some or all of this message may not be legible.\newline
\newline
- - - - - -=\_NextPart\_000\_0063\_01C82582.9D9C6DF0\newline
\newline
Content-Type: multipart/alternative;\newline
\hspace*{1cm} boundary="- - -
-=\_NextPart\_001\_0064\_01C82582.9D9EB7E0"\newline
\newline
This message is in MIME format. Since your mail reader does not understand\newline
this format, some or all of this message may not be legible.\newline
\newline
- - - - - -=\_NextPart\_001\_0064\_01C82582.9D9EB7E0\newline
\newline
Content-Type: text/plain;
\newline
\hspace*{1cm}charset="iso-8859-2"\newline
Content-Transfer-Encoding: quoted-printable\newline
\newline
Witam!\newline
\newline
mentu fotografii) !\newline
Powi=EAkszy=B3em dodatkowo jasn=B1 "plamk=EA" i uczytelni=B3em filtrem grafi=\newline
cznym - interesuj=B1cy efekt ...\newline
Pomo=BFecie ?\newline
\newline
Pozdrawiam - Jerzy W. Bielecki\newline
\_\_\_\_\_\_\_\_\_\_\_\_\newline
Poczta sprawdzona przez G DATA AntiVirus\newline
Wersja: AVK 18.584 z 12.11.2007\newline
Informacje: www.gdata.pl\newline
\newline
\newline
\newline
- - - - - -=\_NextPart\_001\_0064\_01C82582.9D9EB7E0\newline
Content-Type: text/html;\newline
\hspace*{1cm}charset="iso-8859-2"\newline
Content-Transfer-Encoding: quoted-printable\newline
\newline
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">\newline
<HTML><HEAD>\newline
<META http-equiv=3DContent-Type content=3D"text/html; charset=3Diso-8859-2">\newline
<META content=3D"MSHTML 6.00.6000.16544" name=3DGENERATOR>\newline
<STYLE></STYLE>\newline
</HEAD>\newline
<BODY bgColor=3D\#ffffff>\newline
Witam!<BR>\newline
Powi=EAkszy=B3em dodatkowo jasn=B1 "plamk=EA" i uczytelni=B3em filtrem
grafi=<BR>\newline
cznym - interesuj=B1cy efekt ...<BR>\newline
Pomo=BFecie ?<BR>\newline
\newline
Pozdrawiam - Jerzy W. Bielecki<BR>\newline
\_\_\_\_\_\_\_\_\_\_\_\_<BR>\newline
Poczta sprawdzona przez G DATA AntiVirus<BR>\newline
Wersja: AVK 18.584 z 12.11.2007<BR>\newline
Informacje: www.gdata.pl<BR>\newline
\newline
\newline
</BODY></HTML>\newline
\newline
- - - - - -=\_NextPart\_001\_0064\_01C82582.9D9EB7E0- -\newline
\newline
- - - - - -=\_NextPart\_000\_0063\_01C82582.9D9C6DF0
\newline
Content-Type: image/jpeg;\newline
\hspace*{1cm}name="IMG\_7661xLunaPlusAJW9plusResizeLunaPlusUczytelnienia.jpg"\newline
Content-Transfer-Encoding: base64\newline
Content-Disposition: attachment;\newline
\hspace*{1cm}filename="IMG\_7661xLunaPlusAJW9plusResizeLunaPlusUczytelnienia.jpg"\newline
\newline
/9j/4AAQSkZJRgABAQEASABIAAD/4RAXRXSSTaS\newline
hpZgAASUkqAAgAAAAJAA8BAgAGAAAAegAASasS\newline
AAAAgAAAABIBAwABAAAAAQAAABoBBQABAAS\newline
AgAUAAAAsAAAABMCAwABAAAAAQAAAGmHBA\newline
\newline
- - - - - -=\_NextPart\_000\_0063\_01C82582.9D9C6DF0- -\newline
\newline

\subsection{Obecne wykorzystanie protoko³u i jego forma}

\subsubsection{SMTP-AUTH}
Protokó³ SMTP w obecnej formie wykorzystuje wiele rozszerzeñ, których powstanie
by³o naturalnym wynikiem rozwoju Internetu. Podstawowym brakiem protoko³u SMTP
w formie z RFC 2821 jest brak jakiejkolwiek autoryzacji czyli potwierdzenia
to¿samo¶ci klienta pod³±czaj±cego siê do serwera. Klient, który poprawnie
przejdzie proces autoryzacji mo¿e u¿yæ serwera, do którego jest
pod³±czony, w celach przekazania wiadomo¶ci (ang. relay). Serwer po przyjêciu
tej wiadomo¶ci jest odpowiedzialny za jej dostarczenie. Autoryzacja zapobiega m.in.
przed relay-owaniem poczty od nieautoryzowanych u¿ytkowników czyli tzw.
spammerów. Przyk³adowa sesja SMTP z poprawn± autoryzacj±:

S: 220 smtp.example.com ESMTP server ready
C: EHLO jgm.example.com
S: 250-smtp.example.com
S: 250 AUTH CRAM-MD5 DIGEST-MD5
C: AUTH FOOBAR
S: 504 Unrecognized authentication type.
C: AUTH CRAM-MD5
S: 334
PENCeUxFREJoU0NnbmhNWitOMjNGNndAZWx3b29kLmlubm9zb2Z0LmNvbT4=
C: ZnJlZCA5ZTk1YWVlMDljNDBhZjJiODRhMGMyYjNiYmFlNzg2ZQ==
S: 235 Authentication successful.

Widaæ wiêc, ¿e w ca³ej komunikacji pojawia siê dodatkowe polecenie AUTH. Serwer
najpierw informuje klienta, ¿e autoryzacja jest obs³ugiwana. Nastêpnie klient
korzysta z polecenia AUTH, którego sk³adnia jest nastêpuj±ca:

\framebox{AUTH SPACE auth\_type [SPACE (base64 / "=")] *(CRLF [base64]) CRLF}

i próbuje dowiedzieæ siê jaka forma autoryzacji jest dostêpna. Serwer odpowiada
kodem 334 je¿eli dany typ autoryzacji obs³uguje lub 504 w przeciwnym wypadku. W
przypadku poprawnej odpowiedzi wysy³a on zakodowany base64 ci±g znaków, na
podstawie którego klient przesy³a inny ci±g znaków tak¿e zakodowany base64.
Ci±g ten z regu³y zawiera has³o i nazwê u¿ytkownika po³±czone z danymi
odkodowanymi z serwera. W przypadku prawid³owego ci±gu znaków od klienta serwer
dokonuje autoryzacji (odpowied¼ 235).

Mimo rozszerzenia SMTP-AUTH ca³y czas protokó³ SMTP nie daje gwarancji, ¿e
wiadomo¶æ pochodzi od osoby, za któr± podaje siê nadawce. Wystarczy przecie¿
z³amaæ has³o (w przypadku s³abych hase³) metod± brute-force i podszywaæ siê pod
dan± osobê.

\subsubsection{Phishing i obrona przed nieautoryzowanymi mailami}

Coraz czêstszym problemem jest te¿ phishing (zwany te¿ spoofingiem). Polega on
na konstruowaniu wiadomo¶ci, w których adres nadawcy (podany w nag³ówku) oraz
jej inne czê¶ci s± tak spreparowane jakby wydawa³y siê mailem z innego ¼ród³a.
Najczê¶ciej zmienianymi nag³ówkami s± From, Return-Path, Reply-To. Maile takie
najczêsciej powi±zane s± z tzw. phishingiem webowym. Polega to na spreparowaniu
wiadomo¶ci i zawarciu w niej odniesienia do strony internetowej, która
przypomina nam znan± strone internetow±, któr± jest równie¿ odpowiednio
spreparowana. Czêsto wiadomo¶ci te próbuj± podszywaæ siê pod wiadomo¶ci
przesy³ane nam z naszych banków, a linki w nich zawarte prowadz± do stron
przypominaj±cych strony logowañ do systemu bankowego. Po zalogowaniu siê na
takiej stronie internata staje siê ofiar±, poniewa¿ jego login i has³o
przekazywane jest osobom, które spreparowa³y maila, jak i stronê internetow±.

Aby zapobiec takim sytuacjom powsta³y rozszerzenia, których celem jest
potwierdzenie to¿samo¶ci nadawcy wiadomo¶ci. Podobn± funckjê spe³niaj± na
przyk³ad certyfikaty na szyfrowanych stronach internetowych. Niektóre z tych
rozszerzeñ to:

\begin{itemize}
  \item SPF - Sender Policy Framework - uwierzytelnia tylko adres MAIL
  FROM.\newline
  Sprawdza, czy e-mail przychodz±cy z danego serwera pocztowego
  mo¿e stosowaæ okre¶lon± nazwê domenow± w MAIL FROM. Opiera siê na infrastrukturze
  DNS oraz rekordach TXT
  \item DKIM - DomainKeys Identified Mail - uwierzytelnia tre¶æ i niektóre
  nag³ówki wiadomo¶ci.\newline
  Opiera siê na cyfrowym podpisywaniu tre¶ci wiadomo¶ci i czê¶ci nag³ówków
  (podpis w oddzielnym nag³ówku) oraz infrastrukturze DNS do dystrybucji kluczy
  publicznych. Powsta³ z po³±czenia Yahoo! DomainKeys i Cisco Identified Internet Mail.
  \item CSV - Certified Server Validation - uwierzytelnia tylko parametr
  polecenia HELO/EHLO.\newline
  Okre¶la poziom zaufania przy po³±czeniu nadchodz±cym z innego MTA na
  podstawie jego adresu IP oraz parametru polecenia HELO lub EHLO. Stosuje
  infrastrukturê DNS oraz rekordy SRV.
  \item Microsoft Sender ID - uwierzytelnia MAIL FROM oraz From.\newline
  Syntaktycznie zgodny z SPF. Rozszerza u¿ycie SPF do nag³ówków From:. Oparty
  na SPF oraz propozycji Microsoftu z 2004 r.: Caller ID for E-Mail.
\end{itemize}

W obecnej formie ka¿da z powy¿szych propozycji (prócz ma³o efektywnego i
praktycznie niestosowanego CSV) wprowadza powa¿ne ograniczenia w u¿ywaniu
poczty.

Wiêkszo¶æ wymusza stosowanie wybranych rozwi±zañ na administratorach
serwerów, które kontaktuj± siê z chronionym serwerem. ¯adna z nich nie
jest natomiast standardem, a implementacja zmian jest czêsto k³opotliwa
(np. nie ka¿dy MTA umo¿liwia stosowanie SRS). Skuteczno¶æ powy¿szych rozwi±zañ
jest zbyt niska w porównaniu z ograniczeniami, jakie wprowadzaj±. Redukuj± spam
i ataki wirusów w stopniu mniejszym, ni¿ inne rozwi±zania które nie maj± tak
powa¿nych efektów ubocznych (np. greylisting).

\subsubsection{Pipelining}

Wa¿nym rozszerzeniem protoko³u SMTP jest opisany w RFC 1854 tzw. pipelining.
Pipeling jest cech± komunikacji w ramach protoko³u polegaj±c± na wykonaniu
kilku ¿±dañ na raz, bez czekania na poszczególne odpowiedzi z serwera. 

\includegraphics[scale=0.6]{pipelining.png}

Serwer SMTP informuje klienta, ¿e obs³uguje rozszerzenie pipeliningu poprzez
zawarcie s³owa kluczowego PIPELINING w odpowiedzi na EHLO klienta. Klient, je¿eli
potrafi obs³ugiwaæ to rozszerzenie, mo¿e trasmitowaæ grupy komend bez
oczekiwania na rezultat ka¿dej z nich. Polecenia RSET, MAIL FROM, SEND FROM,
SOML FROM, SAML FROM i RCPT TO mog± wystêpowaæ dowolnie w grupie, za¶ EHLO, DATA,
VRFY, EXPN, TURN, QUIT oraz NOOP wystêpuj± jako ostatnie, poniewa¿ powodzenie
tych poleceñ lub b³±d w nich powoduj± zmianê stanu, na któr± reaguje klient.
Dodatkowe polecenia wprowadzone przez rozszerzenia protoko³u tak¿e wystêpuj±
jako ostatnie, chyba ¿e ich specyfikacje okre¶laj± dodatkowe mo¿liwo¶ci.

Klient, który implementuje pipelining musi sprawdziæ wszystkie statusy
odpowiedzi z serwera SMTP. Przyk³adowo je¿eli odpowiedzi± serwera na RCPT TO
bêdzie brak akceptacji dla adresu, klient musi sprawdziæ status odpowiedzi
DATA. Nie mo¿e on zak³adaæ, ¿e polecenie DATA nie zostanie zaakceptowane w
wyniku braku akceptacji polecenia RCPT TO. 

Przyk³adowa sesja z u¿yciem pipeliningu ma nastêpuj±c± postaæ:
\newline
\newline
S: <wait for open connection>\newline
C: <open connection to server>\newline
S: 220 innosoft.com SMTP service ready\newline
C: EHLO dbc.mtview.ca.us\newline
S: 250-innosoft.com\newline
S: 250 PIPELINING\newline
C: MAIL FROM:<mrose@dbc.mtview.ca.us>\newline
C: RCPT TO:<ned@innosoft.com>\newline
C: RCPT TO:<dan@innosoft.com>\newline
C: RCPT TO:<kvc@innosoft.com>\newline
C: DATA\newline
S: 250 sender <mrose@dbc.mtview.ca.us> OK\newline
S: 250 recipient <ned@innosoft.com> OK\newline
S: 250 recipient <dan@innosoft.com> OK\newline
S: 250 recipient <kvc@innosoft.com> OK\newline
S: 354 enter mail, end with line containing only "."\newline
...\newline
C: .\newline
C: QUIT\newline
S: 250 message sent\newline
S: 221 goodbye\newline

\subsubsection{Szyfrowanie}

Komuniakcja pomiêdzy klientem, a serwerem w protokole SMTP odbywa siê za pomoc±
komend przesy³anych otwartym tekstem. W wielu przypadkach wiadomo¶æ
transportowana jest przez wiele routerów i serwerów, co do których mo¿emy nie
mieæ zaufania. Mo¿e nast±piæ przechwycenie informacji, albo jej zmiana.

Próba rozwi±zania tego problemu doprowadzi³a do powstania mechanizmu TLS,
bardziej znany jako SSL, który rozszerza komunikacjê TCP o ochronê prywatno¶ci
i autentykacjê.

W celu obs³u¿enia TLS-u stworzono rozszerzenie do protoko³u SMTP i wprowadzono
dodatkowe polecenie STARTTLS. Odpowiedzi klienta na tê komendê mog± byæ
nastêpuj±ce:

\begin{itemize}
  \item 220 Ready to start TLS
  \item 501 Syntax Error (no parameters allowed) w przypadku gdy do
  bezparametrowego polecenia STARTTLS klint poda³ parametr
  \item 454 TLS not available due to temporary reason
\end{itemize}

W przypadku otrzymania odpowiedzi 220 klient powinien zacz±æ negocjacje TLS
przed wszystkimi innymi poleceniami. Po negocjacji TLS (szczegó³y dzia³ania
rozszerzenia TLS w wersji 1.0 zwarte jest w RFC 2246, obecnie rozwijana jest
wersja 1.1 opisana w RFC 4346) obie strony uzgadniaj± czy kontynuowaæ dalsz±
komunikacjê. W przypadku niepowodzenia autentykacji lub szyfrowania i tak mo¿e
nast±piæ do dalszej komunikacji klient-serwer i akceptacji przez serwer
wiadomo¶ci. Je¿eli serwer stwierdzi, ¿e wynegocjowany poziom zaufania jest zbyt
niski powinien przes³aæ klientowi komendê SMTP QUIT. 

Przyk³adowa sesja z uwzglêdnieniem negocjacji TLS mo¿e przyjmowaæ nastêpuj±c±
postaæ:
\newline
\newline
S: <waits for connection on TCP port 25>\newline
C: <opens connection>\newline
S: 220 mail.imc.org SMTP service ready\newline
C: EHLO mail.ietf.org\newline
S: 250-mail.imc.org offers a warm hug of welcome\newline
S: 250 STARTTLS\newline
C: STARTTLS\newline
S: 220 Go ahead\newline
C: <starts TLS negotiation>\newline
C \& S: <negotiate a TLS session>\newline
C \& S: <check result of negotiation>\newline
C: <continues by sending an SMTP command>\newline
. . .\newline
\newline

Nale¿y jednak zaznaczyæ, ¿e je¿eli komunikacja pomiêdzy klientem, a serwer by³a
przeprowadzona przy u¿yciu TLS-u, nie oznacza to, ¿e ca³y transport wiadomo¶ci
by³ szyfrowany. Po drodze niestety mo¿e doj¶æ do nieszyfrowanego lub
nieautoryzowanego przekazywania wiadomo¶ci.

\newpage

\section{Dzisiejsze narzêdzia do filtracji protoko³u SMTP}

\subsection{Konieczno¶æ wprowadzenia filtracji}

Co¶ o spamie ilo¶ci spamu procentowo konieczno¶ci zarz±dzaniem mailami w
firmach itd. itp.

\subsection{Produkty komercyjne}

Obecnie na rynku znajduje siê sporo produktów s³u¿±cych do filtracji w ramach
protoko³u SMTP. Niektóre z nich s± czê¶ci± wiêkszych projektów, inne zosta³y
zaprojektowane tylko w tym celu.

\subsubsection{Clearswift - MIME sweeper for SMTP}

MIMEsweeper for SMTP e-mail software to bardzo wyrafinowany system do
zarz±dzania poczt± email. Wed³ug twórców systemu ¿aden inny system nie oferuje
tak obszernych mo¿liwo¶ci kompleksowego zarz±dzania infrastruktur± maili.
Dziêki rozwojowi przez ponad 20 lat systemów do zarz±dzania e-mailami,
obecny produkt firmy Clearswift sta³ siê idealnym rozwi±zaniem dla firm, które
pragn± w pe³ni ochroniæ komunikacjê e-mail.

Firma Clearswift zajmuje siê sektorem zabezpieczeñ komunikacyji i dostarcza
filtry emailowe i webowe dla oko³o 25 milionów u¿ytkowników skupionych wokó³ 17
tysiêcy firm. Zosta³a za³o¿ona w roku 1982, a jej obecna siedziba mie¶ci siê w
Theale, niedaleko Reading w Wielkiej Brytani.

Dwie najwa¿niejsze funkcjonalno¶ci jakie dostarcza MIMEsweeper for SMTP to:
\begin{itemize}
  \item Routowanie i relayowanie wiadomo¶ci w ramach SMTP w zale¿no¶ci od
  zdefiniowanych zasad
  \item Procesowanie wiadomo¶ci w ramach domeny w oparciu o zdefiniowane zasady
  bezpieczeñstwa
\end{itemize}

W ramach polityki bezpieczeñstwa firmy MIMEsweeper umo¿liwia skonfigurowanie
wielu zasad bezpieczeñstwa, które zosta³y podzielone na 3 g³ówne typy:
\begin{enumerate}
  \item Polityka deploymentu - okre¶la ona sposób implementacji MIMEsweepera w
  danej sieci. Zale¿na jest ona od:
  \begin{itemize}
    \item architektury sieci w ramach okre¶lonej domeny
    \item sposobu pod³±czenia sieci do Internetu
    \item ilo¶ci osób zarz±dzaj±cych polityk± bezpieczeñstwa i samym systemem
    \item elastyczno¶ci systemu
  \end{itemize}
  \item Polityka routowania i relayowania poczty. Mo¿na tutaj okre¶liæ:
  \begin{itemize}
  	\item z jakich hostów bêdziemy akceptowaæ maile
  	\item jakie hosty mog± ³±czyæ siê do naszego serwera i u¿ywaæ go do
  	relayowania poczty
  	\item z jakich hostów albo adresów poczty nie przyjmujemy
  	\item dozwolon± ilo¶æ odbiorców
  	\item dozwolon± wielko¶æ wiadomo¶ci email
  	\item ilo¶æ wiadomo¶ci email jakie MIMEsweeper mo¿e jednocze¶nie przetwarzaæ
  \end{itemize}
  \item Polityka ochrony zawarto¶ci. Okre¶la ona regu³y przetwarzania przez
  system maili takie jak:
  \begin{itemize}
    \item kto mo¿e wysy³aæ i odbieraæ maile
    \item dok±d maile mog± byæ wysy³ana albo sk±d odbierane
    \item jaki rodzaj wiadomo¶ci wykryæ
    \item jaki rodzaj tekstu i jakie obiekty analizowaæ w wykrytych
    wiadomo¶ciach
    \item jaki rodzaj akcji podj±æ po analizie
    \item co zg³osiæ po wykryciu maila
    \item jakie informacje o systemie ¶ledziæ
    \item jakie przetwarzane wiadomo¶ci ¶ledziæ
    \item jak± analizê zawarto¶ci i jej wykrycie ¶ledziæ
  \end{itemize}
\end{enumerate}

Ca³o¶æ oprogramowania MIMEsweeper podzielona jest na serwisy, które umo¿liwiaj±
realizacjê wcze¶niej wymienionych zadañ. Serwisy te to:

\begin{itemize}
  \item serwis odbieraj±cy - zgodnie z ustalonymi zasadami polityki
  bezpieczeñstwa waliduje przychodz±ce po³±czenie, odbiera maila i przekazuje
  do serwisu zabezpieczeñ do dalszego procesowania
  \item serwis zabezpieczeñ - sprawdza zawarto¶æ maila i konfrontuje go z
  skonfigurowan± wcze¶niej polityk± bezpieczeñstwa
  \item serwis dostarczaj±cy - przekazuje pocztê do odbiorców
  \item serwis odpowiedzialny za infrastrukturê - zajmuje siê monitorowaniem
  systemu, konfiguracj± i kontrol± zadañ nie objêtych przez inne serwisy
  \item serwis analityczny - z³o¿onych z dwóch odrêbnych serwis. Pierwszy z
  nich zbiera dane o systemie i przekazuje je do drugiego serwisu
  odpowiedzialnego za stworzenie z nich bazy danych w odpowiedniej postaci
  \item system ¶ledzenia - odpowiedzialny za zbieranie wszystkich danych,
  których wcze¶niej zosta³y zdefiniowane w systmie do ¶ledzenia
\end{itemize}

\includegraphics[scale=0.6]{mimesweeper_services.png}

\subsubsection{Aladdin eSafe}

Aladdin eSafe

\subsubsection{Surfcontrol Email Filter}

Suontrol Email Filter

\subsection{Produkty open-source}

\newpage

\section{Opracowany filtr poczty SMTP}

\subsection{Za³o¿enia projektu}

\subsection{Modu³y projektu}

\subsubsection{Parser wiadomo¶ci}

\subsubsection{Parser regu³}

\subsubsection{Analizator wiadomo¶ci}

\subsubsection{Kolejka}

\subsection{Kompilacja, konfiguracja i uruchomienie projektu}

\subsection{Testy wydajno¶ciowe}

\newpage

\section{Spostrze¿enia, wnioski}

\newpage

